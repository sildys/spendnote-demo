<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SpendNote – Letter Two Receipts (Fixed)</title>

<style>
@page { size: letter; margin: 0; }
html, body {
  margin: 0;
  padding: 0;
  width: 215.9mm;
  height: 279.4mm;
}
body {
  font-family: Arial, Helvetica, sans-serif;
  color: #111;
  background: #ffffff;
}

/* PAGE */
.page {
  width: 215.9mm;
  height: 279.4mm;
}

/* RECEIPT */
.receipt {
  width: 215.9mm;
  height: calc((279.4mm - 6mm) / 2);
  box-sizing: border-box;
  padding: 6mm 12mm;
  clear: both;              /* <<< CRITICAL FIX */
  --logo-w: 36mm;
  --logo-scale: 1;
  --logo-gap: 4mm;
  position: relative;
}

/* VOID WATERMARK */
.void-watermark {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) rotate(-18deg);
  font-size: 74pt;
  font-weight: 900;
  letter-spacing: 2pt;
  color: rgba(120, 120, 120, 0.16);
  text-transform: uppercase;
  pointer-events: none;
  user-select: none;
  z-index: 2;
  display: none;
}

/* TOP BAR (Title + Meta left, Logo right) */
.topbar{
  min-height: 18.5mm;
  display: grid;
  grid-template-columns: 1fr var(--logo-w);
  column-gap: 4mm;
  align-items: start;
}
.topbar .title{
  font-size: 17pt;
  font-weight: 700;
  line-height: 1.05;
}
.topbar .meta{
  font-size: 8.5pt;
  margin-top: 2.2mm;
  line-height: 1.2;
}

.logo-box{
  width: var(--logo-w);
  height: 18.5mm;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.logo-img{
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
}


/* HEADER RULE (should reach IDs, not the logo) */
.header-rule{
  margin-top: 2.2mm;
  border-top: 0.5mm solid #000;
  width: calc(100% - var(--logo-w) - var(--logo-gap));
}
/* Full width header-rule when logo is hidden */
.header-rule.full-width{
  width: 100%;
}
/* PARTIES */
.parties {
  height: 26mm;
  margin-top: 1.5mm;
}
.party {
  width: 48%;
  display: inline-block;
  vertical-align: top;
  font-size: 8.5pt;
  line-height: 1.15;
}
.party strong {
  display: block;
  font-size: 9.5pt;
  margin-bottom: 0.6mm;
}
.party.right {
  float: right;
}
.party-id {
  font-size: 7.5pt;
  color: #111;
  margin-top: 0.8mm;
}

/* ITEMS */
.items {
  height: 26mm;
  margin-top: 0mm;
  font-size: 8.5pt;
}
.items table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
.items th {
  padding: 0.35mm 1mm;
  border-bottom: 0.25mm solid #ccc;
  font-weight: 600;
  line-height: 1;
}
.items td {
  padding: 0.6mm 1mm;
  border-bottom: 0.25mm solid #ccc;
  line-height: 1.1;
}
.items th.amount,
.items th.amount-header,
.items td.amount {
  width: 32mm;
  text-align: right;
}

/* TOTAL */
.total {
  height: 10mm;
  margin-top: 2mm;
  border-top: 0.5mm solid #000;
  font-size: 11.5pt;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* NOTES */
.notes {
  height: 11mm;
  margin-top: 2mm;
  font-size: 8.5pt;
  line-height: 1.2;
  overflow: hidden;
}
.notes strong {
  display: block;
  margin-bottom: 0.6mm;
}

/* SIGNATURES */
.signatures {
  height: 15.5mm;
  margin-top: 4mm;
}
.signature {
  width: 48%;
  display: inline-block;
  vertical-align: bottom;
  font-size: 8.5pt;
}
.signature.right {
  float: right;
}
.signature .line {
  border-top: 0.25mm solid #000;
  margin-top: 10mm;
}

/* FOOTER */
.footer {
  height: 4mm;
  font-size: 7pt;
  color: #555;
  text-align: center;
  margin-top: 6mm;
}

/* CUT BAND */
.cut-band {
  height: 6mm;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  font-size: 7.5pt;
  color: #666;
  clear: both;
}
.cut-band:before {
  content: "";
  position: absolute;
  left: 8mm;
  right: 8mm;
  top: 50%;
  border-top: 0.25mm dashed #999;
  z-index: 0;
}
.cut-band span {
  background: #fff;
  padding: 0 2mm;
  position: relative;
  z-index: 1;
}

.sn-logo{
  display:inline-flex;
  align-items:center;
  margin-right:4px;
  vertical-align:middle;
}


.sn-logo{
  display:inline-flex;
  align-items:center;
  margin-right:4px;
  vertical-align:middle;
}
.sn-logo img{
  height:12px;
  width:auto;
  opacity:0.75;
}


.sn-logo{
  display:inline-flex;
  align-items:center;
  margin-right:4px;
  vertical-align:middle;
}
.sn-logo-svg{
  height:12px;
  width:auto;
  fill:#9c9c9c;
}


.sn-logo{
  display:inline-flex;
  align-items:center;
  margin-right:4px;
  vertical-align:middle;
}
.sn-logo svg{
  height:12px;
  width:auto;
  fill:#9c9c9c;
}


/* v12 header layout: identifiers + logo on the right, single row */
.topbar{
  display:grid;
  grid-template-columns: 1fr max-content;
  column-gap: 6mm;
  align-items:start;
}
.right-block{
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
  gap: 4mm;
}
.identifiers{
  text-align:right;
  font-size:7.6pt;
  line-height:1.2;
  margin-top:0.5mm;
  white-space:nowrap;
}
.identifiers .register-id,
.identifiers .receipt-id{
  white-space:nowrap;
}


/* v12 layout guard: never stretch content vertically */
.receipt{
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}


/* OVERRIDES v24: move header rule up (closer to meta) and give more air before FROM */
.header-rule{
  margin-top: 0.8mm !important;
}
.parties{
  margin-top: 3.8mm !important;
}

</style></head>

<body>
<div class="page">

  <!-- RECEIPT A -->
  <div class="receipt">
    <div class="void-watermark" aria-hidden="true">VOID</div>
    <div class="topbar">
  <div>
    <div class="title">Cash Receipt</div>
    <div class="meta">Date: —</div>
  </div>
  <div class="right-block">
    <div class="identifiers">
      <div class="register-id">Cash Box ID: —</div>
      <div class="receipt-id-line">Receipt ID: —</div>
    </div>
    <div class="logo-box">Company logo</div>
  </div>
</div>

    <div class="header-rule"></div>

    <div class="parties">
      <div class="party">
        <strong>FROM</strong>
        <span class="company-name">—</span><br>
        <span class="company-address"></span><br>
        <span class="party-id company-id"></span>
      </div>
      <div class="party right">
        <strong>TO</strong>
        <span class="contact-name">—</span><br>
        <span class="contact-address"></span><br>
        <span class="party-id contact-id"></span>
      </div>
    </div>

    <div class="items">
      <table>
        <thead>
          <tr><th class="description-header">Description</th><th class="amount-header">Amount</th></tr>
        </thead>
        <tbody>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
          <tr><td>&nbsp;</td><td></td></tr>
          <tr><td>&nbsp;</td><td></td></tr>
          <tr><td>&nbsp;</td><td></td></tr>
        </tbody>
      </table>
    </div>

    <div class="total"><span>Total handed over</span><span>—</span></div>

    <div class="notes" style="display: none;"><strong>Notes</strong></div>

    <div class="signatures">
      <div class="signature">Issued by<div class="line"></div></div>
      <div class="signature right">Received by<div class="line"></div></div>
    </div>

    <div class="custom-footer-note" style="display: none; text-align: center; font-size: 7pt; color: #666; margin-top: 4mm; margin-bottom: 2mm; font-style: italic;"></div>
    <div class="footer">
      Generated by <span class="sn-logo" aria-hidden="true"><svg width="512" height="512" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
    <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#logo-gradient-gray)"/>
    <path d="M32 4 L38 10 L32 10 Z" fill="#000000" opacity="0.15"/>
    <path d="M32 4 L32 10 L38 10" stroke="#404040" stroke-width="1.5" stroke-linejoin="round"/>
    <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
    <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
    <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
    <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
    <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#404040" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <defs>
        <linearGradient id="logo-gradient-gray" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#737373"/>
            <stop offset="100%" stop-color="#a3a3a3"/>
        </linearGradient>
    </defs>
</svg></span>SpendNote • Proof of cash handoff. Not a tax document.
    </div>
  </div>

  <!-- CUT -->
  <div class="cut-band"><span>CUT HERE</span></div>

  <!-- RECEIPT B -->
  <div class="receipt">
    <div class="void-watermark" aria-hidden="true">VOID</div>
    <!-- identical copy -->
    <div class="topbar">
  <div>
    <div class="title">Cash Receipt</div>
    <div class="meta">Date: —</div>
  </div>
  <div class="right-block">
    <div class="identifiers">
      <div class="register-id">Cash Box ID: —</div>
      <div class="receipt-id-line">Receipt ID: —</div>
    </div>
    <div class="logo-box">Company logo</div>
  </div>
</div>

    <div class="header-rule"></div>

    <div class="parties">
      <div class="party">
        <strong>FROM</strong>
        <span class="company-name">—</span><br>
        <span class="company-address"></span><br>
        <span class="party-id company-id"></span>
      </div>
      <div class="party right">
        <strong>TO</strong>
        <span class="contact-name">—</span><br>
        <span class="contact-address"></span><br>
        <span class="party-id contact-id"></span>
      </div>
    </div>

    <div class="items">
      <table>
        <thead>
          <tr><th class="description-header">Description</th><th class="amount-header">Amount</th></tr>
        </thead>
        <tbody>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
          <tr><td>&nbsp;</td><td></td></tr>
          <tr><td>&nbsp;</td><td></td></tr>
          <tr><td>&nbsp;</td><td></td></tr>
        </tbody>
      </table>
    </div>

    <div class="total"><span>Total handed over</span><span>—</span></div>

    <div class="notes" style="display: none;"><strong>Notes</strong></div>

    <div class="signatures">
      <div class="signature">Issued by<div class="line"></div></div>
      <div class="signature right">Received by<div class="line"></div></div>
    </div>

    <div class="custom-footer-note" style="display: none; text-align: center; font-size: 7pt; color: #666; margin-top: 4mm; margin-bottom: 2mm; font-style: italic;"></div>
    <div class="footer">
      Generated by <span class="sn-logo" aria-hidden="true"><svg width="512" height="512" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
    <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#logo-gradient-gray)"/>
    <path d="M32 4 L38 10 L32 10 Z" fill="#000000" opacity="0.15"/>
    <path d="M32 4 L32 10 L38 10" stroke="#404040" stroke-width="1.5" stroke-linejoin="round"/>
    <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
    <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
    <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
    <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
    <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#404040" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <defs>
        <linearGradient id="logo-gradient-gray" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#737373"/>
            <stop offset="100%" stop-color="#a3a3a3"/>
        </linearGradient>
    </defs>
</svg></span>SpendNote • Proof of cash handoff. Not a tax document.
    </div>
  </div>

</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const itemsMode = String(urlParams.get('itemsMode') || '').toLowerCase();
  const isItemsSingle = itemsMode === 'single';
  const initialVoid = urlParams.get('void') === '1';
  window.__spendnoteReceiptVoid = initialVoid;

  try {
    const wm = document.getElementById('disclaimerWatermark');
    if (wm) {
      const text = 'Proof of cash handoff. Not a tax document.';
      const cols = 3;
      const rows = 7;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const el = document.createElement('span');
          el.textContent = text;
          el.style.left = `${c * 36 - 10}%`;
          el.style.top = `${r * 16 - 10}%`;
          el.style.transform = 'rotate(-22deg)';
          wm.appendChild(el);
        }
      }
    }
  } catch (_) {
    // ignore
  }

  if (initialVoid) {
    document.querySelectorAll('.void-watermark').forEach((el) => (el.style.display = 'block'));
  }
  const resolveLogoUrl = () => {
    const logoKey = urlParams.get('logoKey');
    const logoUrl = urlParams.get('logoUrl');
    if (logoUrl) return logoUrl;
    try {
      if (logoKey) {
        const fromKey = localStorage.getItem(logoKey) || '';
        if (fromKey) return fromKey;
      }
      return localStorage.getItem('spendnote.proLogoDataUrl')
        || localStorage.getItem('spendnote.receipt.logo.v1')
        || '';
    } catch (_) {
      return '';
    }
  };
  
  // Custom text replacements
  const receiptTitle = urlParams.get('receiptTitle');
  const totalLabel = urlParams.get('totalLabel');
  const fromLabel = urlParams.get('fromLabel');
  const toLabel = urlParams.get('toLabel');
  const descriptionLabel = urlParams.get('descriptionLabel');
  const amountLabel = urlParams.get('amountLabel');
  const notesLabel = urlParams.get('notesLabel');
  const issuedByLabel = urlParams.get('issuedByLabel');
  const receivedByLabel = urlParams.get('receivedByLabel');
  const footerNote = urlParams.get('footerNote');
  
  if (receiptTitle) {
    document.querySelectorAll('.title').forEach(el => el.textContent = receiptTitle);
  }
  if (totalLabel) {
    document.querySelectorAll('.total span:first-child').forEach(el => el.textContent = totalLabel);
  }
  if (fromLabel) {
    document.querySelectorAll('.party strong').forEach((el, index) => {
      if (index === 0 || index === 2) el.textContent = fromLabel;
    });
  }
  if (toLabel) {
    document.querySelectorAll('.party strong').forEach((el, index) => {
      if (index === 1 || index === 3) el.textContent = toLabel;
    });
  }
  if (descriptionLabel) {
    document.querySelectorAll('.description-header').forEach(el => el.textContent = descriptionLabel);
  }
  if (amountLabel) {
    document.querySelectorAll('.amount-header').forEach(el => el.textContent = amountLabel);
  }
  if (notesLabel) {
    document.querySelectorAll('.notes strong').forEach(el => el.textContent = notesLabel);
  }
  if (issuedByLabel) {
    document.querySelectorAll('.signature').forEach((el, index) => {
      if (index === 0 || index === 2) el.childNodes[0].textContent = issuedByLabel;
    });
  }
  if (receivedByLabel) {
    document.querySelectorAll('.signature').forEach((el, index) => {
      if (index === 1 || index === 3) el.childNodes[0].textContent = receivedByLabel;
    });
  }
  if (footerNote) {
    const footerNoteEls = document.querySelectorAll('.custom-footer-note');
    footerNoteEls.forEach(el => {
      el.textContent = footerNote;
      el.style.display = 'block';
    });
  }

  const txIdParamRaw = urlParams.get('txId');
  const isUuidParam = (value) => {
    try {
      if (window.SpendNoteIds && typeof window.SpendNoteIds.isUuid === 'function') {
        return window.SpendNoteIds.isUuid(value);
      }
    } catch (_) {}
    return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(value || '').trim());
  };
  const txIdParam = (txIdParamRaw && isUuidParam(txIdParamRaw)) ? String(txIdParamRaw).trim() : '';
  const isDemo = urlParams.get('demo') === '1' && !txIdParam;
  if (isDemo) {
    const safeText = (value, fallback) => {
      const v = value === undefined || value === null ? '' : String(value);
      return v.trim() ? v : (fallback || '');
    };

    const setTextAll = (selector, text) => {
      document.querySelectorAll(selector).forEach((el) => {
        el.textContent = text;
      });
    };

    const setHtmlAll = (selector, html) => {
      document.querySelectorAll(selector).forEach((el) => {
        el.innerHTML = html;
      });
    };

    const demoCompany = safeText(urlParams.get('demoCompany'), 'Acme Corporation');
    const demoAddress = safeText(urlParams.get('demoAddress'), '123 Main St\nSpringfield, IL 62701');
    const demoCompanyId = safeText(urlParams.get('demoCompanyId'), '');

    const demoContact = safeText(urlParams.get('demoContact'), 'John Doe');
    const demoContactAddress = safeText(urlParams.get('demoContactAddress'), '456 Oak Ave\nSpringfield, IL 62704');
    const demoContactId = safeText(urlParams.get('demoContactId'), '');

    const demoDate = safeText(urlParams.get('demoDate'), 'Jan 15, 2026');
    const demoCashBoxId = safeText(urlParams.get('demoCashBoxId'), 'SN-001');
    const demoReceiptId = safeText(urlParams.get('demoReceiptId'), 'SN1-042');
    const demoCreatedBy = safeText(urlParams.get('demoCreatedBy'), 'Alex Johnson');

    const demoCurrency = safeText(urlParams.get('demoCurrency'), 'USD');
    const demoAmount = Number(urlParams.get('demoAmount'));
    const demoNote = safeText(urlParams.get('demoNote'), '');

    const formatMoney = (amount, currency) => {
      const n = Number(amount);
      const v = Number.isFinite(n) ? n : 0;
      try {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD' }).format(v);
      } catch (_) {
        return `$${v.toFixed(2)}`;
      }
    };

    setTextAll('.company-name', demoCompany);
    setTextAll('.contact-name', demoContact);

    const addressToHtml = (raw) => {
      const value = safeText(raw, '');
      if (!value) return '';
      if (value.includes('|')) {
        const idx = value.indexOf('|');
        const first = safeText(value.slice(0, idx), '').trim();
        const rest = safeText(value.slice(idx + 1), '').trim();
        return rest ? `${first}<br>${rest}` : first;
      }
      if (value.includes('\n')) {
        return value
          .split(/\r?\n/)
          .map((l) => safeText(l, ''))
          .filter(Boolean)
          .slice(0, 2)
          .join('<br>');
      }
      const idx = value.indexOf(',');
      if (idx === -1) return value;
      const first = safeText(value.slice(0, idx), '');
      const rest = safeText(value.slice(idx + 1), '');
      return rest ? `${first}<br>${rest}` : first;
    };

    const companyAddressHtml = addressToHtml(demoAddress);
    const contactAddressHtml = addressToHtml(demoContactAddress);

    setHtmlAll('.company-address', companyAddressHtml);
    setHtmlAll('.contact-address', contactAddressHtml);
    document.querySelectorAll('.company-address, .contact-address').forEach((el) => (el.style.display = ''));

    if (demoCompanyId) {
      setTextAll('.company-id', demoCompanyId);
      document.querySelectorAll('.company-id').forEach((el) => (el.style.display = ''));
    }
    if (demoContactId) {
      setTextAll('.contact-id', demoContactId);
      document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = ''));
    }

    setTextAll('.meta', `Date: ${demoDate}`);
    setTextAll('.register-id', `Cash Box ID: ${demoCashBoxId}`);
    setTextAll('.receipt-id-line', `Receipt ID: ${demoReceiptId}`);
    if (demoCreatedBy) {
      setTextAll('.created-by', demoCreatedBy);
    }

    const rawItems = safeText(urlParams.get('demoItems'), '');
    const items = rawItems
      .split(';')
      .map((chunk) => chunk.trim())
      .filter(Boolean)
      .map((chunk) => {
        const [desc, amt] = chunk.split('|');
        return {
          description: safeText(desc, ''),
          amount: Number(amt)
        };
      })
      .filter((it) => it.description || Number.isFinite(it.amount));

    const totalValue = Number.isFinite(demoAmount)
      ? demoAmount
      : items.reduce((sum, it) => sum + (Number.isFinite(it.amount) ? it.amount : 0), 0);

    const rowsSource = (() => {
      const fallback = items.length ? items : [{ description: '—', amount: totalValue }];
      if (!isItemsSingle) return fallback;
      const firstDesc = safeText(fallback[0]?.description, '—');
      return [{ description: firstDesc, amount: totalValue }];
    })();

    const rows = rowsSource.map((it) => {
      const amount = Number.isFinite(Number(it.amount)) ? formatMoney(Number(it.amount), demoCurrency) : '';
      return `<tr><td>${safeText(it.description, '&nbsp;')}</td><td class="amount">${amount}</td></tr>`;
    });

    while (rows.length < 4) {
      rows.push('<tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>');
    }

    document.querySelectorAll('.items tbody').forEach((tbody) => {
      tbody.innerHTML = rows.join('');
    });

    document.querySelectorAll('.total').forEach((el) => {
      const spans = el.querySelectorAll('span');
      if (spans.length >= 2) spans[1].textContent = formatMoney(totalValue, demoCurrency);
    });

    document.querySelectorAll('.notes').forEach((el) => {
      if (!demoNote) {
        el.style.display = 'none';
        return;
      }
      const strong = el.querySelector('strong');
      if (!strong) return;
      el.innerHTML = '';
      el.appendChild(strong);
      el.appendChild(document.createTextNode(demoNote));
      el.style.display = '';
    });
  }
  
  // Logo
  if (urlParams.get('logo') === '0') {
    document.querySelectorAll('.logo, .logo-box, .logo-img, .sn-logo').forEach(el => el.style.display = 'none');
    // Make header-rule full width when logo is hidden
    document.querySelectorAll('.header-rule').forEach(el => el.classList.add('full-width'));
  } else {
    const logo = resolveLogoUrl();
    if (logo) {
      document.querySelectorAll('.logo-box').forEach((box) => {
        box.textContent = '';
        const img = document.createElement('img');
        img.className = 'logo-img';
        img.alt = 'Company logo';
        img.src = logo;
        box.appendChild(img);
      });
    }

    // Apply logo scale from URL param or localStorage
    try {
      let scaleRaw = urlParams.get('logoScale');
      if (!scaleRaw) {
        try { scaleRaw = localStorage.getItem('spendnote.receipt.logoScale.v1'); } catch (_) {}
      }
      const s = parseFloat(scaleRaw || '1');
      if (Number.isFinite(s) && s >= 0.5 && s <= 3.0) {
        document.querySelectorAll('.receipt').forEach(r => r.style.setProperty('--logo-scale', String(s)));
      }
    } catch (_) {}
  }
  
  // Addresses (FROM and TO addresses, but keep names visible)
  if (urlParams.get('addresses') === '0') {
    document.querySelectorAll('.from-address, .to-address, .party-address, .company-address, .contact-address').forEach(el => el.style.display = 'none');
  }
  
  // Tracking Details (Receipt ID, Cash Box ID)
  if (urlParams.get('tracking') === '0') {
    document.querySelectorAll('.identifiers, .receipt-ids, .register-id, .receipt-id').forEach(el => el.style.display = 'none');
  }
  
  // Additional Info (two custom info lines)
  if (urlParams.get('additional') === '0') {
    document.querySelectorAll('.additional-info, .custom-info, .extra-info, .company-id, .contact-id').forEach(el => el.style.display = 'none');
  }
  
  // Note
  if (urlParams.get('note') === '0') {
    document.querySelectorAll('.notes').forEach(el => el.style.display = 'none');
  }
  
  // Signatures
  if (urlParams.get('signatures') === '0') {
    document.querySelectorAll('.signatures').forEach(el => el.style.display = 'none');
  }
</script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260211-2016"></script>
    <script src="assets/js/auth-guard.js?v=20260207-2310"></script>
    <script src="assets/js/main.js?v=20260207-2235"></script>

    <script>
      (async function () {
        const txId = (typeof txIdParam === 'string') ? txIdParam : '';
        if (!txId) return;

        const overrideContactAddress = String(new URLSearchParams(window.location.search).get('overrideContactAddress') || '').trim();

        const waitForDb = async () => {
          // Wait for db AND authenticated session
          for (let i = 0; i < 200; i++) {
            if (window.db?.transactions?.getById) {
              // Also verify we have an auth session
              try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (session) {
                  return true;
                }
              } catch (e) {
                // ignore
              }
            }
            await new Promise((r) => setTimeout(r, 50));
          }
          return false;
        };

        function safeText(value, fallback) {
          const v = value === undefined || value === null ? '' : String(value);
          return v.trim() ? v : (fallback || '');
        }

        function getDisplayId(tx) {
          const cbSeq = tx?.cash_box_sequence;
          const txSeq = tx?.tx_sequence_in_box;
          if (cbSeq && txSeq) {
            const txSeqStr = String(txSeq).padStart(3, '0');
            return `SN${cbSeq}-${txSeqStr}`;
          }
          const receipt = safeText(tx?.receipt_number, '');
          if (receipt) return receipt;
          return '';
        }

        function getCashBoxCode(tx) {
          const cbSeq = Number(tx?.cash_box?.sequence_number || tx?.cash_box_sequence);
          if (Number.isFinite(cbSeq) && cbSeq > 0) {
            return `SN-${String(cbSeq).padStart(3, '0')}`;
          }
          return '';
        }

        function formatDateShort(value) {
          const dt = value ? new Date(value) : null;
          if (!dt || Number.isNaN(dt.getTime())) return '';
          return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function setTextAll(selector, text) {
          document.querySelectorAll(selector).forEach((el) => {
            el.textContent = text;
          });
        }

        function setHtmlAll(selector, html) {
          document.querySelectorAll(selector).forEach((el) => {
            el.innerHTML = html;
          });
        }

        function addressToHtml(raw) {
          const value = safeText(raw, '');
          if (!value) return '';
          if (value.includes('|')) {
            const idx = value.indexOf('|');
            const first = safeText(value.slice(0, idx), '').trim();
            const rest = safeText(value.slice(idx + 1), '').trim();
            return rest ? `${first}<br>${rest}` : first;
          }
          if (value.includes('\n')) {
            return value
              .split(/\r?\n/)
              .map((l) => safeText(l, ''))
              .filter(Boolean)
              .slice(0, 2)
              .join('<br>');
          }
          const idx = value.indexOf(',');
          if (idx === -1) return value;
          const first = safeText(value.slice(0, idx), '');
          const rest = safeText(value.slice(idx + 1), '');
          return rest ? `${first}<br>${rest}` : first;
        }

        // Immediately clear demo placeholders so they never show up in the preview
        setTextAll('.company-name', '—');
        setTextAll('.contact-name', '—');
        setHtmlAll('.company-address', '');
        setHtmlAll('.contact-address', '');
        document.querySelectorAll('.company-address, .contact-address').forEach((el) => (el.style.display = 'none'));
        setTextAll('.company-id', '');
        document.querySelectorAll('.company-id').forEach((el) => (el.style.display = 'none'));

        setTextAll('.contact-id', '');
        document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = 'none'));
        setTextAll('.register-id', 'Cash Box ID: —');
        setTextAll('.receipt-id-line', 'Receipt ID: —');
        setHtmlAll('.meta', `Date: —`);
        document.querySelectorAll('.items tbody').forEach((tbody) => {
          tbody.innerHTML = '<tr><td>&nbsp;</td><td></td></tr>'.repeat(4);
        });
        document.querySelectorAll('.total').forEach((el) => {
          const spans = el.querySelectorAll('span');
          if (spans.length >= 2) spans[1].textContent = '—';
        });

        document.querySelectorAll('.notes').forEach((el) => (el.style.display = 'none'));

        function setTextFirstLine(selector, text) {
          document.querySelectorAll(selector).forEach((el) => {
            el.textContent = text;
          });
        }

        function formatMoney(amount, currency) {
          const sn = (typeof window !== 'undefined' && window.SpendNote) ? window.SpendNote : null;
          if (sn && typeof sn.formatCurrency === 'function') {
            return sn.formatCurrency(amount, currency);
          }
          try {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD' }).format(Number(amount) || 0);
          } catch (_) {
            return `$${(Number(amount) || 0).toFixed(2)}`;
          }
        }

        function renderA4Items(tx, currency) {
          const raw = Array.isArray(tx?.line_items) ? tx.line_items : [];
          const items = raw
            .map((it) => ({
              description: safeText(it?.description, ''),
              amount: Number(it?.amount)
            }))
            .filter((it) => it.description || Number.isFinite(it.amount));

          const fallbackDesc = safeText(tx?.description, '—');
          const fallbackAmt = Number(tx?.amount);

          const effective = isItemsSingle
            ? [{ description: fallbackDesc, amount: fallbackAmt }]
            : (items.length ? items : [{ description: fallbackDesc, amount: fallbackAmt }]);

          const rowsSource = isItemsSingle ? effective.slice(0, 1) : effective;
          const rows = rowsSource.map((it) => {
            const desc = safeText(it.description, '—');
            const amt = formatMoney(it.amount, currency);
            return `<tr><td>${desc}</td><td class="amount">${amt}</td></tr>`;
          });
          while (rows.length < 4) {
            rows.push('<tr><td>&nbsp;</td><td></td></tr>');
          }

          document.querySelectorAll('.items tbody').forEach((tbody) => {
            tbody.innerHTML = rows.join('');
          });

          const total = Number.isFinite(Number(tx?.amount)) ? Number(tx.amount) : 0;
          const totalText = formatMoney(total, currency);
          document.querySelectorAll('.total').forEach((el) => {
            const spans = el.querySelectorAll('span');
            if (spans.length >= 2) spans[1].textContent = totalText;
          });
        }

        try {
          const ok = await waitForDb();
          if (!ok) return;

          const tx = await window.db.transactions.getById(txId);
          if (!tx) return;

          const shouldShowVoid = Boolean(window.__spendnoteReceiptVoid) || String(tx?.status || 'active').toLowerCase() === 'voided';
          document.querySelectorAll('.void-watermark').forEach((el) => (el.style.display = shouldShowVoid ? 'block' : 'none'));

          try {
            if (( !tx.cash_box || tx.cash_box?.sequence_number === undefined || tx.cash_box?.sequence_number === null) && tx.cash_box_id && window.db?.cashBoxes?.getById) {
              tx.cash_box = await window.db.cashBoxes.getById(tx.cash_box_id);
            }
          } catch (_) {}

          try {
            const hasContactAddress = Boolean(overrideContactAddress || String(tx?.contact_address || tx?.contact?.address || '').trim());
            if (!hasContactAddress && tx.contact_id && window.db?.contacts?.getById) {
              tx.contact = await window.db.contacts.getById(tx.contact_id);
            }
          } catch (_) {}

          let profile = null;
          try {
            profile = window.db?.profiles?.getCurrent ? await window.db.profiles.getCurrent() : null;
          } catch (_) {
            profile = null;
          }

          const displayId = getDisplayId(tx);
          const cashBoxCode = getCashBoxCode(tx);
          const txDate = tx.transaction_date || tx.created_at;
          const contactName = safeText(tx.contact_name || tx.contact?.name, '');
          const contactAddress = overrideContactAddress || safeText(tx.contact_address || tx.contact?.address, '');
          const contactOtherId = safeText(tx.contact_custom_field_1, '');

          const currency = safeText(tx.cash_box?.currency, 'USD');

          const companyName = safeText(profile?.company_name || profile?.full_name || tx.cash_box?.name, '—');
          const companyAddress = safeText(profile?.address, '');

          setTextAll('.company-name', companyName);
          if (companyAddress) {
            setHtmlAll('.company-address', addressToHtml(companyAddress));
            document.querySelectorAll('.company-address').forEach((el) => (el.style.display = ''));
          } else {
            setHtmlAll('.company-address', '');
            document.querySelectorAll('.company-address').forEach((el) => (el.style.display = 'none'));
          }

          renderA4Items(tx, currency);

          const notes = safeText(tx.notes, '');
          document.querySelectorAll('.notes').forEach((el) => {
            if (!notes) {
              el.style.display = 'none';
              return;
            }
            const strong = el.querySelector('strong');
            if (!strong) return;
            el.innerHTML = '';
            el.appendChild(strong);
            el.appendChild(document.createTextNode(notes));
            el.style.display = '';
          });

          setTextAll('.register-id', `Cash Box ID: ${cashBoxCode || '—'}`);
          setTextAll('.receipt-id-line', `Receipt ID: ${displayId || '—'}`);
          
          const d = formatDateShort(txDate);
          setHtmlAll('.meta', `Date: ${d || '—'}`);

          setTextAll('.contact-name', contactName || '—');
          if (contactAddress) {
            setHtmlAll('.contact-address', addressToHtml(contactAddress));
            document.querySelectorAll('.contact-address').forEach((el) => (el.style.display = ''));
          } else {
            setHtmlAll('.contact-address', '');
            document.querySelectorAll('.contact-address').forEach((el) => (el.style.display = 'none'));
          }

          // company-id is not a cash box id; keep hidden unless a real company identifier exists.
          setTextAll('.company-id', '');
          document.querySelectorAll('.company-id').forEach((el) => (el.style.display = 'none'));

          if (contactOtherId) {
            setTextAll('.contact-id', contactOtherId);
            document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = ''));
          } else {
            setTextAll('.contact-id', '');
            document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = 'none'));
          }

          if (displayId) {
            document.title = displayId;
          }

          try {
            const params = new URLSearchParams(window.location.search);
            const shouldAutoPrint = params.get('autoPrint') === '1' && params.get('txId');

            if (shouldAutoPrint) {
              const rawReturnTo = String(params.get('returnTo') || '').trim();
              const returnToUrl = (() => {
                if (!rawReturnTo) return 'dashboard.html';
                try {
                  const u = new URL(rawReturnTo, window.location.origin);
                  if (u.origin !== window.location.origin) return 'dashboard.html';
                  return u.href;
                } catch (_) {
                  return 'dashboard.html';
                }
              })();

              // Track when print started - don't allow close until user has had time to interact
              const printStartTime = Date.now();
              const MIN_PRINT_TIME_MS = 3000; // Minimum 3 seconds before auto-close allowed

              setTimeout(() => {
                try { window.print(); } catch (_) {}
              }, 150);

              let printDone = false;
              const handleAfterPrint = () => {
                if (printDone) return;
                
                // Don't close if print dialog was dismissed too quickly (likely browser quirk)
                const elapsed = Date.now() - printStartTime;
                if (elapsed < MIN_PRINT_TIME_MS) {
                  // Reschedule check - user probably hasn't finished printing yet
                  setTimeout(handleAfterPrint, MIN_PRINT_TIME_MS - elapsed + 500);
                  return;
                }
                
                printDone = true;
                try {
                  if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({ type: 'RECEIPT_PRINT_DONE', returnTo: returnToUrl }, window.location.origin);
                    window.opener.focus();
                  }
                } catch (_) {}
                setTimeout(() => {
                  try { window.close(); } catch (_) {}
                }, 800);
              };

              try {
                window.addEventListener('afterprint', handleAfterPrint, { once: true });
              } catch (_) {}

              try {
                window.onafterprint = handleAfterPrint;
              } catch (_) {}

              // Fallback timeout - 2 minutes
              setTimeout(handleAfterPrint, 120000);
            }
          } catch (_) {
            // ignore
          }
        } catch (_) {
          // ignore
        }
      })();
    </script>
</body>
</html>
