<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="robots" content="noindex">
    <title>New Transaction — SpendNote</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=23">
    <link rel="stylesheet" href="assets/css/app-layout.css?v=18">
    <link rel="stylesheet" href="assets/css/dashboard.css?v=20260220-1548">
    <style>
        /* =============================================
           NEW TRANSACTION PAGE — full-screen mobile form
           ============================================= */
        body {
            background: var(--bg, #f1f5f9);
            min-height: 100dvh;
            overflow-x: hidden;
            overscroll-behavior-x: none;
            touch-action: pan-y;
        }

        html {
            overflow-x: hidden;
            overscroll-behavior-x: none;
            touch-action: pan-y;
        }

        .nt-page {
            display: flex;
            flex-direction: column;
            min-height: 100dvh;
            max-width: 680px;
            margin: 0 auto;
            width: 100%;
            overflow-x: hidden;
        }

        #createTransactionModalContainer,
        .nt-body,
        .nt-body form,
        .nt-body .modal-section {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }

        /* Top bar: back button + title + date */
        .nt-topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid var(--border, #e2e8f0);
            position: sticky;
            top: 0;
            z-index: 20;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .nt-back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1.5px solid var(--border, #e2e8f0);
            background: white;
            color: var(--text, #1e293b);
            font-size: 16px;
            cursor: pointer;
            flex-shrink: 0;
            text-decoration: none;
        }

        .nt-back-btn:hover {
            background: var(--bg, #f1f5f9);
        }

        .nt-topbar-title {
            font-size: 17px;
            font-weight: 800;
            color: var(--text, #1e293b);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .nt-topbar-watermark {
            display: none;
            margin-left: auto;
            font-size: 56px;
            line-height: 1;
            font-weight: 900;
            letter-spacing: 0.08em;
            color: rgba(16, 185, 129, 0.16);
            pointer-events: none;
            user-select: none;
        }

        .nt-topbar-watermark::after {
            content: "IN";
        }

        body:has(#createTransactionModalContainer[data-direction="out"]) .nt-topbar-watermark::after {
            content: "OUT";
            color: rgba(71, 85, 105, 0.2);
        }

        .nt-topbar-date {
            font-size: 12px;
            color: var(--text-muted, #64748b);
            font-weight: 500;
            flex-shrink: 0;
        }

        /* Direction header: IN/OUT + watermark */
        .nt-direction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px 10px;
            background: white;
            border-bottom: 3px solid rgba(var(--modal-dir-rgb, 5,150,105), 0.5);
            position: sticky;
            top: 65px;
            z-index: 19;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .nt-direction-header .modal-direction-primary {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .nt-direction-header .modal-watermark {
            margin-left: auto;
            font-size: 64px;
            line-height: 1;
            pointer-events: none;
            user-select: none;
        }

        /* Cashbox selector row */
        .nt-cashbox-row {
            padding: 10px 16px;
            background: white;
            border-bottom: 1px solid var(--border, #e2e8f0);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .nt-cashbox-row .cashbox-display {
            width: 100%;
        }

        /* Scrollable form body */
        .nt-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            padding-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #createTransactionModalContainer[data-mode="quick"] .nt-body {
            padding-bottom: calc(92px + env(safe-area-inset-bottom));
        }

        #createTransactionModalContainer[data-mode="detailed"] .nt-body {
            padding-bottom: calc(126px + env(safe-area-inset-bottom));
        }

        /* Fixed footer with save buttons */
        .nt-footer {
            position: fixed;
            bottom: calc(64px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-top: 1px solid var(--border, #e2e8f0);
            padding: 12px 16px;
            padding-bottom: 12px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            z-index: 1120;
            box-sizing: border-box;
            overflow-x: hidden;
            width: min(100%, 680px);
            max-width: min(100%, 680px);
        }

        .nt-footer .btn {
            width: 100%;
            min-width: 0;
            max-width: 100%;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            justify-content: center;
            padding: 10px 6px;
            line-height: 1.2;
        }

        /* Loading / error states */
        .nt-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 40px 16px;
            color: var(--text-muted, #64748b);
            font-size: 14px;
        }

        .nt-error {
            margin: 16px;
            padding: 16px;
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 12px;
            color: #dc2626;
            font-size: 14px;
        }

        /* Mode toggle row */
        .nt-mode-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .nt-mode-row .modal-mode-toggle {
            flex: 1;
        }

        /* Compact form inputs on mobile */
        .nt-body .form-control,
        .nt-body .form-input,
        .nt-body .form-textarea {
            font-size: 15px !important;
            min-height: 40px !important;
            padding: 8px 12px !important;
        }

        .nt-body .modal-section {
            padding: 12px !important;
        }

        /* Standalone page: stack description and amount in separate rows */
        .nt-body .form-row-line-item,
        .nt-body .receipt-items-header {
            grid-template-columns: 1fr !important;
            gap: 8px !important;
        }

        /* Contact grid: single column */
        .nt-body .modal-contact-grid {
            grid-template-columns: 1fr !important;
        }

        /* Force compact modal-layout widths for this standalone mobile page */
        #createTransactionModalContainer .receipt-items-header,
        #createTransactionModalContainer .form-row-line-item,
        #createTransactionModalContainer[data-mode="quick"] .receipt-items-header,
        #createTransactionModalContainer[data-mode="quick"] .form-row-line-item {
            grid-template-columns: 1fr !important;
            gap: 8px !important;
        }

        #createTransactionModalContainer .receipt-items-header div:last-child {
            text-align: left !important;
        }

        #createTransactionModalContainer[data-mode="quick"] .modal-contact-grid,
        #createTransactionModalContainer[data-mode="detailed"] .modal-contact-grid {
            grid-template-columns: 1fr !important;
            gap: 10px !important;
        }

        #createTransactionModalContainer[data-mode="detailed"] .modal-contact-name,
        #createTransactionModalContainer[data-mode="detailed"] .modal-contact-address,
        #createTransactionModalContainer[data-mode="detailed"] .modal-contact-company {
            grid-column: 1 !important;
            grid-row: auto !important;
        }

        #createTransactionModalContainer .modal-contact-grid,
        #createTransactionModalContainer[data-mode="quick"] .modal-contact-grid,
        #createTransactionModalContainer[data-mode="detailed"] .modal-contact-grid {
            grid-template-columns: 1fr !important;
        }

        #createTransactionModalContainer .cashbox-display {
            min-width: 0 !important;
            width: 100% !important;
        }

        #createTransactionModalContainer .cashbox-display .cashbox-info {
            min-width: 0 !important;
            width: 100% !important;
        }

        #createTransactionModalContainer .cashbox-display .cashbox-name,
        #createTransactionModalContainer .cashbox-display .cashbox-balance,
        #createTransactionModalContainer #modalCashboxName {
            min-width: 0 !important;
            max-width: 100% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        #createTransactionModalContainer .cashbox-display .cashbox-name {
            overflow: hidden !important;
        }

        #createTransactionModalContainer .cashbox-display .cashbox-id {
            max-width: 78px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #createTransactionModalContainer .modal-mode-row,
        #createTransactionModalContainer .nt-mode-row {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }

        #createTransactionModalContainer .modal-mode-row > *,
        #createTransactionModalContainer .nt-mode-row > * {
            min-width: 0;
        }

        #createTransactionModalContainer #modalDateField {
            width: 108px !important;
        }

        @media (max-width: 390px) {
            #createTransactionModalContainer .receipt-items-header,
            #createTransactionModalContainer .form-row-line-item,
            #createTransactionModalContainer[data-mode="quick"] .receipt-items-header,
            #createTransactionModalContainer[data-mode="quick"] .form-row-line-item {
                grid-template-columns: 1fr !important;
            }

            #createTransactionModalContainer #modalDateField {
                width: 92px !important;
                font-size: 11px !important;
            }
        }

        @media (max-width: 768px) {
            .nt-page {
                max-width: none;
            }

            .nt-topbar {
                padding: 10px 12px;
            }

            .nt-topbar-title {
                font-size: 16px;
                flex: 0 1 auto;
            }

            .nt-topbar-watermark {
                display: block;
                font-size: clamp(34px, 11vw, 56px);
            }

            .nt-topbar-date {
                display: none;
            }

            .nt-direction-header {
                top: 60px;
                padding: 10px 12px;
                gap: 8px;
                flex-wrap: wrap;
            }

            .nt-direction-header .modal-direction-primary {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .nt-direction-header .direction-primary-btn {
                width: 100%;
                height: 42px;
                padding: 0 10px;
                justify-content: center;
            }

            .nt-direction-header .modal-watermark {
                display: none;
            }

            .nt-cashbox-row {
                padding: 8px 12px;
            }

            .nt-body {
                padding: 10px 12px;
                padding-bottom: 10px;
            }

            #createTransactionModalContainer[data-mode="quick"] .nt-body {
                padding-bottom: calc(90px + env(safe-area-inset-bottom));
            }

            #createTransactionModalContainer[data-mode="detailed"] .nt-body {
                padding-bottom: calc(122px + env(safe-area-inset-bottom));
            }

            .nt-footer {
                padding: 10px 12px;
                padding-bottom: 10px;
            }

            .nt-footer .btn {
                min-height: 44px;
                font-size: 13px;
                padding: 10px 8px;
            }

            .nt-mode-row {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                flex-wrap: nowrap;
            }

            .nt-mode-row .modal-mode-toggle {
                flex: 1;
                min-width: 0;
            }

            #createTransactionModalContainer #modalDateField {
                width: auto !important;
                min-width: 88px;
                max-width: 108px;
                flex: 0 0 auto;
                font-size: 11px !important;
                min-height: 34px !important;
                padding: 4px 6px !important;
            }
        }

        @media (max-width: 420px) {
            .nt-topbar-watermark {
                font-size: clamp(30px, 10vw, 42px);
            }

            .nt-mode-row {
                flex-direction: row;
                align-items: center;
            }

            #createTransactionModalContainer #modalDateField {
                width: 88px !important;
            }

            #createTransactionModalContainer .modal-mode-toggle label {
                padding: 0 10px;
                font-size: 11px;
            }

            .nt-footer {
                gap: 8px;
            }

            .nt-footer .btn i {
                display: none;
            }
        }
    </style>
</head>
<body>
<div id="nav-container"></div>

<div class="nt-page" id="ntPage">

    <!-- Top bar -->
    <div class="nt-topbar">
        <a href="dashboard.html" class="nt-back-btn" aria-label="Back to dashboard">
            <i class="fas fa-arrow-left"></i>
        </a>
        <span class="nt-topbar-title">New Transaction</span>
        <span class="nt-topbar-watermark" aria-hidden="true"></span>
        <span class="nt-topbar-date" id="ntTopbarDate"></span>
    </div>

    <!-- Loading state -->
    <div class="nt-loading" id="ntLoading">
        <i class="fas fa-spinner fa-spin"></i>
        Loading cash boxes...
    </div>

    <!-- Error state -->
    <div class="nt-error" id="ntError" style="display:none;"></div>

    <!-- Main content (hidden until loaded) -->
    <div id="createTransactionModalContainer" data-direction="in" data-mode="quick" style="display:none;">

        <!-- Direction header: IN/OUT + watermark -->
        <div class="nt-direction-header">
            <div class="modal-direction-primary">
                <input type="radio" name="modalDirection" id="modalDirectionIn" value="in" checked>
                <label for="modalDirectionIn" class="direction-primary-btn in" tabindex="0">
                    <span class="quick-icon"><i class="fas fa-arrow-down"></i></span>
                    <span>IN</span>
                </label>
                <input type="radio" name="modalDirection" id="modalDirectionOut" value="out">
                <label for="modalDirectionOut" class="direction-primary-btn out" tabindex="0">
                    <span class="quick-icon"><i class="fas fa-arrow-up"></i></span>
                    <span>OUT</span>
                </label>
            </div>
            <div class="modal-watermark" aria-hidden="true"></div>
        </div>

        <!-- Cashbox selector -->
        <div class="nt-cashbox-row">
            <div class="cashbox-display" id="modalCashboxDisplay">
                <div class="cashbox-icon" id="modalCashboxIcon"></div>
                <div class="cashbox-info">
                    <div class="cashbox-name">
                        <span class="cashbox-id" id="modalCashboxIdDisplay"></span>
                        <span id="modalCashboxName">Loading...</span>
                    </div>
                    <div class="cashbox-balance" id="modalCashboxBalance"></div>
                </div>
                <div class="cashbox-arrows">
                    <button type="button" class="cashbox-arrow" id="modalCashboxPrev" title="Previous">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button type="button" class="cashbox-arrow" id="modalCashboxNext" title="Next">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <input type="hidden" id="modalCashBoxId" value="">
            </div>
        </div>

        <!-- Scrollable form body -->
        <div class="nt-body">
            <form id="modalTransactionForm" autocomplete="off" style="display: flex; flex-direction: column; gap: 12px;">
                <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none;">
                <input type="password" name="password" autocomplete="new-password" tabindex="-1" aria-hidden="true" style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none;">

                <!-- Contact Section -->
                <div class="modal-section" style="padding: 16px;">
                    <!-- Mode toggle + Date -->
                    <div class="modal-mode-row nt-mode-row" style="margin-bottom: 12px;">
                        <div class="modal-mode-toggle" id="modalModeToggle">
                            <input type="radio" name="modalMode" id="modalModeQuick" value="quick" checked>
                            <label for="modalModeQuick">Quick</label>
                            <input type="radio" name="modalMode" id="modalModeDetailed" value="detailed">
                            <label for="modalModeDetailed">Detailed</label>
                        </div>
                        <input type="text" id="modalDateField" class="form-control" readonly
                            style="width:120px; flex-shrink:0; background:rgba(255,255,255,0.7); cursor:default; color:var(--text-muted); text-align:center; font-size:12px; min-height:36px; padding:4px 8px;">
                    </div>

                    <input type="hidden" id="modalDate">

                    <div class="modal-contact-grid" style="display:grid; gap:12px;">
                        <div class="form-group modal-contact-name">
                            <label for="modalContactName">Name <span class="required">*</span></label>
                            <input type="text" id="modalContactName" name="modalContactName"
                                class="form-control" placeholder="Contact name"
                                autocomplete="new-password" spellcheck="false"
                                autocapitalize="off" autocorrect="off">
                            <div id="ContactAutocomplete" class="autocomplete-dropdown"></div>
                            <label for="modalSaveContact" style="display:inline-flex; align-items:center; gap:8px; margin-top:8px; font-size:12px; font-weight:600; color:var(--text-muted);">
                                <input type="checkbox" id="modalSaveContact" style="width:14px; height:14px; accent-color:var(--active);">
                                Save to Contacts
                            </label>
                        </div>
                        <div class="form-group modal-contact-address">
                            <label for="modalContactAddress">Address <span style="font-size:11px; color:var(--text-muted); font-weight:500;">(optional)</span></label>
                            <textarea id="modalContactAddress" name="modalContactAddress"
                                autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
                                class="form-control modal-address-textarea"
                                placeholder="Street (press Enter for line 2)" rows="1"></textarea>
                        </div>
                        <div class="form-group modal-detailed-only modal-contact-company" id="modalContactDetails">
                            <label for="modalContactCompanyId">Other ID</label>
                            <input type="text" id="modalContactCompanyId" class="form-control" placeholder="Other ID">
                        </div>
                    </div>
                    <input type="hidden" id="modalContactId">
                </div>

                <!-- Items Section -->
                <div class="modal-section" style="padding: 12px;">
                    <div class="modal-section-title" id="modalItemsSectionTitle">Items</div>

                    <div class="receipt-items-header" style="border-bottom: 1px solid var(--border); padding-bottom: 6px; margin-bottom: 8px;">
                        <div id="modalItemsDescriptionHeader">Description <span class="required">*</span></div>
                        <div>Amount <span class="required">*</span></div>
                    </div>

                    <div class="form-row-line-item" style="margin-bottom: 10px;">
                        <div class="form-group">
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-input" id="modalDescription"
                                    placeholder="Item description" autocomplete="off" required>
                                <div class="autocomplete-dropdown" id="descriptionAutocomplete"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="input-with-prefix">
                                <span class="input-prefix">$</span>
                                <input type="number" class="form-input" id="modalAmount"
                                    placeholder="0.00" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="add-line-item-btn modal-detailed-only" id="modalExpandItemsBtn" style="width:100%; margin-bottom:10px;">
                        <i class="fas fa-plus-circle"></i> Add more items
                    </button>

                    <div class="line-items-container modal-detailed-only" id="modalLineItemsContainer" style="display:none;"></div>

                    <div id="lineItemsTotal" style="display:flex; padding:12px 16px; background:white; border:2px solid var(--border); border-radius:10px; font-weight:800; font-size:15px; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="color:var(--text);">Total</span>
                        <span id="lineItemsTotalAmount" style="color:var(--text); font-size:18px; letter-spacing:-0.02em;">$0.00</span>
                    </div>
                </div>

                <!-- Note Section -->
                <details class="modal-collapsible modal-detailed-only" id="modalNoteSection" style="padding: 10px 12px;">
                    <summary>
                        <span class="summary-icon"><i class="fas fa-sticky-note"></i> Add note</span>
                    </summary>
                    <div class="modal-collapsible-content">
                        <textarea class="form-textarea" id="modalNote"
                            placeholder="Add any additional notes or comments" rows="2"></textarea>
                    </div>
                </details>

                <!-- Hidden fields -->
                <input type="hidden" id="modalTransactionId">

                <!-- Add another checkbox -->
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text-muted); font-weight:600; cursor:pointer; user-select:none; padding: 0 4px;">
                    <input type="checkbox" id="modalAddAnother" style="width:16px; height:16px;">
                    <span>Add another after saving</span>
                </label>
            </form>
        </div>

        <!-- Sticky footer buttons -->
        <div class="nt-footer">
            <button type="submit" form="modalTransactionForm" class="btn btn-primary" name="action" value="done">
                <i class="fas fa-check"></i> Save
            </button>
            <button type="submit" form="modalTransactionForm" class="btn btn-blue" name="action" value="done-receipt">
                <i class="fas fa-print"></i> Save & Print
            </button>
        </div>

    </div><!-- /createTransactionModalContainer -->
</div><!-- /nt-page -->

<!-- Supabase + core scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js?v=20260216-2236"></script>
<script src="assets/js/auth-guard.js?v=20260213-1658"></script>
<script src="assets/js/modal-dialogs.js?v=20260208-1900"></script>
<script src="assets/js/nav-loader.js?v=20260220-2115"></script>
<script>loadNav();</script>
<script src="assets/js/main.js?v=24"></script>
<script src="assets/js/dashboard-modal.js?v=20260219-0230"></script>
<script src="assets/js/dashboard-form.js?v=20260220-2000"></script>

<script>
(function () {
    'use strict';

    // On real desktop: redirect to dashboard (modal handles it there)
    // Keep tablets (incl. iPad) on this standalone page.
    const desktopViewport = window.matchMedia('(min-width: 1024px)').matches;
    const coarsePointer = window.matchMedia('(pointer: coarse)').matches;
    const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (desktopViewport && !coarsePointer && !hasTouch) {
        window.location.replace('dashboard.html#new-transaction');
        return;
    }

    // ── helpers ──────────────────────────────────────────────
    function hexToRgb(hex) {
        const h = String(hex || '').replace('#', '');
        if (h.length !== 6) return '5, 150, 105';
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        return r + ', ' + g + ', ' + b;
    }

    function formatBalance(balance, currency) {
        const n = parseFloat(balance);
        if (!Number.isFinite(n)) return '';
        const sym = currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : '$';
        return sym + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function getIconClass(icon) {
        if (!icon) return 'fa-cash-register';
        if (icon.startsWith('fa-')) return icon;
        return 'fa-cash-register';
    }

    // ── date init ────────────────────────────────────────────
    function initDate() {
        const now = new Date();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const yyyy = now.getFullYear();
        const dateEl = document.getElementById('ntTopbarDate');
        if (dateEl) dateEl.textContent = mm + '/' + dd + '/' + yyyy;
        const dateField = document.getElementById('modalDateField');
        if (dateField) {
            dateField.value = mm + '/' + dd + '/' + yyyy;
            dateField.dataset.fullDate = now.toISOString();
        }
        const dateHidden = document.getElementById('modalDate');
        if (dateHidden) dateHidden.value = yyyy + '-' + mm + '-' + dd;
    }

    // ── build hidden .register-card elements ─────────────────
    // dashboard-modal.js reads these to populate the cashbox carousel
    function buildRegisterCards(cashBoxes) {
        let container = document.getElementById('ntRegisterCards');
        if (!container) {
            container = document.createElement('div');
            container.id = 'ntRegisterCards';
            container.style.cssText = 'display:none;position:fixed;top:0;left:0;opacity:0;pointer-events:none;';
            document.body.appendChild(container);
        }
        container.innerHTML = '';

        let preferredId = '';
        try { preferredId = String(localStorage.getItem('activeCashBoxId') || '').trim(); } catch (_) {}

        cashBoxes.forEach(function (cb) {
            const seq = Number(cb.sequence_number);
            const displayCode = Number.isFinite(seq) && seq > 0
                ? 'SN-' + String(seq).padStart(3, '0')
                : (String(cb.id_prefix || '').trim() || 'SN');
            const color = cb.color || '#059669';
            const rgb = hexToRgb(color);
            const iconClass = getIconClass(cb.icon);
            const balanceText = formatBalance(cb.current_balance, cb.currency);

            const card = document.createElement('div');
            card.className = 'register-card' + (cb.id === preferredId ? ' active' : '');
            card.dataset.id = cb.id;
            card.dataset.color = color;
            card.dataset.rgb = rgb;
            card.dataset.displayCode = displayCode;
            card.dataset.sequenceNumber = Number.isFinite(seq) ? String(seq) : '';
            card.dataset.icon = iconClass;
            // dashboard-modal.js reads these child elements:
            card.innerHTML =
                '<span class="register-id">' + displayCode + '</span>' +
                '<span class="register-name">' + (cb.name || 'Cash Box') + '</span>' +
                '<span class="register-balance">' + balanceText + '</span>';
            container.appendChild(card);
        });
    }

    // ── direction UI ─────────────────────────────────────────
    function setDirection(direction) {
        const container = document.getElementById('createTransactionModalContainer');
        if (!container) return;
        const dir = direction === 'out' ? 'out' : 'in';
        container.dataset.direction = dir;
        // sync radio
        const radio = document.getElementById(dir === 'out' ? 'modalDirectionOut' : 'modalDirectionIn');
        if (radio) radio.checked = true;
    }

    // ── cashbox display ───────────────────────────────────────
    // Mirrors dashboard-modal.js updateModalCashboxDisplay but works standalone
    function updateCashboxDisplay() {
        const cashbox = window.modalCashBoxes && window.modalCashBoxes[window.modalCashBoxIndex];
        if (!cashbox) return;

        const iconEl = document.getElementById('modalCashboxIcon');
        const nameEl = document.getElementById('modalCashboxName');
        const idDisplayEl = document.getElementById('modalCashboxIdDisplay');
        const balanceEl = document.getElementById('modalCashboxBalance');
        const idInput = document.getElementById('modalCashBoxId');

        if (iconEl) {
            iconEl.innerHTML = '<i class="fas ' + cashbox.icon + '"></i>';
            iconEl.style.background = cashbox.color;
        }
        if (nameEl) nameEl.textContent = cashbox.name;
        if (idDisplayEl) idDisplayEl.textContent = cashbox.displayId || '';
        if (balanceEl) balanceEl.textContent = cashbox.balance ? 'Balance: ' + cashbox.balance : '';
        if (idInput) idInput.value = cashbox.id;

        // Update theme color
        document.documentElement.style.setProperty('--active', cashbox.color);
        document.documentElement.style.setProperty('--active-rgb', cashbox.rgb);
        try {
            localStorage.setItem('activeCashBoxColor', cashbox.color);
            localStorage.setItem('activeCashBoxRgb', cashbox.rgb);
            localStorage.setItem('activeCashBoxId', cashbox.id);
        } catch (_) {}
    }
    // expose so dashboard-modal.js can call it too
    window.updateModalCashboxDisplay = updateCashboxDisplay;

    // ── wire events ───────────────────────────────────────────
    function wireEvents() {
        // Direction buttons
        document.querySelectorAll('input[name="modalDirection"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                setDirection(radio.value);
            });
        });

        // Cashbox prev/next
        document.getElementById('modalCashboxPrev') && document.getElementById('modalCashboxPrev').addEventListener('click', function () {
            if (!window.modalCashBoxes || window.modalCashBoxes.length < 2) return;
            window.modalCashBoxIndex = (window.modalCashBoxIndex - 1 + window.modalCashBoxes.length) % window.modalCashBoxes.length;
            updateCashboxDisplay();
        });
        document.getElementById('modalCashboxNext') && document.getElementById('modalCashboxNext').addEventListener('click', function () {
            if (!window.modalCashBoxes || window.modalCashBoxes.length < 2) return;
            window.modalCashBoxIndex = (window.modalCashBoxIndex + 1) % window.modalCashBoxes.length;
            updateCashboxDisplay();
        });

        // Mode toggle — update data-mode on #createTransactionModalContainer
        document.querySelectorAll('input[name="modalMode"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                if (typeof window.updateModalModeUI === 'function') {
                    window.updateModalModeUI(radio.value);
                } else {
                    const container = document.getElementById('createTransactionModalContainer');
                    if (container) container.dataset.mode = radio.value;
                }
            });
        });
    }

    // ── override page-level functions ────────────────────────
    window.closeModal = function () {
        window.location.href = 'dashboard.html';
    };

    window.loadDashboardData = function () {
        const addAnother = Boolean(document.getElementById('modalAddAnother') && document.getElementById('modalAddAnother').checked);
        if (addAnother) {
            // preserve cashbox selection across reload
            window.location.reload();
        } else {
            window.location.href = 'dashboard.html';
        }
        return Promise.resolve();
    };

    // ── main init ─────────────────────────────────────────────
    async function init() {
        initDate();

        const loadingEl = document.getElementById('ntLoading');
        const errorEl   = document.getElementById('ntError');
        const contentEl = document.getElementById('createTransactionModalContainer');

        try {
            // Wait for supabase-config.js to expose window.auth + window.db
            let tries = 0;
            while ((!window.auth || !window.db) && tries < 80) {
                await new Promise(function (r) { setTimeout(r, 100); });
                tries++;
            }
            if (!window.auth || !window.db) throw new Error('Auth not available — please refresh.');

            const user = await window.auth.getCurrentUser();
            if (!user) { window.location.href = 'spendnote-login.html'; return; }

            // Load cashboxes with all fields needed
            const cashBoxes = await window.db.cashBoxes.getAll({
                select: 'id, name, color, currency, icon, current_balance, sequence_number, id_prefix, sort_order'
            });

            if (!Array.isArray(cashBoxes) || !cashBoxes.length) {
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) {
                    errorEl.style.display = '';
                    errorEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> You need to create a Cash Box first. ' +
                        '<a href="spendnote-cash-box-settings.html" style="color:inherit;font-weight:700;">Create one →</a>';
                }
                return;
            }

            // Build hidden register-card DOM so dashboard-modal.js carousel works
            buildRegisterCards(cashBoxes);

            // Build window.modalCashBoxes array directly (don't rely on DOM)
            window.modalCashBoxes = cashBoxes.map(function (cb) {
                const seq = Number(cb.sequence_number);
                const displayId = Number.isFinite(seq) && seq > 0
                    ? 'SN-' + String(seq).padStart(3, '0')
                    : (String(cb.id_prefix || '').trim() || 'SN');
                return {
                    id: cb.id,
                    name: cb.name || 'Cash Box',
                    displayId: displayId,
                    color: cb.color || '#059669',
                    rgb: hexToRgb(cb.color || '#059669'),
                    icon: getIconClass(cb.icon),
                    balance: formatBalance(cb.current_balance, cb.currency)
                };
            });

            // Set preferred cashbox from URL param or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlCashBoxId = urlParams.get('cashBoxId');
            const urlDirection = urlParams.get('direction');

            let preferredId = urlCashBoxId || '';
            if (!preferredId) {
                try { preferredId = String(localStorage.getItem('activeCashBoxId') || '').trim(); } catch (_) {}
            }
            const preferredIdx = preferredId
                ? window.modalCashBoxes.findIndex(function (cb) { return cb.id === preferredId; })
                : -1;
            window.modalCashBoxIndex = preferredIdx >= 0 ? preferredIdx : 0;

            // Show content
            if (loadingEl) loadingEl.style.display = 'none';
            if (contentEl) contentEl.style.display = '';

            // Update cashbox display
            updateCashboxDisplay();

            // Set direction from URL or default
            if (urlDirection === 'in' || urlDirection === 'out') {
                setDirection(urlDirection);
            } else {
                setDirection('in');
            }

            // Set mode from localStorage
            const storedMode = (() => {
                try { return localStorage.getItem('spendnote.modalMode') === 'detailed' ? 'detailed' : 'quick'; }
                catch (_) { return 'quick'; }
            })();
            if (typeof window.updateModalModeUI === 'function') {
                window.updateModalModeUI(storedMode, { persist: false });
            } else {
                const container = document.getElementById('createTransactionModalContainer');
                if (container) container.dataset.mode = storedMode;
                const modeRadio = document.getElementById(storedMode === 'detailed' ? 'modalModeDetailed' : 'modalModeQuick');
                if (modeRadio) modeRadio.checked = true;
            }

            // Wire all events
            wireEvents();

            // Init form submission (dashboard-form.js)
            if (typeof initTransactionForm === 'function') {
                initTransactionForm();
            }

        } catch (err) {
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) {
                errorEl.style.display = '';
                errorEl.textContent = String(err && err.message ? err.message : 'Failed to load. Please refresh.');
            }
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
