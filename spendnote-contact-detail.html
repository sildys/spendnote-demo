<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Contact details in SpendNote.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Contact Details - SpendNote</title>
    <!-- Updated: 2026-01-18 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=12">
    <link rel="stylesheet" href="assets/css/app-layout.css?v=14">
    <style>
        /* ===== CONTACT DETAIL PAGE SPECIFIC STYLES ===== */

        /* PAGE HEADER */
        .page-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        .page-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* STATS */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            min-width: 120px;
        }

        .stat-box-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 4px;
        }

        .stat-box-value {
            font-size: 18px;
            font-weight: 900;
            color: var(--text);
        }

        /* CONTENT GRID */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        /* CARD */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
        }

        .card-body {
            padding: 24px 32px;
        }

        /* FORM */
        .form-group {
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .form-grid .form-group {
            margin-bottom: 0;
        }

        .form-grid .span-2 {
            grid-column: 1 / -1;
        }

        @media (max-width: 720px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: var(--error);
            margin-left: 4px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--surface);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--active);
            box-shadow: 0 0 0 3px rgba(var(--active-rgb), 0.1);
        }

        .form-group input:disabled,
        .form-group textarea:disabled {
            background: var(--bg);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .form-group textarea {
            resize: vertical;
        }

        .two-line-textarea {
            min-height: unset;
            height: 56px;
            min-height: 56px;
            max-height: 56px;
            line-height: 1.5;
            resize: none !important;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .form-group textarea.two-line-textarea {
            height: 64px;
            min-height: 64px;
            max-height: 64px;
            resize: none !important;
            line-height: 1.5;
        }

        .two-line-textarea::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .form-help {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* INFO ITEM */
        .info-item {
            margin-bottom: 24px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .info-value.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* TRANSACTIONS LIST */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-radius: 12px;
            background: var(--bg);
            margin-bottom: 10px;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .transaction-item:hover {
            background: var(--surface);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .transaction-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .transaction-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .transaction-icon.in {
            background: rgba(5, 150, 105, 0.1);
            color: var(--primary);
        }

        .transaction-icon.out {
            background: rgba(var(--out-rgb), 0.10);
            color: var(--out);
        }

        .transaction-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-id {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
        }

        .tx-type-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid;
            background: transparent;
            font-weight: 900;
            font-size: 11px;
            letter-spacing: 0.04em;
            width: 74px;
            box-sizing: border-box;
            margin-left: 8px;
            vertical-align: middle;
        }

        .tx-type-pill.in {
            --quick-accent: #059669;
            color: var(--quick-accent);
            border-color: rgba(5, 150, 105, 0.35);
            background: rgba(5, 150, 105, 0.06);
        }

        .tx-type-pill.out {
            --quick-accent: var(--out);
            color: var(--quick-accent);
            border-color: rgba(var(--out-rgb), 0.35);
            background: rgba(var(--out-rgb), 0.06);
        }

        .tx-type-pill .quick-icon {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--quick-accent);
            color: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: none;
            flex-shrink: 0;
        }

        .tx-type-pill .quick-icon i {
            font-size: 8px;
        }

        .tx-type-pill .quick-label {
            font-weight: 900;
        }

        .transaction-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-size: 15px;
            font-weight: 800;
        }

        .transaction-amount.in {
            color: var(--primary);
        }

        .transaction-amount.out {
            color: var(--out);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            color: var(--text-muted);
            opacity: 0.5;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
<!-- Navigation loaded dynamically by nav-loader.js -->
<div id="nav-container"></div>

<div class="app-container">
    <main class="main-content">
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-title-group">
                    <span class="badge badge-success" id="contactIdBadge">—</span>
                    <h1 class="page-title" id="pageTitle">Contact Details</h1>
                    <p class="page-subtitle" id="contactMeta">Loading…</p>
                </div>
                <div class="page-header-actions" id="headerActions"></div>
            </div>
        </div>

        <div class="content-grid">
            <!-- Left Column: Contact Information -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Contact Information</h2>
                </div>
                <div class="card-body">
                    <form id="contactForm">
                        <div class="form-grid">
                            <div class="form-group span-2">
                                <label for="contactName">Name <span class="required">*</span></label>
                                <input type="text" id="contactName" name="contactName" required>
                            </div>

                        </div>

                        <div class="form-group">
                            <label for="contactAddress">Address</label>
                            <textarea id="contactAddress" name="contactAddress" rows="2" class="two-line-textarea"></textarea>
                            <p class="form-help">Optional - contact's full address</p>
                        </div>

                        <div class="form-group">
                            <label for="contactEmail">Email</label>
                            <input type="email" id="contactEmail" name="contactEmail">
                            <p class="form-help">Optional - contact's email address</p>
                        </div>

                        <div class="form-group">
                            <label for="contactOtherId">Other ID</label>
                            <input type="text" id="contactOtherId" name="contactOtherId">
                            <p class="form-help">Optional - reference ID for this contact</p>
                        </div>

                        <div id="formActions" style="display: none;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Contact
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='spendnote-contact-list.html'">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column: Stats & Transactions -->
            <div>
                <!-- Stats -->
                <div class="stats-row" id="statsRow">
                    <div class="stat-box">
                        <div class="stat-box-label">Transactions</div>
                        <div class="stat-box-value" id="statTransactions">—</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Last Activity</div>
                        <div class="stat-box-value" id="statLastActivity">—</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Cash Boxes</div>
                        <div class="stat-box-value" id="statCashBoxes" style="display: flex; gap: 4px; align-items: center;">—</div>
                    </div>
                </div>

                <!-- Recent Transactions Card -->
                <div class="card" id="transactionsCard">
                    <div class="card-header">
                        <h2 class="card-title">Latest Transactions</h2>
                    </div>
                    <div class="card-body" id="transactionsList">
                        <div class="empty-state"><div class="empty-state-text">Loading…</div></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

    <!-- Modern 2-Row Footer -->
<footer class="app-footer">
    <div class="app-footer-container">
        <!-- Top Row -->
        <div class="app-footer-top">
            <!-- Brand Section with Disclaimer -->
            <div class="app-footer-brand">
                <a href="dashboard.html" class="app-footer-brand-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="white"/>
                        <path d="M32 4 L38 10 L32 10 Z" fill="rgba(0,0,0,0.15)"/>
                        <path d="M32 4 L32 10 L38 10" stroke="rgba(0,0,0,0.2)" stroke-width="1.5" stroke-linejoin="round"/>
                        <line x1="14" y1="14" x2="30" y2="14" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="rgba(0,0,0,0.12)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="rgba(0,0,0,0.1)" stroke-width="2.5" stroke-linecap="round"/>
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="rgba(0,0,0,0.2)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>SpendNote</span>
                </a>
                <p class="app-footer-brand-desc">
                    Cash receipt management for modern teams. Simple, secure, transparent.
                </p>
            </div>
            
            <!-- Right: Links + Disclaimer -->
            <div class="app-footer-right">
                <div class="app-footer-links-simple">
                    <a href="index.html#features">Features</a>
                    <a href="spendnote-pricing.html">Pricing</a>
                    <a href="spendnote-faq.html">FAQ</a>
                    <a href="spendnote-terms.html">Legal</a>
                </div>
                
                <!-- Disclaimer on right side -->
                <div class="app-footer-brand-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <span>Cash handoff documentation only. Not a tax or accounting tool.</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row -->
        <div class="app-footer-bottom">
            <div class="app-footer-copyright">
                2026 SpendNote. All rights reserved.
            </div>
        </div>
    </div>
</footer>

    <script src="assets/js/modal-dialogs.js?v=20260208-1900"></script>
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const contactIdRaw = urlParams.get('contactId');
        const mode = urlParams.get('mode');

        // Initialize page
        function formatContactDisplayId(sequenceNumber) {
            try {
                if (window.SpendNoteIds && typeof window.SpendNoteIds.formatContactDisplayId === 'function') {
                    const id = window.SpendNoteIds.formatContactDisplayId(sequenceNumber);
                    return id ? id : '—';
                }
            } catch (_) {

            }
            const n = Number(sequenceNumber);
            if (!Number.isFinite(n) || n <= 0) return '—';
            return `CONT-${String(n).padStart(3, '0')}`;
        }

        function parseContactDisplayId(value) {
            try {
                if (window.SpendNoteIds && typeof window.SpendNoteIds.parseContactDisplayId === 'function') {
                    return window.SpendNoteIds.parseContactDisplayId(value);
                }
            } catch (_) {

            }
            const v = String(value || '').trim();
            const m = /^cont-(\d+)$/i.exec(v);
            if (!m) return null;
            const n = Number(m[1]);
            return Number.isFinite(n) ? n : null;
        }

        function isUuid(value) {
            try {
                if (window.SpendNoteIds && typeof window.SpendNoteIds.isUuid === 'function') {
                    return window.SpendNoteIds.isUuid(value);
                }
            } catch (_) {

            }
            return false;
        }

        const contactId = (() => {
            const v = String(contactIdRaw || '').trim();
            if (!v) return '';
            if (isUuid(v)) return v;
            const seq = parseContactDisplayId(v);
            if (Number.isFinite(seq)) return v;
            return '';
        })();

        if (contactIdRaw && !contactId && mode !== 'new') {
            showAlert('Invalid Contact ID.', { iconType: 'error' }).then(() => {
                window.location.replace('spendnote-contact-list.html');
            });
        }

        function safeText(value, fallback = '') {
            const s = String(value ?? '').trim();
            return s ? s : fallback;
        }

        function formatDateShort(value) {
            const dt = value ? new Date(value) : null;
            if (!dt || Number.isNaN(dt.getTime())) return '—';
            return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function normalizeHexColor(value, fallback = '#94a3b8') {
            const v = String(value || '').trim();
            if (/^#?[0-9a-f]{6}$/i.test(v)) {
                return v.startsWith('#') ? v : `#${v}`;
            }
            return fallback;
        }

        function getTxDisplayId(tx) {
            const cbSeq = Number(tx?.cash_box_sequence);
            const txSeq = Number(tx?.tx_sequence_in_box);
            if (Number.isFinite(cbSeq) && cbSeq > 0 && Number.isFinite(txSeq) && txSeq > 0) {
                return `SN${cbSeq}-${String(txSeq).padStart(3, '0')}`;
            }
            const receiptNumber = safeText(tx?.receipt_number, '');
            if (receiptNumber) return receiptNumber;
            return '—';
        }

        let resolvedContactUuid = null;

        async function resolveContactBySequence(seq) {
            const user = await window.auth.getCurrentUser();
            if (!user) return null;
            const { data, error } = await window.supabaseClient
                .from('contacts')
                .select('*')
                .eq('user_id', user.id)
                .eq('sequence_number', seq)
                .single();
            if (error) return null;
            return data;
        }

        function setHeaderActions(isNew = false) {
            const deleteBtn = isNew ? '' : `
                <button type="button" class="btn btn-danger" id="deleteContactBtn" style="margin-left: auto;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            `;
            document.getElementById('headerActions').innerHTML = `
                <button type="submit" form="contactForm" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='spendnote-contact-list.html'">
                    <i class="fas fa-times"></i> Cancel
                </button>
                ${deleteBtn}
            `;
            document.getElementById('formActions').style.display = 'none';
            
            if (!isNew) {
                document.getElementById('deleteContactBtn')?.addEventListener('click', async () => {
                    if (!await showConfirm('Are you sure you want to delete this contact? This cannot be undone.', { title: 'Delete Contact', iconType: 'danger', okLabel: 'Delete', danger: true })) return;
                    const id = resolvedContactUuid;
                    if (!id) { showAlert('Cannot delete: contact ID not found.', { iconType: 'error' }); return; }
                    try {
                        const res = await window.db.contacts.delete(id);
                        if (!res || !res.success) {
                            showAlert(res?.error || 'Failed to delete contact.', { iconType: 'error' });
                            return;
                        }
                        window.location.href = 'spendnote-contact-list.html';
                    } catch (err) {
                        console.error('Delete failed:', err);
                        showAlert(err?.message || 'Failed to delete contact.', { iconType: 'error' });
                    }
                });
            }
        }

        async function init() {
            if (!window.db || !window.db.contacts || !window.auth) {
                return;
            }

            const badge = document.getElementById('contactIdBadge');

            if (mode === 'new') {
                if (badge) {
                    badge.textContent = '—';
                    badge.style.opacity = '0.5';
                }
                const statsRow = document.getElementById('statsRow');
                if (statsRow) statsRow.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'Add New Contact';
                document.getElementById('contactMeta').textContent = 'New contact - ID will be assigned on save';
                document.getElementById('transactionsCard').style.display = 'none';
                document.querySelectorAll('#contactForm input, #contactForm textarea').forEach(field => {
                    field.disabled = false;
                });
                setHeaderActions(true);
                return;
            }

            let resolved = null;
            if (isUuid(contactId)) {
                resolved = await window.db.contacts.getById(contactId);
            } else {
                const seq = parseContactDisplayId(contactId);
                if (Number.isFinite(seq)) {
                    if (window.db?.contacts?.getBySequence) {
                        resolved = await window.db.contacts.getBySequence(seq);
                    } else {
                        resolved = await resolveContactBySequence(seq);
                    }
                }
            }

            if (!resolved) {
                await showAlert('Contact not found.', { iconType: 'error' });
                window.location.href = 'spendnote-contact-list.html';
                return;
            }

            const displayId = formatContactDisplayId(resolved.sequence_number);
            if (badge) {
                badge.textContent = displayId;
                badge.style.opacity = '1';
            }

            resolvedContactUuid = safeText(resolved?.id, null);
            document.getElementById('pageTitle').textContent = resolved.name || 'Contact';

            document.getElementById('contactName').value = resolved.name || '';
            document.getElementById('contactAddress').value = resolved.address || '';
            document.getElementById('contactEmail').value = resolved.email || '';
            const otherIdEl = document.getElementById('contactOtherId');
            if (otherIdEl) otherIdEl.value = resolved.phone || '';

            const createdAt = resolved?.created_at || resolved?.created || null;
            const meta = document.getElementById('contactMeta');
            if (meta) {
                meta.textContent = `Created: ${formatDateShort(createdAt)}`;
            }

            document.querySelectorAll('#contactForm input, #contactForm textarea').forEach(field => {
                field.disabled = false;
            });

            setHeaderActions();

            await loadContactActivity(resolvedContactUuid);
        }

        async function loadContactActivity(contactUuid) {
            const statsTx = document.getElementById('statTransactions');
            const statsLast = document.getElementById('statLastActivity');
            const list = document.getElementById('transactionsList');

            if (!list || !window.supabaseClient || !window.auth) {
                return;
            }

            const user = await window.auth.getCurrentUser();
            if (!user) {
                return;
            }

            const id = safeText(contactUuid, '');
            if (!id) {
                return;
            }

            if (window.SpendNoteDebug) console.log('Loading transactions for contact:', id, 'user:', user.id);

            // Query by contact_id OR contact_name (for legacy transactions without contact_id)
            const contactName = document.getElementById('contactName')?.value || '';
            let { data, error, count } = await window.supabaseClient
                .from('transactions')
                .select('*', { count: 'exact' })
                .eq('user_id', user.id)
                .or(`contact_id.eq.${id},contact_name.ilike.${contactName}`)
                .order('created_at', { ascending: false })
                .order('transaction_date', { ascending: false })
                .limit(5);

            if (window.SpendNoteDebug) console.log('Transaction query result:', { data, error, count });

            if (error) {
                console.error('Contact transactions load error:', error);
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">Unable to load transactions.</div></div>';
                return;
            }

            // If we have data, fetch cash boxes separately
            if (data && data.length > 0) {
                const cbIds = [...new Set(data.map(tx => tx.cash_box_id).filter(Boolean))];
                if (cbIds.length > 0) {
                    const { data: cbData } = await window.supabaseClient
                        .from('cash_boxes')
                        .select('id,name,color,currency,sequence_number')
                        .in('id', cbIds);
                    const cbMap = {};
                    (cbData || []).forEach(cb => { cbMap[cb.id] = cb; });
                    data = data.map(tx => ({ ...tx, cash_box: cbMap[tx.cash_box_id] || null }));
                }
            }

            const txs = Array.isArray(data) ? data : [];
            const txCount = Number(count) || txs.length;
            if (statsTx) {
                statsTx.textContent = String(txCount || 0);
            }

            const lastDt = txs.length ? new Date(txs[0]?.transaction_date || txs[0]?.created_at || '') : null;
            if (statsLast) {
                statsLast.textContent = (lastDt && Number.isFinite(lastDt.getTime())) ? formatDateShort(lastDt) : '—';
            }

            // Render cash box dots
            const statsCashBoxes = document.getElementById('statCashBoxes');
            if (statsCashBoxes && data && data.length > 0) {
                const cbIds = [...new Set(data.map(tx => tx.cash_box_id).filter(Boolean))];
                const maxDots = 15;
                const visibleIds = cbIds.slice(0, maxDots);
                const extraCount = cbIds.length - maxDots;
                const extraNames = cbIds.slice(maxDots).map(id => {
                    const tx = data.find(t => t.cash_box_id === id);
                    return tx?.cash_box?.name || 'Cash Box';
                }).join(', ');
                
                let dotsHtml = visibleIds.map(id => {
                    const tx = data.find(t => t.cash_box_id === id);
                    const cb = tx?.cash_box;
                    const name = cb?.name || 'Cash Box';
                    const color = cb?.color || '#94a3b8';
                    return `<span style="width: 12px; height: 12px; border-radius: 50%; background: ${color}; display: inline-block;" title="${name}"></span>`;
                }).join('');
                
                if (extraCount > 0) {
                    dotsHtml += `<span style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-left: 2px; cursor: help;" title="${extraNames}">+${extraCount}</span>`;
                }
                
                statsCashBoxes.innerHTML = dotsHtml || '—';
            }

            if (!txs.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">No transactions yet.</div></div>';
                return;
            }

            const sn = (typeof window !== 'undefined' && window.SpendNote) ? window.SpendNote : null;
            const fmtCurrency = (amount, currency) => {
                if (sn && typeof sn.formatCurrency === 'function') {
                    return sn.formatCurrency(amount, currency || 'USD');
                }
                try {
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD' }).format(Number(amount) || 0);
                } catch (_) {
                    return String(amount ?? '—');
                }
            };

            list.innerHTML = txs
                .map((tx) => {
                    const type = safeText(tx?.type, '').toLowerCase();
                    const isIn = type === 'income' || type === 'in';
                    const iconCls = isIn ? 'in' : 'out';
                    const displayId = getTxDisplayId(tx);
                    const dt = tx?.transaction_date || tx?.created_at;
                    const dateText = formatDateShort(dt);
                    const cbName = safeText(tx?.cash_box?.name, 'Cash Box');
                    const cbColor = normalizeHexColor(tx?.cash_box?.color, '#94a3b8');
                    const amountText = fmtCurrency(tx?.amount, tx?.cash_box?.currency || 'USD');
                    const typePill = `
                        <span class="tx-type-pill ${iconCls}" title="${isIn ? 'Income' : 'Expense'}">
                            <span class="quick-icon"><i class="fas ${isIn ? 'fa-arrow-down' : 'fa-arrow-up'}"></i></span>
                            <span class="quick-label">${isIn ? 'IN' : 'OUT'}</span>
                        </span>
                    `;
                    return `
                        <a class="transaction-item" href="spendnote-transaction-detail.html?txId=${encodeURIComponent(safeText(tx?.id, ''))}" style="--cb-color: ${cbColor};">
                            <div class="transaction-left">
                                <div class="transaction-icon ${iconCls}" title="${isIn ? 'Income' : 'Expense'}" aria-label="${isIn ? 'Income' : 'Expense'}">
                                    <i class="fas ${isIn ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                </div>
                                <div class="transaction-info">
                                    <div class="transaction-id">${safeText(displayId, '—')}${typePill}</div>
                                    <div class="transaction-date">${safeText(dateText, '—')} • <i class="fas fa-building" style="color: ${cbColor};"></i> <span style="color: ${cbColor}; font-weight: 700;">${safeText(cbName, '—')}</span></div>
                                </div>
                            </div>
                            <div class="transaction-amount ${iconCls}">${safeText(amountText, '—')}</div>
                        </a>
                    `;
                })
                .join('');
        }

        window.addEventListener('load', () => {
            init();

            const normalizeNewlines = (value) => {
                return String(value ?? '')
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n');
            };

            const clampToTwoLines = (value) => {
                const lines = normalizeNewlines(value).split('\n');
                return lines.slice(0, 2).join('\n');
            };

            const bindTwoLineTextarea = (el) => {
                if (!el) return;

                const applyClamp = () => {
                    const before = String(el.value ?? '');
                    const after = clampToTwoLines(before);
                    if (before === after) return;

                    const pos = (typeof el.selectionStart === 'number') ? el.selectionStart : after.length;
                    el.value = after;
                    try {
                        const nextPos = Math.min(after.length, pos);
                        el.setSelectionRange(nextPos, nextPos);
                    } catch (_) {
                        // ignore
                    }
                };

                el.addEventListener('keydown', (e) => {
                    if (e.key !== 'Enter') return;
                    const lines = clampToTwoLines(el.value).split('\n');
                    if (lines.length >= 2) {
                        e.preventDefault();
                    }
                });

                el.addEventListener('input', applyClamp);
                el.addEventListener('paste', () => setTimeout(applyClamp, 0));
                applyClamp();
            };

            bindTwoLineTextarea(document.getElementById('contactAddress'));

            document.getElementById('contactForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const ensureMaxTwoLines = (value) => {
                    const lines = String(value ?? '')
                        .replace(/\r\n/g, '\n')
                        .replace(/\r/g, '\n')
                        .split('\n');
                    return lines.length <= 2;
                };

                const user = await window.auth.getCurrentUser();
                if (!user) {
                    showAlert('You are not logged in.', { iconType: 'error' });
                    return;
                }

                const rawAddress = document.getElementById('contactAddress').value;
                if (!ensureMaxTwoLines(rawAddress)) {
                    showAlert('Address can be max 2 lines (receipt size constraint).', { iconType: 'warning' });
                    return;
                }

                const payload = {
                    user_id: user.id,
                    name: document.getElementById('contactName').value.trim(),
                    email: document.getElementById('contactEmail').value.trim() || null,
                    address: rawAddress.trim() || null,
                    phone: document.getElementById('contactOtherId')?.value?.trim() || null
                };

                if (!payload.name) {
                    showAlert('Name is required.', { iconType: 'warning' });
                    return;
                }

                try {
                    if (mode === 'new') {
                        const res = await window.db.contacts.create(payload);
                        if (!res || !res.success || !res.data) {
                            showAlert(res?.error || 'Failed to create contact.', { iconType: 'error' });
                            return;
                        }
                        window.location.href = `spendnote-contact-detail.html?contactId=${encodeURIComponent(String(res.data.id))}`;
                        return;
                    }

                    const id = resolvedContactUuid || (isUuid(contactId) ? contactId : null);
                    if (!id) {
                        showAlert('Invalid contact id.', { iconType: 'error' });
                        return;
                    }

                    const res = await window.db.contacts.update(id, payload);
                    if (!res || !res.success || !res.data) {
                        showAlert(res?.error || 'Failed to update contact.', { iconType: 'error' });
                        return;
                    }
                    window.location.reload();
                } catch (err) {
                    console.error('Contact save failed:', err);
                    showAlert(err?.message || 'Failed to save contact.', { iconType: 'error' });
                }
            });
        }, { once: true });
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260211-1635"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/nav-loader.js?v=8"></script>
    <script>loadNav();</script>
    
    <script src="assets/js/main.js?v=21"></script>
</body>
</html>
