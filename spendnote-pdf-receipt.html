<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cash Receipt</title>
  <style>
    @page { 
      size: A4; 
      margin: 20mm; 
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Arial, sans-serif;
      color: #000;
      background: #ffffff;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }
    
    .receipt {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 48px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
      position: relative;
    }

    /* VOID WATERMARK */
    .void-watermark {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotate(-18deg);
      font-size: 120px;
      font-weight: 900;
      letter-spacing: 6px;
      color: rgba(120, 120, 120, 0.12);
      text-transform: uppercase;
      pointer-events: none;
      user-select: none;
      z-index: 3;
      display: none;
    }
    
    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 24px;
      margin-bottom: 24px;
      border-bottom: 4px solid #059669;
    }
    
    .header-left {
      flex: 1;
    }
    
    .title {
      font-size: 32px;
      font-weight: 900;
      color: #000;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    
    .meta {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
    
    .header-right {
      text-align: right;
    }
    
    .identifiers {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .identifiers strong {
      color: #000;
      font-weight: 700;
    }
    
    .logo {
      width: 64px;
      height: 64px;
      margin-left: auto;
    }
    
    /* PARTIES */
    .parties {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 32px;
    }
    
    .party-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #999;
      margin-bottom: 12px;
    }
    
    .party-name {
      font-size: 16px;
      font-weight: 800;
      color: #000;
      margin-bottom: 8px;
    }
    
    .party-info {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }
    
    .party-id {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    /* TABLE */
    .table-section {
      margin-bottom: 32px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #059669;
      color: white;
    }
    
    th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    th.amount,
    th.amount-header {
      text-align: right;
      width: 120px;
    }
    
    td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    td.amount {
      text-align: right;
      font-weight: 700;
      color: #000;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    /* TOTAL */
    .total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      color: white;
      border-radius: 8px;
      margin-bottom: 32px;
    }
    
    .total-label {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .total-amount {
      font-size: 36px;
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    
    /* NOTES */
    .notes {
      padding: 20px;
      background: #f0f9ff;
      border-left: 4px solid #059669;
      border-radius: 4px;
      margin-bottom: 32px;
    }
    
    .notes-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin-bottom: 8px;
    }
    
    .notes-text {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
    }
    
    /* SIGNATURES */
    .signatures {
      display: flex;
      justify-content: space-between;
      gap: 48px;
      margin-bottom: 32px;
    }
    
    .signature {
      flex: 1;
    }
    
    .signature-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 24px;
    }
    
    .signature-line {
      border-top: 1px solid #000;
    }
    
    /* FOOTER */
    .footer {
      border-top: 2px solid #e0e0e0;
      padding-top: 24px;
      text-align: center;
    }
    
    .footer-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .footer-brand svg {
      width: 24px;
      height: 24px;
    }
    
    .footer-brand span {
      font-size: 14px;
      font-weight: 700;
      color: #000;
    }
    
    .footer-disclaimer {
      font-size: 12px;
      color: #999;
      line-height: 1.6;
    }
    
    /* PRINT */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .receipt {
        box-shadow: none;
        border-radius: 0;
        padding: 0;
        max-width: 100%;
      }
    }
    
    /* SCREEN */
    @media screen {
      body {
        background: #f5f5f5;
      }
    }
  </style></head>
<body>
  <div class="receipt">
    <div class="void-watermark" aria-hidden="true">VOID</div>
    
    <!-- HEADER -->
    <div class="header">
      <div class="header-left">
        <div class="title">Cash Receipt</div>
        <div class="meta">
          <span class="recorded-by">Recorded by: —</span><br>
          <span class="receipt-date">Date: —</span>
        </div>
      </div>
      <div class="header-right">
        <div class="identifiers">
          <strong class="register-id">Cash Box ID:</strong> <span class="register-id">—</span><br>
          <strong class="receipt-id-line">Receipt ID:</strong> <span class="receipt-id-line">—</span><br>
        </div>
        <svg class="logo" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#pdf-logo-gradient)"/>
          <path d="M32 4 L38 10 L32 10 Z" fill="#000" opacity="0.1"/>
          <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
          <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
          <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
          <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
          <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="pdf-logo-gradient" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#059669"/>
              <stop offset="100%" stop-color="#10b981"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>

    <!-- PARTIES -->
    <div class="parties">
      <div>
        <div class="party-label">From</div>
        <div class="party-name company-name">—</div>
        <div class="party-info company-address from-address"></div>
        <div class="party-id company-id"></div>
      </div>
      <div>
        <div class="party-label">To</div>
        <div class="party-name contact-name">—</div>
        <div class="party-info contact-address to-address"></div>
        <div class="party-id contact-id"></div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-section">
      <table>
        <thead>
          <tr>
            <th class="description-header">Description</th>
            <th class="amount-header">Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
          <tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>
        </tbody>
      </table>
    </div>

    <!-- TOTAL -->
    <div class="total">
      <div class="total-label">Total handed over</div>
      <div class="total-amount">—</div>
    </div>

    <!-- NOTES -->
    <div class="notes" style="display:none;">
      <div class="notes-label">Notes</div>
      <div class="notes-text"></div>
    </div>

    <!-- SIGNATURES -->
    <div class="signatures">
      <div class="signature">
        <div class="signature-label">Issued by</div>
        <div class="signature-line"></div>
      </div>
      <div class="signature">
        <div class="signature-label">Received by</div>
        <div class="signature-line"></div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <div class="custom-footer-note" style="display: none; text-align: center; font-size: 13px; color: #666; margin-bottom: 16px; font-style: italic;"></div>
      <div class="footer-brand">
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#pdf-gradient)"/>
          <path d="M32 4 L38 10 L32 10 Z" fill="#000" opacity="0.1"/>
          <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
          <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
          <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
          <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
          <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="pdf-gradient" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#059669"/>
              <stop offset="100%" stop-color="#10b981"/>
            </linearGradient>
          </defs>
        </svg>
        <span>SpendNote</span>
      </div>
      <div class="footer-disclaimer">
        Proof of cash handoff. Not a tax document.<br>
        2026 SpendNote. All rights reserved.
      </div>
    </div>

  </div>

  <script>
const urlParams = new URLSearchParams(window.location.search);
const itemsMode = String(urlParams.get('itemsMode') || '').toLowerCase();
const isItemsSingle = itemsMode === 'single';

const initialVoid = urlParams.get('void') === '1';
window.__spendnoteReceiptVoid = initialVoid;
if (initialVoid) {
  document.querySelectorAll('.void-watermark').forEach((el) => (el.style.display = 'block'));
}

const resolveLogoUrl = () => {
  const logoKey = urlParams.get('logoKey');
  const logoUrl = urlParams.get('logoUrl');
  if (logoUrl) return logoUrl;
  if (logoKey) {
    try {
      return localStorage.getItem(logoKey) || '';
    } catch (_) {
      return '';
    }
  }
  return '';
};

// Custom text replacements
const receiptTitle = urlParams.get('receiptTitle');
const totalLabel = urlParams.get('totalLabel');
const fromLabel = urlParams.get('fromLabel');
const toLabel = urlParams.get('toLabel');
const descriptionLabel = urlParams.get('descriptionLabel');
const amountLabel = urlParams.get('amountLabel');
const notesLabel = urlParams.get('notesLabel');
const issuedByLabel = urlParams.get('issuedByLabel');
const receivedByLabel = urlParams.get('receivedByLabel');
const footerNote = urlParams.get('footerNote');

if (receiptTitle) {
    document.querySelectorAll('.title').forEach(el => el.textContent = receiptTitle);
}
if (totalLabel) {
    document.querySelectorAll('.total-label').forEach(el => el.textContent = totalLabel);
}
if (fromLabel) {
    document.querySelectorAll('.party-label').forEach((el, index) => {
        if (index === 0) el.textContent = fromLabel;
    });
}
if (toLabel) {
    document.querySelectorAll('.party-label').forEach((el, index) => {
        if (index === 1) el.textContent = toLabel;
    });
}
if (descriptionLabel) {
    document.querySelectorAll('.description-header').forEach(el => el.textContent = descriptionLabel);
}
if (amountLabel) {
    document.querySelectorAll('.amount-header').forEach(el => el.textContent = amountLabel);
}
if (notesLabel) {
    document.querySelectorAll('.notes-label').forEach(el => el.textContent = notesLabel);
}
if (issuedByLabel) {
    document.querySelectorAll('.signature-label').forEach((el, index) => {
        if (index === 0) el.textContent = issuedByLabel;
    });
}
if (receivedByLabel) {
    document.querySelectorAll('.signature-label').forEach((el, index) => {
        if (index === 1) el.textContent = receivedByLabel;
    });
}
if (footerNote) {
    const footerNoteEl = document.querySelector('.custom-footer-note');
    if (footerNoteEl) {
        footerNoteEl.textContent = footerNote;
        footerNoteEl.style.display = 'block';
    }
}

const txIdParam = urlParams.get('txId');
const isDemo = urlParams.get('demo') === '1' && !txIdParam;
if (isDemo) {
  function safeText(value, fallback) {
    const v = value === undefined || value === null ? '' : String(value);
    return v.trim() ? v : (fallback || '');
  }

  function setTextAll(selector, text) {
    document.querySelectorAll(selector).forEach((el) => {
      el.textContent = text;
    });
  }

  function setHtmlAll(selector, html) {
    document.querySelectorAll(selector).forEach((el) => {
      el.innerHTML = html;
    });
  }

  function formatMoney(amount, currency) {
    const n = Number(amount);
    const v = Number.isFinite(n) ? n : 0;
    try {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD' }).format(v);
    } catch (_) {
      return `$${v.toFixed(2)}`;
    }
  }

  const demoCompany = safeText(urlParams.get('demoCompany'), 'Acme Corporation');
  const demoAddress = safeText(urlParams.get('demoAddress'), '123 Main St\nSpringfield, IL 62701');
  const demoCompanyId = safeText(urlParams.get('demoCompanyId'), '');

  const demoContact = safeText(urlParams.get('demoContact'), 'John Doe');
  const demoContactAddress = safeText(urlParams.get('demoContactAddress'), '456 Oak Ave\nSpringfield, IL 62704');
  const demoContactId = safeText(urlParams.get('demoContactId'), '');

  const demoDate = safeText(urlParams.get('demoDate'), 'Jan 15, 2026');
  const demoCashBoxId = safeText(urlParams.get('demoCashBoxId'), 'SN-001');
  const demoReceiptId = safeText(urlParams.get('demoReceiptId'), 'SN1-042');
  const demoCreatedBy = safeText(urlParams.get('demoCreatedBy'), 'Alex Johnson');

  const demoCurrency = safeText(urlParams.get('demoCurrency'), 'USD');
  const demoAmount = Number(urlParams.get('demoAmount'));
  const demoNote = safeText(urlParams.get('demoNote'), '');

  setTextAll('span.register-id', demoCashBoxId || '—');
  setTextAll('span.receipt-id-line', demoReceiptId || '—');
  document.querySelectorAll('.recorded-by').forEach((el) => {
    el.textContent = '';
    el.style.display = 'none';
  });
  setTextAll('.receipt-date', `Date: ${demoDate || '—'}`);

  setTextAll('.company-name', demoCompany);
  setTextAll('.contact-name', demoContact);

  const addressToHtml = (raw) => {
    const value = safeText(raw, '');
    if (!value) return '';
    if (value.includes('|')) {
      const idx = value.indexOf('|');
      const first = safeText(value.slice(0, idx), '').trim();
      const rest = safeText(value.slice(idx + 1), '').trim();
      return rest ? `${first}<br>${rest}` : first;
    }
    if (value.includes('\n')) {
      return value
        .split(/\r?\n/)
        .map((l) => safeText(l, ''))
        .filter(Boolean)
        .slice(0, 2)
        .join('<br>');
    }
    const idx = value.indexOf(',');
    if (idx === -1) return value;
    const first = safeText(value.slice(0, idx), '');
    const rest = safeText(value.slice(idx + 1), '');
    return rest ? `${first}<br>${rest}` : first;
  };

  const companyAddressHtml = addressToHtml(demoAddress);
  const contactAddressHtml = addressToHtml(demoContactAddress);

  setHtmlAll('.company-address', companyAddressHtml);
  setHtmlAll('.contact-address', contactAddressHtml);
  document.querySelectorAll('.company-address, .contact-address').forEach((el) => (el.style.display = ''));

  if (demoCompanyId) {
    setTextAll('.company-id', demoCompanyId);
    document.querySelectorAll('.company-id').forEach((el) => (el.style.display = ''));
  }
  if (demoContactId) {
    setTextAll('.contact-id', demoContactId);
    document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = ''));
  }

  const rawItems = safeText(urlParams.get('demoItems'), '');
  const items = rawItems
    .split(';')
    .map((chunk) => chunk.trim())
    .filter(Boolean)
    .map((chunk) => {
      const [desc, amt] = chunk.split('|');
      return {
        description: safeText(desc, ''),
        amount: Number(amt)
      };
    })
    .filter((it) => it.description || Number.isFinite(it.amount));

  const totalValue = Number.isFinite(demoAmount)
    ? demoAmount
    : items.reduce((sum, it) => sum + (Number.isFinite(it.amount) ? it.amount : 0), 0);

  const rowsSource = (() => {
    const fallback = items.length ? items : [{ description: '—', amount: totalValue }];
    if (!isItemsSingle) return fallback.slice(0, 5);
    const firstDesc = safeText(fallback[0]?.description, '—');
    return [{ description: firstDesc, amount: totalValue }];
  })();

  const rows = rowsSource.map((it) => {
    const amount = Number.isFinite(Number(it.amount)) ? formatMoney(Number(it.amount), demoCurrency) : '';
    return `<tr><td>${safeText(it.description, '&nbsp;')}</td><td class="amount">${amount}</td></tr>`;
  });

  while (rows.length < 5) {
    rows.push('<tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>');
  }

  const tbody = document.querySelector('.table-section tbody');
  if (tbody) tbody.innerHTML = rows.join('');

  const totalEl = document.querySelector('.total-amount');
  if (totalEl) totalEl.textContent = formatMoney(totalValue, demoCurrency);

  const notesEl = document.querySelector('.notes');
  const notesTextEl = document.querySelector('.notes-text');
  if (!demoNote) {
    if (notesEl) notesEl.style.display = 'none';
  } else {
    if (notesTextEl) notesTextEl.textContent = demoNote;
    if (notesEl) notesEl.style.display = '';
  }
}

// Logo
if (urlParams.get('logo') === '0') {
    document.querySelectorAll('.logo, .logo-box, .logo-img, .sn-logo').forEach(el => el.style.display = 'none');
} else {
    const logo = resolveLogoUrl();
    if (logo) {
        const svgLogo = document.querySelector('svg.logo');
        if (svgLogo && svgLogo.parentNode) {
            const img = document.createElement('img');
            img.className = 'logo';
            img.alt = 'Company logo';
            img.src = logo;
            svgLogo.parentNode.replaceChild(img, svgLogo);
        }
    }
}

// Addresses (FROM and TO addresses, but keep names visible)
if (urlParams.get('addresses') === '0') {
    document.querySelectorAll('.from-address, .to-address, .party-address, .company-address, .contact-address').forEach(el => el.style.display = 'none');
}

// Tracking Details (Receipt ID, Cash Box ID, Recorded by)
if (urlParams.get('tracking') === '0') {
    document.querySelectorAll('.identifiers, .receipt-ids, .recorded-by, .register-id, .receipt-id').forEach(el => el.style.display = 'none');
}

// Recorded-by (independent)
if (urlParams.get('recordedBy') === '0') {
    document.querySelectorAll('.recorded-by').forEach(el => el.style.display = 'none');
}

// Additional Info (two custom info lines)
if (urlParams.get('additional') === '0') {
    document.querySelectorAll('.additional-info, .custom-info, .extra-info, .company-id, .contact-id').forEach(el => el.style.display = 'none');
}

// Note
if (urlParams.get('note') === '0') {
    document.querySelectorAll('.notes').forEach(el => el.style.display = 'none');
}

// Signatures
if (urlParams.get('signatures') === '0') {
    document.querySelectorAll('.signatures').forEach(el => el.style.display = 'none');
}
  </script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-config.js?v=22"></script>
  <script src="assets/js/auth-guard.js"></script>
  
  <script src="assets/js/main.js"></script>

  <script>
    (async function () {
      const txId = new URLSearchParams(window.location.search).get('txId');
      if (!txId) return;

      const overrideContactAddress = String(new URLSearchParams(window.location.search).get('overrideContactAddress') || '').trim();

      function safeText(value, fallback) {
        const v = value === undefined || value === null ? '' : String(value);
        return v.trim() ? v : (fallback || '');
      }

      function getDisplayId(tx) {
        const cbSeq = tx?.cash_box_sequence;
        const txSeq = tx?.tx_sequence_in_box;
        if (cbSeq && txSeq) {
          const txSeqStr = String(txSeq).padStart(3, '0');
          return `SN${cbSeq}-${txSeqStr}`;
        }
        const receipt = safeText(tx?.receipt_number, '');
        if (receipt) return receipt;
        const id = safeText(tx?.id, '');
        if (!id) return '';
        return id.length > 10 ? `${id.slice(0, 8)}…` : id;
      }

      function getCashBoxCode(tx) {
        const cbSeq = Number(tx?.cash_box?.sequence_number || tx?.cash_box_sequence);
        if (Number.isFinite(cbSeq) && cbSeq > 0) {
          return `SN-${String(cbSeq).padStart(3, '0')}`;
        }
        return '';
      }

      function formatDateShort(value) {
        const dt = value ? new Date(value) : null;
        if (!dt || Number.isNaN(dt.getTime())) return '';
        return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function setTextAll(selector, text) {
        document.querySelectorAll(selector).forEach((el) => {
          el.textContent = text;
        });
      }

      function setHtmlAll(selector, html) {
        document.querySelectorAll(selector).forEach((el) => {
          el.innerHTML = html;
        });
      }

      function addressToHtml(raw) {
        const value = safeText(raw, '');
        if (!value) return '';
        if (value.includes('|')) {
          const idx = value.indexOf('|');
          const first = safeText(value.slice(0, idx), '').trim();
          const rest = safeText(value.slice(idx + 1), '').trim();
          return rest ? `${first}<br>${rest}` : first;
        }
        if (value.includes('\n')) {
          return value
            .split(/\r?\n/)
            .map((l) => safeText(l, ''))
            .filter(Boolean)
            .slice(0, 2)
            .join('<br>');
        }
        const idx = value.indexOf(',');
        if (idx === -1) return value;
        const first = safeText(value.slice(0, idx), '');
        const rest = safeText(value.slice(idx + 1), '');
        return rest ? `${first}<br>${rest}` : first;
      }

      // Immediately clear demo placeholders so they never show up in the preview
      setTextAll('.company-name', '—');
      setTextAll('.contact-name', '—');
      setHtmlAll('.company-address', '');
      setHtmlAll('.contact-address', '');
      document.querySelectorAll('.company-address, .contact-address').forEach((el) => (el.style.display = 'none'));
      setTextAll('.company-id', '');
      document.querySelectorAll('.company-id').forEach((el) => (el.style.display = 'none'));

      setTextAll('.contact-id', '');
      document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = 'none'));
      setTextAll('span.register-id', '—');
      setTextAll('span.receipt-id-line', '—');
      const tbodyInit = document.querySelector('.table-section tbody');
      if (tbodyInit) tbodyInit.innerHTML = '<tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>'.repeat(5);
      const totalInit = document.querySelector('.total-amount');
      if (totalInit) totalInit.textContent = '—';
      const notesInit = document.querySelector('.notes');
      if (notesInit) notesInit.style.display = 'none';

      function formatMoney(amount, currency) {
        const sn = (typeof window !== 'undefined' && window.SpendNote) ? window.SpendNote : null;
        if (sn && typeof sn.formatCurrency === 'function') {
          return sn.formatCurrency(amount, currency);
        }
        try {
          return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD' }).format(Number(amount) || 0);
        } catch (_) {
          return `$${(Number(amount) || 0).toFixed(2)}`;
        }
      }

      function renderItems(tx, currency) {
        const raw = Array.isArray(tx?.line_items) ? tx.line_items : [];
        const items = raw
          .map((it) => ({
            description: safeText(it?.description, ''),
            amount: Number(it?.amount)
          }))
          .filter((it) => it.description || Number.isFinite(it.amount));

        const fallbackDesc = safeText(tx?.description, '—');
        const fallbackAmt = Number(tx?.amount);

        const effective = isItemsSingle
          ? [{ description: fallbackDesc, amount: fallbackAmt }]
          : (items.length ? items : [{ description: fallbackDesc, amount: fallbackAmt }]);

        const fillRows = isItemsSingle ? 1 : 5;
        const maxRows = 5;
        const rows = effective.slice(0, fillRows).map((it) => {
          const desc = safeText(it.description, '—');
          const amt = formatMoney(it.amount, currency);
          return `<tr><td>${desc}</td><td class="amount">${amt}</td></tr>`;
        });
        while (rows.length < maxRows) {
          rows.push('<tr><td>&nbsp;</td><td class="amount">&nbsp;</td></tr>');
        }

        const tbody = document.querySelector('.table-section tbody');
        if (tbody) tbody.innerHTML = rows.join('');

        const total = Number.isFinite(Number(tx?.amount)) ? Number(tx.amount) : 0;
        const totalEl = document.querySelector('.total-amount');
        if (totalEl) totalEl.textContent = formatMoney(total, currency);
      }

      const waitForDb = async () => {
        for (let i = 0; i < 200; i++) {
          if (window.db?.transactions?.getById) return true;
          await new Promise((r) => setTimeout(r, 50));
        }
        return false;
      };

      try {
        const ok = await waitForDb();
        if (!ok) return;

        const tx = await window.db.transactions.getById(txId);
        if (!tx) return;

        const shouldShowVoid = Boolean(window.__spendnoteReceiptVoid) || String(tx?.status || 'active').toLowerCase() === 'voided';
        document.querySelectorAll('.void-watermark').forEach((el) => (el.style.display = shouldShowVoid ? 'block' : 'none'));

        try {
          if (( !tx.cash_box || tx.cash_box?.sequence_number === undefined || tx.cash_box?.sequence_number === null) && tx.cash_box_id && window.db?.cashBoxes?.getById) {
            tx.cash_box = await window.db.cashBoxes.getById(tx.cash_box_id);
          }
        } catch (_) {}

        try {
          const hasContactAddress = Boolean(overrideContactAddress || String(tx?.contact_address || tx?.contact?.address || '').trim());
          if (!hasContactAddress && tx.contact_id && window.db?.contacts?.getById) {
            tx.contact = await window.db.contacts.getById(tx.contact_id);
          }
        } catch (_) {}

        const displayId = getDisplayId(tx);
        const cashBoxCode = getCashBoxCode(tx);
        const createdBy = safeText(tx.created_by_user_name || tx.created_by, '—');
        const txDate = tx.transaction_date || tx.created_at;
        const contactName = safeText(tx.contact_name || tx.contact?.name, '—');
        const contactAddress = overrideContactAddress || safeText(tx.contact_address || tx.contact?.address, '');
        const contactOtherId = safeText(tx.contact_custom_field_1, '');

        const currency = safeText(tx.cash_box?.currency, 'USD');

        let profile = null;
        try {
          profile = window.db?.profiles?.getCurrent ? await window.db.profiles.getCurrent() : null;
        } catch (_) {
          profile = null;
        }

        const companyName = safeText(profile?.company_name || profile?.full_name || tx.cash_box?.name, '—');
        const companyAddress = safeText(profile?.address, '');

        setTextAll('span.register-id', cashBoxCode || '—');
        setTextAll('span.receipt-id-line', displayId || '—');

        setTextAll('.recorded-by', `Recorded by: ${createdBy}`);
        const d = formatDateShort(txDate);
        if (d) setTextAll('.receipt-date', `Date: ${d}`);

        setTextAll('.contact-name', contactName || '—');
        if (contactAddress) {
          setHtmlAll('.contact-address', addressToHtml(contactAddress));
          document.querySelectorAll('.contact-address').forEach((el) => (el.style.display = ''));
        } else {
          setHtmlAll('.contact-address', '');
          document.querySelectorAll('.contact-address').forEach((el) => (el.style.display = 'none'));
        }

        setTextAll('.company-name', companyName);
        if (companyAddress) {
          setHtmlAll('.company-address', addressToHtml(companyAddress));
          document.querySelectorAll('.company-address').forEach((el) => (el.style.display = ''));
        } else {
          setHtmlAll('.company-address', '');
          document.querySelectorAll('.company-address').forEach((el) => (el.style.display = 'none'));
        }

        renderItems(tx, currency);

        const notesText = safeText(tx.notes, '');
        const notesWrap = document.querySelector('.notes');
        const notesEl = document.querySelector('.notes-text');
        if (notesWrap) {
          if (!notesText) {
            notesWrap.style.display = 'none';
          } else if (notesEl) {
            notesEl.textContent = notesText;
            notesWrap.style.display = '';
          }
        }

        // company-id is not a cash box id; keep hidden unless a real company identifier exists.
        setTextAll('.company-id', '');
        document.querySelectorAll('.company-id').forEach((el) => (el.style.display = 'none'));

        if (contactOtherId) {
          setTextAll('.contact-id', contactOtherId);
          document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = ''));
        } else {
          setTextAll('.contact-id', '');
          document.querySelectorAll('.contact-id').forEach((el) => (el.style.display = 'none'));
        }

        if (displayId) {
          document.title = displayId;
        }
      } catch (_) {
        // ignore
      }
    })();
  </script>
</body>
</html>
