<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Log in to your SpendNote account.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Log In - SpendNote</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=23">
    <style>
        /* ===== LOGIN PAGE SPECIFIC STYLES ===== */
        
        /* AUTH CONTAINER */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 4px 24px var(--shadow);
        }

        /* LOGO */
        .auth-logo {
            text-align: center;
            margin-bottom: 16px;
        }

        .logo-mark {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .logo-mark svg {
            width: 32px;
            height: 32px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 900;
            color: var(--text);
            letter-spacing: -0.03em;
        }

        /* HEADER */
        .auth-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .auth-title {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }

        .auth-subtitle {
            color: var(--text-muted);
            font-size: 13px;
        }

        /* FORM */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* CHECKBOX */
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .checkbox-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text);
            font-weight: 500;
        }

        .forgot-link {
            font-size: 14px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .forgot-link:hover {
            text-decoration: underline;
        }

        /* BUTTON */
        /* DIVIDER */
        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 14px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider-text {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* SOCIAL BUTTONS */
        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-social {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-social:hover {
            border-color: var(--text);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-social i {
            font-size: 18px;
        }

        .btn-google {
            background: white;
            color: #1f2937;
            border-color: var(--border);
            border-width: 2px;
        }

        .btn-google:hover {
            background: var(--surface-elevated);
            border-color: #d1d5db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* FOOTER LINK */
        .auth-footer {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* ERROR MESSAGE */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--error);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* SUCCESS MESSAGE */
        .success-message {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--success);
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .password-field {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            padding: 6px;
            line-height: 1;
        }

        .password-toggle:hover {
            color: var(--text);
        }

        /* RESPONSIVE */
        @media (max-width: 640px) {
            .auth-card {
                padding: 32px 24px;
            }

            .auth-title {
                font-size: 24px;
            }
        }
    </style></head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- Logo -->
            <div class="auth-logo">
                <a href="/" class="logo-mark">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#logo-gradient)"/>
                        <path d="M32 4 L38 10 L32 10 Z" fill="#000000" opacity="0.25"/>
                        <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
                        <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="logo-gradient" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#059669"/>
                                <stop offset="100%" stop-color="#10b981"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="logo-text">SpendNote</span>
                </a>
            </div>

            <!-- Header -->
            <div class="auth-header">
                <h1 class="auth-title">Welcome back</h1>
                <p class="auth-subtitle">Log in to your SpendNote account</p>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> Error message will appear here
            </div>

            <div class="success-message" id="resendWrap" style="display:none; margin-top: 10px;">
                <i class="fas fa-envelope"></i> Please confirm your email to continue.
                <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;">
                    <button type="button" class="btn btn-secondary" id="resendBtn">Resend confirmation email</button>
                </div>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> Logged in! Redirecting...
            </div>

            <!-- Form -->
            <form class="auth-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        class="form-input" 
                        placeholder="you@example.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <div class="password-field">
                        <input 
                            type="password" 
                            id="password" 
                            class="form-input" 
                            placeholder="Enter your password"
                            required
                        >
                        <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-left">
                        <input 
                            type="checkbox" 
                            id="remember" 
                            class="checkbox-input"
                        >
                        <label class="checkbox-label" for="remember">
                            Remember me
                        </label>
                    </div>
                    <a href="spendnote-forgot-password.html" class="forgot-link">Forgot password?</a>
                </div>

                <button type="submit" class="btn btn-primary">
                    Log in
                </button>
            </form>

            <!-- Divider -->
            <div class="divider">
                <span class="divider-text">Or continue with</span>
            </div>

            <!-- Social Buttons -->
            <div class="social-buttons">
                <button type="button" class="btn-social btn-google" id="googleBtn">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.64 9.20454C17.64 8.56636 17.5827 7.95272 17.4764 7.36363H9V10.845H13.8436C13.635 11.97 13.0009 12.9231 12.0477 13.5613V15.8195H14.9564C16.6582 14.2527 17.64 11.9454 17.64 9.20454Z" fill="#4285F4"/>
                        <path d="M9 18C11.43 18 13.4673 17.1941 14.9564 15.8195L12.0477 13.5613C11.2418 14.1013 10.2109 14.4204 9 14.4204C6.65591 14.4204 4.67182 12.8372 3.96409 10.71H0.957275V13.0418C2.43818 15.9831 5.48182 18 9 18Z" fill="#34A853"/>
                        <path d="M3.96409 10.71C3.78409 10.17 3.68182 9.59318 3.68182 9C3.68182 8.40682 3.78409 7.83 3.96409 7.29V4.95818H0.957275C0.347727 6.17318 0 7.54772 0 9C0 10.4523 0.347727 11.8268 0.957275 13.0418L3.96409 10.71Z" fill="#FBBC05"/>
                        <path d="M9 3.57955C10.3214 3.57955 11.5077 4.03364 12.4405 4.92545L15.0218 2.34409C13.4632 0.891818 11.4259 0 9 0C5.48182 0 2.43818 2.01682 0.957275 4.95818L3.96409 7.29C4.67182 5.16273 6.65591 3.57955 9 3.57955Z" fill="#EA4335"/>
                    </svg>
                    Log in with Google
                </button>
            </div>

            <!-- Footer -->
            <div class="auth-footer">
                Don't have an account? <a href="spendnote-signup.html">Sign up</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260216-2236"></script>
    <script>
        const ensureProfile = async () => {
            try {
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error || !user) return;

                try {
                    const { data: existing, error: selErr } = await window.supabaseClient
                        .from('profiles')
                        .select('id')
                        .eq('id', user.id)
                        .single();
                    if (!selErr && existing?.id) return;
                } catch (_) {}

                const email = String(user.email || '').trim();
                const fullName = String(user.user_metadata?.full_name || '').trim() || (email ? email.split('@')[0] : 'User');
                if (!email) return;

                try {
                    await window.supabaseClient
                        .from('profiles')
                        .insert([{ id: user.id, email, full_name: fullName }]);
                } catch (_) {}
            } catch (_) {}
        };

        const acceptInviteToken = async (inviteToken) => {
            if (!inviteToken || !window.supabaseClient?.rpc) {
                console.warn('[login-invite] skip: no token or no rpc');
                return;
            }
            console.warn('[login-invite] acceptInviteToken called, token length=' + inviteToken.length);
            try {
                await ensureProfile();
                console.warn('[login-invite] ensureProfile done');
            } catch (ep) { console.warn('[login-invite] ensureProfile err:', ep); }
            try {
                console.warn('[login-invite] calling v2...');
                const r = await window.supabaseClient.rpc('spendnote_accept_invite_v2', { p_token: inviteToken });
                console.warn('[login-invite] v2 result:', JSON.stringify({ data: r?.data, error: r?.error }));
                if (r?.error) throw r.error;
                console.warn('[login-invite] SUCCESS v2');
            } catch (e1) {
                console.error('[login-invite] v2 failed:', e1?.message || e1);
                try {
                    const r2 = await window.supabaseClient.rpc('spendnote_accept_invite', { p_token: inviteToken });
                    console.warn('[login-invite] fallback result:', JSON.stringify({ data: r2?.data, error: r2?.error }));
                    if (r2?.error) throw r2.error;
                    console.warn('[login-invite] SUCCESS fallback');
                } catch (e2) {
                    console.error('[login-invite] BOTH FAILED v2:', e1?.message || e1, 'fb:', e2?.message || e2);
                }
            }
        };

        // Form submission
        const loginForm = document.getElementById('loginForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const resendWrap = document.getElementById('resendWrap');
        const resendBtn = document.getElementById('resendBtn');

        let lastAttemptEmail = '';
        const DEFAULT_POST_LOGIN_PATH = '/app';

        const getSafeReturnTo = () => {
            try {
                const sp = new URLSearchParams(window.location.search);
                const raw = String(sp.get('returnTo') || '').trim();
                if (!raw) return DEFAULT_POST_LOGIN_PATH;
                if (!raw.startsWith('/') || raw.startsWith('//')) return DEFAULT_POST_LOGIN_PATH;

                const lowered = raw.toLowerCase();
                if (lowered === '/' || lowered.startsWith('/login') || lowered.startsWith('/spendnote-login')) {
                    return DEFAULT_POST_LOGIN_PATH;
                }
                return raw;
            } catch (_) {
                return DEFAULT_POST_LOGIN_PATH;
            }
        };

        const redirectAfterLogin = () => {
            window.location.href = getSafeReturnTo();
        };

        (async () => {
            try {
                try {
                    const sp0 = new URLSearchParams(window.location.search);
                    if (sp0.get('confirmed') === '1') {
                        try {
                            localStorage.setItem('spendnote.auth.confirmed.v1', String(Date.now()));
                        } catch (_) {}
                    }
                } catch (_) {}
                try {
                    await (window.__spendnoteAuthCallbackPromise || Promise.resolve());
                } catch (_) {
                }
                const user = await window.auth.getCurrentUser();
                if (user) {
                    try {
                        const sp = new URLSearchParams(window.location.search);
                        const inviteToken = sp.get('inviteToken');
                        await acceptInviteToken(inviteToken);
                    } catch (_) {

                    }
                    try {
                        const sp = new URLSearchParams(window.location.search);
                        if (sp.get('confirmed') === '1') {
                            window.location.href = 'spendnote-user-settings.html';
                            return;
                        }
                    } catch (_) {}
                    redirectAfterLogin();
                }
            } catch (_) {

            }
        })();

        (function() {
            try {
                const pw = document.getElementById('password');
                const btn = document.getElementById('passwordToggle');
                if (!pw || !btn) return;
                btn.addEventListener('click', () => {
                    const isPw = pw.getAttribute('type') === 'password';
                    pw.setAttribute('type', isPw ? 'text' : 'password');
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.className = isPw ? 'fas fa-eye-slash' : 'fas fa-eye';
                    }
                });
            } catch (_) {}
        })();

        const isUnconfirmedEmailError = (msg) => {
            const s = String(msg || '').toLowerCase();
            return s.includes('email not confirmed') || (s.includes('confirm') && s.includes('email'));
        };

        if (resendBtn) {
            resendBtn.addEventListener('click', async () => {
                const email = String(lastAttemptEmail || document.getElementById('email')?.value || '').trim();
                if (!email) { showError('Please enter your email first.'); return; }
                try {
                    const sp = new URLSearchParams(window.location.search);
                    const inviteToken = sp.get('inviteToken');
                    const redirectUrl = new URL(`${window.location.origin}/spendnote-login.html`);
                    redirectUrl.searchParams.set('confirmed', '1');
                    redirectUrl.searchParams.set('returnTo', getSafeReturnTo());
                    if (inviteToken) {
                        redirectUrl.searchParams.set('inviteToken', inviteToken);
                    }
                    const emailRedirectTo = redirectUrl.toString();

                    const r = await auth.resendSignupConfirmation(email, { emailRedirectTo });
                    if (!r?.success) {
                        showError(r?.error || 'Failed to resend confirmation email.');
                        return;
                    }
                    if (resendWrap) resendWrap.style.display = 'block';
                    successMessage.classList.add('show');
                    successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Confirmation email sent. Please check your inbox.';
                } catch (_) {
                    showError('Failed to resend confirmation email.');
                }
            });
        }

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Hide messages
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
            if (resendWrap) resendWrap.style.display = 'none';

            // Get form data
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            lastAttemptEmail = String(email || '').trim();

            // Disable button
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                // Sign in with Supabase
                const result = await auth.signIn(email, password);
                
                if (result.success) {
                    try {
                        const sp = new URLSearchParams(window.location.search);
                        const inviteToken = sp.get('inviteToken');
                        await acceptInviteToken(inviteToken);
                    } catch (_) {

                    }

                    // Success
                    successMessage.classList.add('show');
                    successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Logged in! Redirecting...';
                    
                    setTimeout(() => {
                        redirectAfterLogin();
                    }, 1000);
                } else {
                    // Error
                    const msg = result.error || 'Invalid email or password';
                    if (isUnconfirmedEmailError(msg)) {
                        showError('Please confirm your email address, then try again.');
                        if (resendWrap) resendWrap.style.display = 'block';
                        return;
                    }
                    showError(msg);
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        });

        function showError(message) {
            errorMessage.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
            errorMessage.classList.add('show');
            
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Log in';
        }

        // Google login
        document.getElementById('googleBtn').addEventListener('click', async () => {
            try {
                const sp = new URLSearchParams(window.location.search);
                const inviteToken = sp.get('inviteToken');
                const redirectUrl = new URL(`${window.location.origin}/spendnote-login.html`);
                redirectUrl.searchParams.set('returnTo', getSafeReturnTo());
                if (inviteToken) {
                    redirectUrl.searchParams.set('inviteToken', inviteToken);
                }
                const redirectTo = redirectUrl.toString();
                const { data, error } = await window.supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo
                    }
                });
                
                if (error) {
                    showError('Google login failed. Please try again.');
                }
            } catch (error) {
                showError('Google login failed. Please try again.');
            }
        });
    </script>
    <script src="assets/js/main.js?v=21"></script>
</body>
</html>
