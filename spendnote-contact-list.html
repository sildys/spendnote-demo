<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Contact management in SpendNote - manage your transaction Contacts.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Contacts - SpendNote</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=12">
    <link rel="stylesheet" href="assets/css/app-layout.css?v=14">
    <style>
        /* ===== CONTACT LIST PAGE SPECIFIC STYLES ===== */
        
        /* ContactS CARD */
        .Contacts-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            overflow: hidden;
        }

        .Contacts-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .Contacts-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .contacts-header-top {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 18px;
        }

        .contacts-controls {
            display: grid;
            grid-template-columns: 200px 1fr max-content;
            gap: 12px;
            align-items: center;
        }

        .contacts-controls .search-box {
            width: 100%;
            max-width: none;
        }

        .contacts-cashbox-select {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            background: var(--surface);
            cursor: pointer;
            color: var(--text);
        }

        .btn-export {
            padding: 10px 18px;
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            background: var(--bg);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .add-Contact-btn-large {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* TABLE */
        .table-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .Contacts-table {
            min-width: 700px;
            width: 100%;
            border-collapse: collapse;
        }

        .Contacts-table thead {
            background: var(--bg);
        }

        .Contacts-table th {
            padding: 8px 10px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .Contacts-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .Contacts-table th.sortable:hover {
            color: var(--text);
            background: rgba(var(--active-rgb), 0.05);
        }

        .Contacts-table th.sortable i {
            margin-left: 6px;
            font-size: 11px;
            opacity: 0.5;
        }

        .Contacts-table th.sortable.asc i::before {
            content: "\f0de";
            opacity: 1;
            color: var(--active);
        }

        .Contacts-table th.sortable.desc i::before {
            content: "\f0dd";
            opacity: 1;
            color: var(--active);
        }

        .Contacts-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .Contacts-table tbody tr:last-child {
            border-bottom: none;
        }

        .Contacts-table tbody tr:hover {
            background: rgba(var(--active-rgb), 0.06);
        }

        .Contacts-table tbody tr.is-armed {
            background: rgba(var(--active-rgb), 0.10);
            box-shadow: inset 0 0 0 2px rgba(var(--active-rgb), 0.20);
        }

        .Contacts-table td {
            padding: 8px 10px;
            font-size: 13px;
            white-space: nowrap;
        }

        .Contact-name {
            font-weight: 700;
            color: var(--text);
        }

        .Contact-address {
            color: var(--text-muted);
            font-size: 14px;
        }

        .Contact-contact {
            color: var(--text-muted);
            font-size: 13px;
        }

        #selectAllHeader,
        .row-checkbox {
            accent-color: var(--primary);
        }

        .cashbox-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: help;
        }

        .Contact-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .Contacts-table th.col-action,
        .Contacts-table tbody td:last-child {
            text-align: center;
        }

        .tx-action {
            padding: 6px 12px;
            background: white;
            color: var(--primary);
            border: 1px solid rgba(5, 150, 105, 0.25);
            border-radius: 10px;
            font-weight: 800;
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tx-action:hover {
            background: rgba(5, 150, 105, 0.08);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .tx-action i {
            font-size: 11px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-top: 1px solid var(--border);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text);
            display: flex;
            align-items: center;
            font-weight: 500;
            gap: 10px;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        #perPageSelect {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
        }

        #paginationText {
            display: inline-block;
            white-space: nowrap;
        }

        .pagination-info select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 14px;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-btn {
            padding: 8px 16px;
            background: rgba(5, 150, 105, 0.1);
            color: var(--primary);
            border: 1px solid rgba(5, 150, 105, 0.2);
            border-radius: 10px;
            font-weight: 800;
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .action-btn:hover {
            background: rgba(5, 150, 105, 0.2);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        /* ALPHABET NAVIGATION */
        .alphabet-btn {
            padding: 8px 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
        }

        .alphabet-btn:hover {
            background: var(--surface);
            border-color: var(--primary);
            color: var(--text);
        }

        .alphabet-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .alphabet-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .alphabet-btn.disabled:hover {
            background: var(--bg);
            border-color: var(--border);
            color: var(--text-muted);
        }

        /* BULK ACTIONS */
        .bulk-actions {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(var(--active-rgb), 0.08), rgba(var(--active-rgb), 0.03));
            border-left: 3px solid var(--active);
            border-radius: 0;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border);
        }

        .bulk-actions.show {
            display: flex;
        }

        .bulk-actions-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-muted);
        }

        .bulk-actions-text strong {
            color: var(--text);
            font-weight: 700;
        }

        .bulk-actions-text span {
            color: var(--active);
            font-weight: 800;
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 8px;
        }

        .bulk-action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            background: white;
            color: var(--text);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bulk-action-btn:hover {
            background: rgba(var(--active-rgb), 0.1);
            color: var(--active);
        }

        /* EMPTY STATE */
        .empty-state {
            padding: 80px 32px;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 64px;
            color: var(--text-muted);
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 12px;
        }

        .empty-state-text {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 32px;
        }

        /* STICKY ADD TRANSACTION BUTTON */
        .sticky-add-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .sticky-add-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 32px rgba(5, 150, 105, 0.5);
        }

        .sticky-add-btn:active {
            transform: translateY(-2px) scale(1.02);
        }
    </style></head>
<body>
<!-- Navigation loaded dynamically by nav-loader.js -->
<div id="nav-container"></div>

<div class="app-container">
    <main class="main-content">
        <div class="page-header">
            <div class="page-title-group">
                <h1 class="page-title">Contacts</h1>
                <p class="page-subtitle">Manage your transaction Contacts and their contact information</p>
            </div>
        </div>

        <div class="table-container">
        <div class="Contacts-header">
            <div class="contacts-header-top">
                <h2 class="Contacts-title" style="margin: 0;">All Contacts</h2>
                <div class="contacts-controls">
                    <select id="cashBoxFilter" class="contacts-cashbox-select">
                        <option value="">All Cash Boxes</option>
                        <option value="main">Main Office</option>
                        <option value="event">Event Fund</option>
                        <option value="petty">Petty Cash</option>
                    </select>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search Contacts...">
                    </div>
                    <button class="btn btn-primary btn-large add-Contact-btn-large" id="addContactBtn">
                        <i class="fas fa-plus"></i>
                        Add Contact
                    </button>
                </div>
            </div>
            
            <!-- Bulk Actions -->
            <div class="bulk-actions" id="bulkActions">
                <span class="bulk-actions-text"><strong><span id="selectedCount">0</span> selected</strong></span>
                <div class="bulk-actions-buttons">
                    <button class="bulk-action-btn" id="bulkDelete" style="color: var(--error);">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                    <button class="bulk-action-btn" id="bulkExportCSV">
                        <i class="fas fa-file-csv"></i>
                        Export CSV
                    </button>
                    <button class="bulk-action-btn" id="bulkExportPDF">
                        <i class="fas fa-file-pdf"></i>
                        Export PDF
                    </button>
                </div>
            </div>
            
            <!-- Alphabetical Navigation -->
            <div style="padding: 16px 0 0; border-top: 1px solid var(--border); margin-top: 20px;">
                <div id="alphabetNav" style="display: flex; gap: 4px; overflow-x: auto; padding-bottom: 4px;">
                    <button class="alphabet-btn active" data-letter="all">All</button>
                    <button class="alphabet-btn" data-letter="A">A</button>
                    <button class="alphabet-btn" data-letter="B">B</button>
                    <button class="alphabet-btn" data-letter="C">C</button>
                    <button class="alphabet-btn" data-letter="D">D</button>
                    <button class="alphabet-btn" data-letter="E">E</button>
                    <button class="alphabet-btn" data-letter="F">F</button>
                    <button class="alphabet-btn" data-letter="G">G</button>
                    <button class="alphabet-btn" data-letter="H">H</button>
                    <button class="alphabet-btn" data-letter="I">I</button>
                    <button class="alphabet-btn" data-letter="J">J</button>
                    <button class="alphabet-btn" data-letter="K">K</button>
                    <button class="alphabet-btn" data-letter="L">L</button>
                    <button class="alphabet-btn" data-letter="M">M</button>
                    <button class="alphabet-btn" data-letter="N">N</button>
                    <button class="alphabet-btn" data-letter="O">O</button>
                    <button class="alphabet-btn" data-letter="P">P</button>
                    <button class="alphabet-btn" data-letter="Q">Q</button>
                    <button class="alphabet-btn" data-letter="R">R</button>
                    <button class="alphabet-btn" data-letter="S">S</button>
                    <button class="alphabet-btn" data-letter="T">T</button>
                    <button class="alphabet-btn" data-letter="U">U</button>
                    <button class="alphabet-btn" data-letter="V">V</button>
                    <button class="alphabet-btn" data-letter="W">W</button>
                    <button class="alphabet-btn" data-letter="X">X</button>
                    <button class="alphabet-btn" data-letter="Y">Y</button>
                    <button class="alphabet-btn" data-letter="Z">Z</button>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="Contacts-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAllHeader"></th>
                        <th class="sortable" data-column="id" style="width: 100px;">ID <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-column="name" style="width: 200px;">Name <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-column="contact" style="width: 280px;">Contact <i class="fas fa-sort"></i></th>
                        <th style="width: 90px; text-align: center;" title="Cash Boxes">Boxes <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-column="transactions" style="width: 50px; text-align: center;" title="Number of Transactions"># <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-column="date" style="width: 110px;">Last Tx <i class="fas fa-sort"></i></th>
                        <th class="col-action" style="width: 90px;">Action</th>
                    </tr>
                </thead>
                <tbody id="ContactsTableBody"></tbody>
            </table>
        </div>

        <div class="pagination">
            <div class="pagination-info">
                <select id="perPageSelect">
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
                <span id="paginationText">Showing 0-0 of 0</span>
            </div>
            <div class="pagination-controls"></div>
        </div>
    </div>
    </main>
</div>

    <!-- Modern 2-Row Footer -->
<footer class="app-footer">
    <div class="app-footer-container">
        <!-- Top Row -->
        <div class="app-footer-top">
            <!-- Brand Section with Disclaimer -->
            <div class="app-footer-brand">
                <a href="dashboard.html" class="app-footer-brand-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Main body with subtle gray pattern -->
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="white"/>
                        <!-- Folded corner - darker gray -->
                        <path d="M32 4 L38 10 L32 10 Z" fill="rgba(0,0,0,0.15)"/>
                        <!-- Folded corner outline -->
                        <path d="M32 4 L32 10 L38 10" stroke="rgba(0,0,0,0.2)" stroke-width="1.5" stroke-linejoin="round"/>
                        <!-- Receipt lines - light gray -->
                        <line x1="14" y1="14" x2="30" y2="14" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="rgba(0,0,0,0.12)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="rgba(0,0,0,0.1)" stroke-width="2.5" stroke-linecap="round"/>
                        <!-- Bottom zigzag - gray -->
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="rgba(0,0,0,0.2)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>SpendNote</span>
                </a>
                <p class="app-footer-brand-desc">
                    Cash receipt management for modern teams. Simple, secure, transparent.
                </p>
            </div>
            
            <!-- Right: Links + Disclaimer -->
            <div class="app-footer-right">
                <div class="app-footer-links-simple">
                    <a href="index.html#features">Features</a>
                    <a href="spendnote-pricing.html">Pricing</a>
                    <a href="spendnote-faq.html">FAQ</a>
                    <a href="spendnote-terms.html">Legal</a>
                </div>
                
                <!-- Disclaimer on right side -->
                <div class="app-footer-brand-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <span>Cash handoff documentation only. Not a tax or accounting tool.</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row -->
        <div class="app-footer-bottom">
            <div class="app-footer-copyright">
                2026 SpendNote. All rights reserved.
            </div>
        </div>
    </div>
</footer>








    <script>
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('ContactsTableBody');
        const cashBoxFilter = document.getElementById('cashBoxFilter');
        
        searchInput.addEventListener('input', applyFilters);
        cashBoxFilter.addEventListener('change', applyFilters);

        function normalizeHexColor(value, fallback = '#94a3b8') {
            const v = String(value || '').trim();
            if (/^#?[0-9a-f]{6}$/i.test(v)) {
                return v.startsWith('#') ? v : `#${v}`;
            }
            return fallback;
        }

        function formatDateShort(value) {
            const dt = new Date(value || '');
            if (!Number.isFinite(dt.getTime())) return '—';
            return dt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function getTxDisplayId(tx) {
            const cbSeq = Number(tx?.cash_box_sequence);
            const txSeq = Number(tx?.tx_sequence_in_box);
            if (Number.isFinite(cbSeq) && cbSeq > 0 && Number.isFinite(txSeq) && txSeq > 0) {
                return `SN${cbSeq}-${String(txSeq).padStart(3, '0')}`;
            }
            const receiptNumber = String(tx?.receipt_number || '').trim();
            if (receiptNumber) return receiptNumber;
            return '—';
        }
        
        function applyFilters() {
            const searchTerm = String(searchInput.value || '').trim().toLowerCase();
            const selectedCashBoxId = String(cashBoxFilter?.value || '').trim();

            filteredRows = allRows.filter((row) => {
                if (!row) return false;

                if (currentLetter && currentLetter !== 'all') {
                    const name = String(row.cells[2]?.textContent || '').trim().toUpperCase();
                    if (!name.startsWith(String(currentLetter).toUpperCase())) {
                        return false;
                    }
                }
                if (selectedCashBoxId) {
                    const rowCashBoxes = String(row.dataset.cashBoxIds || '');
                    if (!rowCashBoxes.split(',').includes(selectedCashBoxId)) {
                        return false;
                    }
                }

                if (!searchTerm) return true;

                return row.textContent.toLowerCase().includes(searchTerm);
            });

            currentPage = 1;
            updatePagination();
            updateBulkActions();
        }

        function formatContactDisplayId(sequenceNumber) {
            const n = Number(sequenceNumber);
            if (!Number.isFinite(n) || n <= 0) return '—';
            return `CONT-${String(n).padStart(3, '0')}`;
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        async function loadContactsAndRender() {
            if (!window.db || !window.db.contacts) {
                return;
            }

            const [user, contacts, cashBoxes] = await Promise.all([
                window.auth?.getCurrentUser ? window.auth.getCurrentUser() : Promise.resolve(null),
                window.db.contacts.getAll(),
                window.db.cashBoxes?.getAll
                    ? window.db.cashBoxes.getAll({ select: 'id,name,color,sequence_number' })
                    : Promise.resolve([])
            ]);

            const statsByContactId = new Map();

            const loadStatsViaRpc = async () => {
                if (!user || !window.supabaseClient) return false;
                try {
                    const { data, error } = await window.supabaseClient.rpc('spendnote_contacts_stats');
                    if (error || !Array.isArray(data)) {
                        return false;
                    }

                    try {
                        window.__spendnoteContactsStatsSource = 'rpc';
                        if (window.SpendNoteDebug) console.log('[ContactsList] Stats source: rpc', { rows: data.length });
                    } catch (_) {
                        // ignore
                    }

                    data.forEach((row) => {
                        const cid = String(row?.contact_id || '').trim();
                        if (!cid) return;

                        const cashBoxIds = Array.isArray(row?.cash_box_ids) ? row.cash_box_ids : [];
                        const lastTx = row?.last_tx_id ? {
                            id: row.last_tx_id,
                            cash_box_id: row.last_tx_cash_box_id,
                            transaction_date: row.last_tx_transaction_date,
                            created_at: row.last_tx_created_at,
                            receipt_number: row.last_tx_receipt_number,
                            cash_box_sequence: row.last_tx_cash_box_sequence,
                            tx_sequence_in_box: row.last_tx_tx_sequence_in_box,
                            status: row.last_tx_status
                        } : null;

                        const lastRaw = row?.last_tx_transaction_date || row?.last_tx_created_at;
                        const lastDt = lastRaw ? new Date(lastRaw) : null;

                        statsByContactId.set(cid, {
                            count: Number(row?.tx_count) || 0,
                            cashBoxIds: new Set(cashBoxIds.map((v) => String(v))),
                            lastTx,
                            lastDt: lastDt && Number.isFinite(lastDt.getTime()) ? lastDt : null
                        });
                    });

                    return true;
                } catch (_) {
                    return false;
                }
            };

            const loadStatsViaScan = async () => {
                try {
                    window.__spendnoteContactsStatsSource = 'scan';
                    if (window.SpendNoteDebug) console.log('[ContactsList] Stats source: scan');
                } catch (_) {
                    // ignore
                }
                let transactions = [];
                const contactNameMap = new Map(); // name -> contact id
                (Array.isArray(contacts) ? contacts : []).forEach((c) => {
                    const name = String(c?.name || '').trim().toLowerCase();
                    const id = String(c?.id || '').trim();
                    if (name && id) contactNameMap.set(name, id);
                });

                try {
                    if (user && window.supabaseClient) {
                        const { data, error } = await window.supabaseClient
                            .from('transactions')
                            .select('id,cash_box_id,contact_id,contact_name,type,receipt_number,transaction_date,created_at,cash_box_sequence,tx_sequence_in_box,status,is_system')
                            .eq('user_id', user.id)
                            .or('is_system.is.null,is_system.eq.false')
                            .order('transaction_date', { ascending: false, nullsFirst: false })
                            .order('created_at', { ascending: false, nullsFirst: false })
                            .range(0, 4999);

                        if (!error && data) {
                            transactions = data.map(tx => {
                                if (!tx.contact_id && tx.contact_name) {
                                    const matchedId = contactNameMap.get(String(tx.contact_name || '').trim().toLowerCase());
                                    if (matchedId) {
                                        return { ...tx, contact_id: matchedId };
                                    }
                                }
                                return tx;
                            });
                        }
                    }
                } catch (_) {
                    transactions = [];
                }

                (Array.isArray(transactions) ? transactions : []).forEach((tx) => {
                    const contactId = String(tx?.contact_id || '').trim();
                    if (!contactId) return;
                    const status = String(tx?.status || 'active').toLowerCase();
                    if (status !== 'active') return;

                    let entry = statsByContactId.get(contactId);
                    if (!entry) {
                        entry = { count: 0, cashBoxIds: new Set(), lastTx: null, lastDt: null };
                        statsByContactId.set(contactId, entry);
                    }

                    entry.count += 1;
                    const cbId = String(tx?.cash_box_id || '').trim();
                    if (cbId) {
                        entry.cashBoxIds.add(cbId);
                    }

                    const dt = new Date(tx?.transaction_date || tx?.created_at || '');
                    const t = dt.getTime();
                    if (!Number.isFinite(t)) return;
                    if (!entry.lastDt || t > entry.lastDt.getTime()) {
                        entry.lastDt = dt;
                        entry.lastTx = tx;
                    }
                });

                return true;
            };

            const gotRpcStats = await loadStatsViaRpc();
            if (!gotRpcStats) {
                await loadStatsViaScan();
            }

            const cashBoxById = new Map((Array.isArray(cashBoxes) ? cashBoxes : []).map((cb) => [String(cb?.id || ''), cb]));

            if (cashBoxFilter) {
                const previous = cashBoxFilter.value;
                cashBoxFilter.innerHTML = '<option value="">All Cash Boxes</option>';
                (Array.isArray(cashBoxes) ? cashBoxes : []).forEach((cb) => {
                    const id = String(cb?.id || '').trim();
                    if (!id) return;
                    const name = String(cb?.name || '').trim() || 'Cash Box';
                    const seq = Number(cb?.sequence_number);
                    const code = (Number.isFinite(seq) && seq > 0) ? `SN-${String(seq).padStart(3, '0')}` : '';
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = code ? `${name} (${code})` : name;
                    cashBoxFilter.appendChild(opt);
                });
                cashBoxFilter.disabled = false;
                if (previous) {
                    cashBoxFilter.value = previous;
                }
            }

            tableBody.innerHTML = '';

            (Array.isArray(contacts) ? contacts : []).forEach((c) => {
                const displayId = formatContactDisplayId(c?.sequence_number);
                const name = String(c?.name || '').trim() || '—';
                const email = String(c?.email || '').trim();
                const phone = String(c?.phone || '').trim();
                const address = String(c?.address || '').trim();
                const contactText = email || phone || '—';
                const contactTextHtml = contactText === '—'
                    ? '<div class="Contact-contact" style="color: var(--text-muted); font-style: italic;">—</div>'
                    : `<div class="Contact-contact">${escapeHtml(contactText)}</div>`;

                const addressHtml = address
                    ? `<div class="Contact-contact">${escapeHtml(address)}</div>`
                    : '';
                const emailHtml = email
                    ? `<div class="Contact-address">${escapeHtml(email)}</div>`
                    : '';

                const stats = (c?.id && statsByContactId.has(String(c.id))) ? statsByContactId.get(String(c.id)) : null;
                const txCount = stats ? stats.count : 0;
                const lastTx = stats ? stats.lastTx : null;
                const lastTxDisplay = lastTx ? getTxDisplayId(lastTx) : '—';
                const lastTxDate = stats?.lastDt ? formatDateShort(stats.lastDt) : '—';
                const lastTxTs = stats?.lastDt ? stats.lastDt.getTime() : 0;

                const cashBoxIds = stats ? Array.from(stats.cashBoxIds) : [];
                const maxDots = 3;
                const visibleIds = cashBoxIds.slice(0, maxDots);
                const extraCount = cashBoxIds.length - maxDots;
                const extraIds = cashBoxIds.slice(maxDots);
                const extraNames = extraIds.map(id => {
                    const cb = cashBoxById.get(String(id)) || null;
                    return cb?.name || '—';
                }).join(', ');
                
                let dotsHtml = '';
                if (cashBoxIds.length === 0) {
                    dotsHtml = '<span class="cashbox-dot" style="background: #94a3b8;" title="—"></span>';
                } else {
                    dotsHtml = visibleIds
                        .map((id) => {
                            const cb = cashBoxById.get(String(id)) || null;
                            const cbName = String(cb?.name || 'Cash Box').trim();
                            const cbColor = normalizeHexColor(cb?.color, '#94a3b8');
                            return `<span class="cashbox-dot" style="background: ${escapeHtml(cbColor)};" title="${escapeHtml(cbName)}"></span>`;
                        })
                        .join('');
                    if (extraCount > 0) {
                        dotsHtml += `<span style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-left: 2px; cursor: help;" title="${escapeHtml(extraNames || 'More cash boxes')}">+${extraCount}</span>`;
                    }
                }

                const href = (() => {
                    const contactUuid = String(c?.id || '').trim();
                    if (!contactUuid) return 'spendnote-contact-list.html';
                    const display = String(displayId || '').trim();
                    const useDisplay = display && display !== '—';
                    const idParam = useDisplay ? display : contactUuid;
                    return `spendnote-contact-detail.html?contactId=${encodeURIComponent(idParam)}`;
                })();

                const tr = document.createElement('tr');
                tr.tabIndex = 0;
                tr.setAttribute('data-contact-href', href);
                tr.dataset.cashBoxIds = cashBoxIds.join(',');
                tr.dataset.txCount = String(txCount || 0);
                tr.dataset.lastTxTs = String(Number.isFinite(lastTxTs) ? lastTxTs : 0);
                tr.innerHTML = `
                        <td><input type="checkbox" class="row-checkbox"></td>
                        <td>
                            <div class="Contact-contact" style="font-weight: 600; color: var(--text-muted);">${escapeHtml(displayId)}</div>
                        </td>
                        <td>
                            <div class="Contact-name">${escapeHtml(name)}</div>
                        </td>
                        <td>
                            ${addressHtml || '<div class="Contact-contact" style="color: var(--text-muted); font-style: italic;">—</div>'}
                            ${emailHtml}
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; gap: 4px; justify-content: center;">
                                ${dotsHtml}
                            </div>
                        </td>
                        <td>
                            <div class="Contact-contact" style="font-weight: 700; color: var(--text);">${txCount ? escapeHtml(String(txCount)) : '—'}</div>
                        </td>
                        <td>
                            <div class="Contact-contact" style="font-weight: 700; color: var(--text);">${escapeHtml(lastTxDisplay)}</div>
                            <div class="Contact-contact">${escapeHtml(lastTxDate)}</div>
                        </td>
                        <td style="text-align: center;">
                            <a href="${href}" class="tx-action btn-view"><span>View</span><i class="fas fa-arrow-right"></i></a>
                        </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // Add Contact button
        document.getElementById('addContactBtn').addEventListener('click', () => {
            window.location.href = 'spendnote-contact-detail.html?mode=new';
        });

        // Select all checkbox
        document.getElementById('selectAllHeader').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateBulkActions();
        });

        if (document.documentElement && document.documentElement.dataset.contactsTwoClickNavBound !== '1') {
            document.documentElement.dataset.contactsTwoClickNavBound = '1';

            let armedHref = '';
            let armedUntil = 0;
            let armedRow = null;
            let armTimer = null;

            const clearArmed = () => {
                if (armTimer) {
                    clearTimeout(armTimer);
                    armTimer = null;
                }
                if (armedRow && armedRow.classList) {
                    armedRow.classList.remove('is-armed');
                }
                armedHref = '';
                armedUntil = 0;
                armedRow = null;
            };

            const armRow = (row, href) => {
                clearArmed();
                armedRow = row;
                armedHref = href;
                armedUntil = Date.now() + 2500;
                try {
                    row.classList.add('is-armed');
                    if (typeof row.focus === 'function') row.focus({ preventScroll: true });
                } catch (_) {
                    // ignore
                }
                armTimer = setTimeout(clearArmed, 2500);
            };

            const shouldIgnoreRowNav = (ev) => {
                const t = ev?.target;
                if (!t || !t.closest) return false;
                if (t.closest('a, button, input, .tx-action, .tx-actions')) return true;
                const cell = t.closest('td');
                if (cell && cell.querySelector && cell.querySelector('input.row-checkbox')) return true;
                return false;
            };

            const getRowFromEvent = (ev) => {
                const t = ev?.target;
                if (!t || !t.closest) return null;
                const row = t.closest('#ContactsTableBody tr[data-contact-href]');
                return row || null;
            };

            const openContact = (href) => {
                window.location.href = href;
            };

            document.addEventListener('click', (e) => {
                if (shouldIgnoreRowNav(e)) return;
                const row = getRowFromEvent(e);
                if (!row) return;
                const href = String(row.getAttribute('data-contact-href') || '').trim();
                if (!href) return;

                if (href === armedHref && Date.now() <= armedUntil) {
                    clearArmed();
                    openContact(href);
                    return;
                }

                armRow(row, href);
            }, true);

            document.addEventListener('dblclick', (e) => {
                if (shouldIgnoreRowNav(e)) return;
                const row = getRowFromEvent(e);
                if (!row) return;
                const href = String(row.getAttribute('data-contact-href') || '').trim();
                if (!href) return;
                clearArmed();
                openContact(href);
            }, true);

            document.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                if (shouldIgnoreRowNav(e)) return;
                const row = getRowFromEvent(e);
                if (!row) return;
                const href = String(row.getAttribute('data-contact-href') || '').trim();
                if (!href) return;
                e.preventDefault();

                if (href === armedHref && Date.now() <= armedUntil) {
                    clearArmed();
                    openContact(href);
                    return;
                }

                armRow(row, href);
            }, true);

            document.addEventListener('focusin', (e) => {
                const row = getRowFromEvent(e);
                if (!row) return;
                const href = String(row.getAttribute('data-contact-href') || '').trim();
                if (!href) return;
                if (href !== armedHref) {
                    clearArmed();
                }
            }, true);
        }

        function bindRowCheckboxHandlers() {
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                if (checkbox.dataset.bound === '1') return;
                checkbox.dataset.bound = '1';
                checkbox.addEventListener('change', updateBulkActions);
            });
        }

        function updateBulkActions() {
            const checked = document.querySelectorAll('.row-checkbox:checked').length;
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            if (selectedCount) {
                selectedCount.textContent = checked;
            }

            if (bulkActions) {
                bulkActions.classList.toggle('show', checked > 0);
            }
        }

        // Bulk Export CSV
        document.getElementById('bulkExportCSV').addEventListener('click', () => {
            const checked = document.querySelectorAll('.row-checkbox:checked').length;
            showAlert(`Export CSV - ${checked} SELECTED CONTACTS\n\nIn production:\n- Generate CSV file with selected contact data\n- Download file: contacts_selected.csv`, { iconType: 'info' });
        });

        // Bulk Export PDF
        document.getElementById('bulkExportPDF').addEventListener('click', () => {
            const checked = document.querySelectorAll('.row-checkbox:checked').length;
            showAlert(`Export PDF - ${checked} SELECTED CONTACTS\n\nIn production:\n- Generate PDF report with selected contact data\n- Download file: contacts_selected.pdf`, { iconType: 'info' });
        });

        // Bulk Delete
        document.getElementById('bulkDelete').addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkedBoxes.length;
            if (count === 0) return;
            
            if (!await showConfirm(`Are you sure you want to delete ${count} contact(s)? This cannot be undone.`, { title: 'Delete Contacts', iconType: 'danger', okLabel: 'Delete', danger: true })) return;
            
            // Get contact IDs from the rows
            const ids = [];
            checkedBoxes.forEach(cb => {
                const row = cb.closest('tr');
                if (row) {
                    const viewLink = row.querySelector('a.btn-view');
                    if (viewLink && viewLink.href) {
                        const url = new URL(viewLink.href);
                        const id = url.searchParams.get('contactId');
                        if (id) ids.push(id);
                    }
                }
            });
            
            if (ids.length === 0) {
                showAlert('Could not find contact IDs to delete.', { iconType: 'error' });
                return;
            }
            
            try {
                const res = await window.db.contacts.bulkDelete(ids);
                if (!res || !res.success) {
                    showAlert(res?.error || 'Failed to delete contacts.', { iconType: 'error' });
                    return;
                }
                window.location.reload();
            } catch (err) {
                console.error('Bulk delete failed:', err);
                showAlert(err?.message || 'Failed to delete contacts.', { iconType: 'error' });
            }
        });

        // Pagination variables
        let currentPage = 1;
        let perPage = 10;
        let allRows = [];
        let filteredRows = [];
        let currentLetter = 'all';

        // Sortable table functionality
        let currentSort = { column: 'name', direction: 'asc' };

        function sortRows(rows, column, direction) {
            return rows.sort((a, b) => {
                let aValue, bValue;
                
                if (column === 'id') {
                    aValue = a.cells[1].textContent.trim();
                    bValue = b.cells[1].textContent.trim();
                } else if (column === 'name') {
                    aValue = a.cells[2].textContent.trim().toLowerCase();
                    bValue = b.cells[2].textContent.trim().toLowerCase();
                } else if (column === 'contact') {
                    aValue = a.cells[3].textContent.trim().toLowerCase();
                    bValue = b.cells[3].textContent.trim().toLowerCase();
                } else if (column === 'transactions') {
                    aValue = Number(a.dataset.txCount) || 0;
                    bValue = Number(b.dataset.txCount) || 0;
                } else if (column === 'date') {
                    aValue = Number(a.dataset.lastTxTs) || 0;
                    bValue = Number(b.dataset.lastTxTs) || 0;
                }
                
                if (direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
        }

        function filterByLetter(letter) {
            if (letter === 'all') {
                filteredRows = [...allRows];
            } else {
                filteredRows = allRows.filter(row => {
                    const name = row.cells[2].textContent.trim().toUpperCase();
                    return name.startsWith(letter);
                });
            }
            currentPage = 1;
            applyFilters();
        }

        function updatePagination() {
            const totalRows = filteredRows.length;
            const totalPages = Math.max(1, Math.ceil(totalRows / perPage));
            currentPage = Math.min(Math.max(1, currentPage), totalPages);
            const start = (currentPage - 1) * perPage;
            const end = Math.min(start + perPage, totalRows);
            
            // Update display
            const paginationText = document.getElementById('paginationText');
            if (paginationText) {
                paginationText.textContent = `Showing ${totalRows > 0 ? (start + 1) : 0}-${end} of ${totalRows}`;
            }
            
            // Hide all rows first
            allRows.forEach(row => row.style.display = 'none');
            
            // Show only current page filtered rows
            filteredRows.forEach((row, index) => {
                if (index >= start && index < end) {
                    row.style.display = '';
                }
            });

            const controls = document.querySelector('.pagination-controls');
            if (!controls) return;
            controls.innerHTML = '';

            const mkBtn = (label, page, opts) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'pagination-btn';
                if (label === '<') {
                    btn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                } else if (label === '>') {
                    btn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                } else {
                    btn.textContent = label;
                }
                if (opts?.active) btn.classList.add('active');
                if (opts?.disabled) btn.disabled = true;
                btn.addEventListener('click', () => {
                    if (btn.disabled) return;
                    currentPage = page;
                    updatePagination();
                });
                return btn;
            };

            controls.appendChild(mkBtn('<', Math.max(1, currentPage - 1), { disabled: currentPage <= 1 }));

            const windowSize = 5;
            const half = Math.floor(windowSize / 2);
            let startPage = Math.max(1, currentPage - half);
            let endPage = Math.min(totalPages, startPage + windowSize - 1);
            startPage = Math.max(1, endPage - windowSize + 1);

            if (startPage > 1) {
                controls.appendChild(mkBtn('1', 1, { active: currentPage === 1 }));
                if (startPage > 2) {
                    const dots = document.createElement('button');
                    dots.type = 'button';
                    dots.className = 'pagination-btn';
                    dots.textContent = '...';
                    dots.disabled = true;
                    controls.appendChild(dots);
                }
            }

            for (let p = startPage; p <= endPage; p += 1) {
                controls.appendChild(mkBtn(String(p), p, { active: currentPage === p }));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('button');
                    dots.type = 'button';
                    dots.className = 'pagination-btn';
                    dots.textContent = '...';
                    dots.disabled = true;
                    controls.appendChild(dots);
                }
                controls.appendChild(mkBtn(String(totalPages), totalPages, { active: currentPage === totalPages }));
            }

            controls.appendChild(mkBtn('>', Math.min(totalPages, currentPage + 1), { disabled: currentPage >= totalPages }));
        }

        window.addEventListener('load', () => {
            loadContactsAndRender().then(() => {
                bindRowCheckboxHandlers();

                // Initialize - sort by name alphabetically
                allRows = Array.from(tableBody.querySelectorAll('tr'));
                allRows = sortRows(allRows, 'name', 'asc');
                allRows.forEach(row => tableBody.appendChild(row));
                filteredRows = [...allRows];
                
                // Set initial sort indicator
                const nameHeader = document.querySelector('[data-column="name"]');
                nameHeader.classList.add('asc');
                
                updatePagination();

                // Alphabet navigation
                document.querySelectorAll('.alphabet-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const letter = this.dataset.letter;
                        currentLetter = letter;
                        
                        // Update active state
                        document.querySelectorAll('.alphabet-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Filter by letter
                        filterByLetter(letter);
                    });
                });

                // Sortable headers
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.dataset.column;
                        
                        // Toggle sort direction
                        if (currentSort.column === column) {
                            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort.column = column;
                            currentSort.direction = 'asc';
                        }
                        
                        // Remove sort classes from all headers
                        document.querySelectorAll('.sortable').forEach(h => {
                            h.classList.remove('asc', 'desc');
                        });
                        
                        // Add sort class to current header
                        header.classList.add(currentSort.direction);
                        
                        // Sort rows
                        allRows = sortRows(allRows, column, currentSort.direction);
                        allRows.forEach(row => tableBody.appendChild(row));
                        
                        // Reset to first page and update
                        currentPage = 1;
                        updatePagination();
                    });
                });

                // Per page selector
                document.getElementById('perPageSelect').addEventListener('change', function() {
                    perPage = parseInt(this.value);
                    currentPage = 1;
                    updatePagination();
                });
            });
        }, { once: true });
    </script>

    <!-- Sticky Add Transaction Button -->
    <button class="sticky-add-btn" onclick="window.location.href='dashboard.html#new-transaction'" aria-label="Add Transaction">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260211-2016"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/modal-dialogs.js?v=20260208-1900"></script>
    <script src="assets/js/nav-loader.js?v=8"></script>
    <script>loadNav();</script>
    <script src="assets/js/main.js?v=21"></script>
</body>
</html>
