<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Cash Box settings in SpendNote.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Cash Box Settings - SpendNote</title>
    <script>
        (function() {
            try {
                var c = localStorage.getItem('activeCashBoxColor');
                var r = localStorage.getItem('activeCashBoxRgb');
                if (c && r) {
                    document.documentElement.style.setProperty('--active', c);
                    document.documentElement.style.setProperty('--active-rgb', r);
                }
            } catch (e) {}
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=12">
    <link rel="stylesheet" href="assets/css/app-layout.css?v=14">
    <link rel="stylesheet" href="assets/css/cash-box-settings.css?v=11">
</head>
<body>
<div id="nav-container"></div>

<div class="app-container">
    <main class="main-content">
        <!-- PAGE HEADER -->
        <div class="page-header" style="margin-bottom: 16px;">
            <h1 class="page-title">Cash Box Settings</h1>
            <p class="page-subtitle" id="cashBoxSettingsSubtitle">Configure cash box details and default receipt appearance settings.</p>
        </div>

        <!-- TOP GRID (Transaction Detail-like) -->
        <div class="cb-topbar">
            <div class="cb-top-grid">
                <!-- SUMMARY (small - left/top) -->
                <div class="summary-card">
                    <div class="summary-left">
                        <div class="summary-icon" id="summaryIcon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="summary-info">
                            <div class="summary-id" id="summaryId">SN-007</div>
                            <div class="summary-name" id="summaryName">Main Office</div>
                        </div>
                    </div>
                    <div class="summary-center">
                        <div class="summary-balance-label">CURRENT BALANCE</div>
                        <div class="summary-balance" id="summaryBalance">—</div>
                    </div>
                </div>

                <!-- GENERAL (large - left/bottom) -->
                <div class="settings-card">
                    <div class="settings-card-title"><i class="fas fa-cog"></i> General</div>
                    <div class="general-fields">
                        <div class="field-row-3">
                            <div class="field-group">
                                <label class="field-label"><i class="fas fa-tag"></i> Cash Box Name</label>
                                <input type="text" class="field-input" id="cashBoxNameInput" placeholder="e.g., Main Office">
                                <span class="field-hint">Appears on receipts</span>
                            </div>
                            <div class="field-group" id="currencyFieldGroup">
                                <label class="field-label"><i class="fas fa-coins"></i> Currency</label>
                                <input type="text" class="field-input" id="currencySelect" list="currencyList" value="USD" autocapitalize="characters" autocomplete="off" spellcheck="false">
                                <datalist id="currencyList">
                                    <option value="USD" label="US Dollar ($)"></option>
                                    <option value="EUR" label="Euro (€)"></option>
                                    <option value="GBP" label="British Pound (£)"></option>
                                    <option value="HUF" label="Hungarian Forint (Ft)"></option>
                                    <option value="JPY" label="Japanese Yen (¥)"></option>
                                    <option value="CHF" label="Swiss Franc (CHF)"></option>
                                    <option value="CAD" label="Canadian Dollar (CA$)"></option>
                                    <option value="AUD" label="Australian Dollar (A$)"></option>
                                </datalist>
                            </div>
                            <div class="field-group id-prefix-group">
                                <span class="pro-badge id-prefix-badge"><i class="fas fa-crown"></i> Pro</span>
                                <label class="field-label"><i class="fas fa-hashtag"></i> ID Prefix</label>
                                <input type="text" class="field-input" id="idPrefixInput" value="SN" placeholder="SN" maxlength="10">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- APPEARANCE (tall - right spanning rows) -->
                <div class="settings-card cb-appearance-card">
                    <div class="settings-card-title"><i class="fas fa-palette"></i> Appearance</div>
                    <div class="appearance-content">
                        <div class="appearance-row">
                            <label class="appearance-label">Accent Color</label>
                            <div class="color-palette" id="colorPalette">
                                <!-- Row 1: Greens & Teals -->
                                <div class="color-option selected" style="background: #059669;" data-color="#059669" data-rgb="5, 150, 105" title="Emerald"></div>
                                <div class="color-option" style="background: #10b981;" data-color="#10b981" data-rgb="16, 185, 129" title="Green"></div>
                                <div class="color-option" style="background: #14b8a6;" data-color="#14b8a6" data-rgb="20, 184, 166" title="Teal"></div>
                                <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" data-rgb="6, 182, 212" title="Cyan"></div>
                                <!-- Row 2: Blues -->
                                <div class="color-option" style="background: #0ea5e9;" data-color="#0ea5e9" data-rgb="14, 165, 233" title="Sky"></div>
                                <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6" data-rgb="59, 130, 246" title="Blue"></div>
                                <div class="color-option" style="background: #6366f1;" data-color="#6366f1" data-rgb="99, 102, 241" title="Indigo"></div>
                                <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" data-rgb="139, 92, 246" title="Violet"></div>
                                <!-- Row 3: Purples & Pinks -->
                                <div class="color-option" style="background: #a855f7;" data-color="#a855f7" data-rgb="168, 85, 247" title="Purple"></div>
                                <div class="color-option" style="background: #d946ef;" data-color="#d946ef" data-rgb="217, 70, 239" title="Fuchsia"></div>
                                <div class="color-option" style="background: #ec4899;" data-color="#ec4899" data-rgb="236, 72, 153" title="Pink"></div>
                                <div class="color-option" style="background: #f43f5e;" data-color="#f43f5e" data-rgb="244, 63, 94" title="Rose"></div>
                                <!-- Row 4: Oranges & Yellows -->
                                <div class="color-option" style="background: #ef4444;" data-color="#ef4444" data-rgb="239, 68, 68" title="Red"></div>
                                <div class="color-option" style="background: #f97316;" data-color="#f97316" data-rgb="249, 115, 22" title="Orange"></div>
                                <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" data-rgb="245, 158, 11" title="Amber"></div>
                                <div class="color-option" style="background: #eab308;" data-color="#eab308" data-rgb="234, 179, 8" title="Yellow"></div>
                                <!-- Row 5: Neutrals -->
                                <div class="color-option" style="background: #64748b;" data-color="#64748b" data-rgb="100, 116, 139" title="Slate"></div>
                                <div class="color-option" style="background: #78716c;" data-color="#78716c" data-rgb="120, 113, 108" title="Stone"></div>
                            </div>
                        </div>
                        <div class="appearance-row">
                            <label class="appearance-label">Icon</label>
                            <div class="icon-palette" id="iconPalette">
                                <div class="icon-option selected" data-icon="fa-building"><i class="fas fa-building"></i></div>
                                <div class="icon-option" data-icon="fa-store"><i class="fas fa-store"></i></div>
                                <div class="icon-option" data-icon="fa-calendar"><i class="fas fa-calendar"></i></div>
                                <div class="icon-option" data-icon="fa-wallet"><i class="fas fa-wallet"></i></div>
                                <div class="icon-option" data-icon="fa-bullhorn"><i class="fas fa-bullhorn"></i></div>
                                <div class="icon-option" data-icon="fa-dollar-sign"><i class="fas fa-dollar-sign"></i></div>
                                <div class="icon-option" data-icon="fa-home"><i class="fas fa-home"></i></div>
                                <div class="icon-option" data-icon="fa-briefcase"><i class="fas fa-briefcase"></i></div>
                                <div class="icon-option" data-icon="fa-chart-line"><i class="fas fa-chart-line"></i></div>
                                <div class="icon-option" data-icon="fa-star"><i class="fas fa-star"></i></div>
                                <div class="icon-option" data-icon="fa-flag"><i class="fas fa-flag"></i></div>
                                <div class="icon-option" data-icon="fa-heart"><i class="fas fa-heart"></i></div>
                                <div class="icon-option" data-icon="fa-bolt"><i class="fas fa-bolt"></i></div>
                                <div class="icon-option" data-icon="fa-gift"><i class="fas fa-gift"></i></div>
                                <div class="icon-option" data-icon="fa-tag"><i class="fas fa-tag"></i></div>
                                <div class="icon-option" data-icon="fa-bell"><i class="fas fa-bell"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="cb-actions-row" aria-label="Cash box actions">
            <div class="left">
                <button class="cb-delete-trigger" id="cashBoxDeleteToggle" type="button"><i class="fas fa-trash"></i> Delete</button>
            </div>
            <div class="right">
                <button type="button" class="btn btn-secondary" id="cashBoxCancelBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="cashBoxSaveBtn">Save Changes</button>
            </div>
        </div>

        <div class="cb-delete-panel" id="cashBoxDeletePanel" style="display: none;">
            <div class="cb-delete-copy">Permanently delete this Cash Box and all associated transactions. This action cannot be undone.</div>
            <button class="danger-btn" id="deleteButton" type="button"><i class="fas fa-trash"></i> Delete Cash Box</button>
        </div>

        <div class="collapsible-section">
            <div class="collapsible-header" style="cursor: pointer;">
                <div class="collapsible-title">
                    <i class="fas fa-users"></i>
                    Team Access
                    <span class="pro-badge"><i class="fas fa-crown"></i> Pro</span>
                </div>
                <i class="fas fa-chevron-down" id="teamToggleIcon" style="transition: transform 0.3s; color: var(--text-muted); font-size: 12px;"></i>
            </div>
            <div class="collapsible-content" id="teamContent" style="display: none;">
                <div class="team-members-list">
                    <div class="team-member-row">
                        <img src="https://i.pravatar.cc/150?img=12" alt="John Doe" class="team-avatar">
                        <div class="team-member-info">
                            <div class="team-member-name">John Doe</div>
                            <div class="team-member-role">Owner</div>
                        </div>
                    </div>
                    <div class="team-member-row">
                        <img src="https://i.pravatar.cc/150?img=5" alt="Jane Smith" class="team-avatar">
                        <div class="team-member-info">
                            <div class="team-member-name">Jane Smith</div>
                            <div class="team-member-role">Admin</div>
                        </div>
                    </div>
                    <div class="team-member-row">
                        <img src="https://i.pravatar.cc/150?img=8" alt="Mike Johnson" class="team-avatar">
                        <div class="team-member-info">
                            <div class="team-member-name">Mike Johnson</div>
                            <div class="team-member-role">Viewer</div>
                        </div>
                    </div>
                </div>
                <a href="spendnote-user-settings.html?tab=team" class="team-manage-link"><i class="fas fa-cog"></i> Manage in Settings</a>
            </div>
        </div>

        <!-- RECEIPT & PRO OPTIONS GRID -->
        <div class="settings-grid">
            <!-- RECEIPT & PRINT -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title">
                        <i class="fas fa-receipt"></i>
                        Receipt & Print Settings
                    </div>
                </div>
                <div class="collapsible-content" id="receiptSection">
                    <div class="receipt-layout">
                        <!-- Controls -->
                        <div class="receipt-controls">
                            <!-- Format -->
                            <div>
                                <div class="control-group-label">Default Format</div>
                                <div class="format-buttons">
                                    <button class="format-btn active" data-format="a4">
                                        <i class="fas fa-copy"></i>
                                        Print
                                    </button>
                                    <button class="format-btn" data-format="pdf">
                                        <i class="fas fa-file-pdf"></i>
                                        PDF
                                    </button>
                                    <button class="format-btn" data-format="email">
                                        <i class="fas fa-envelope"></i>
                                        Email
                                    </button>
                                </div>
                            </div>

                            <!-- Mode -->
                            <div>
                                <div class="control-group-label">Fields</div>
                                <div class="mode-toggle">
                                    <input type="radio" name="receiptMode" id="receiptModeQuick" value="quick" checked>
                                    <label for="receiptModeQuick">Quick</label>
                                    <input type="radio" name="receiptMode" id="receiptModeDetailed" value="detailed">
                                    <label for="receiptModeDetailed">Detailed</label>
                                </div>
                            </div>

                            <!-- Quick Summary -->
                            <div id="receiptQuickSummary" class="quick-summary">
                                <strong>Quick preset:</strong> Logo, addresses, line items, total, signatures
                            </div>

                            <!-- Detailed Toggles -->
                            <div id="receiptDetailedToggles" class="toggle-list" style="display: none;">
                                <div class="toggle-item">
                                    <span>Logo</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked data-field="logo">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-item">
                                    <span>Addresses</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked data-field="addresses">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-item">
                                    <span>Receipt IDs</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" data-field="tracking">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-item">
                                    <span>Additional IDs</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" data-field="additional">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-item">
                                    <span>Notes</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" data-field="note">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-item">
                                    <span>Signatures</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked data-field="signatures">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Preview -->
                        <div class="receipt-preview">
                            <div class="preview-toolbar">
                                <div class="preview-label"><i class="fas fa-eye"></i> Preview</div>
                                <div class="zoom-controls">
                                    <button class="zoom-btn" id="zoomOutBtn" type="button"><i class="fas fa-minus"></i></button>
                                    <span class="zoom-level" id="zoomLevel">60%</span>
                                    <button class="zoom-btn" id="zoomInBtn" type="button"><i class="fas fa-plus"></i></button>
                                    <button class="zoom-btn" id="zoomResetBtn" type="button"><i class="fas fa-redo"></i></button>
                                </div>
                            </div>
                            <div class="preview-frame-container" id="receiptPreviewContainer">
                                <iframe id="receiptFrame" class="preview-frame" src="about:blank"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRO OPTIONS -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title">
                        <i class="fas fa-crown"></i>
                        Pro Options
                        <span class="pro-badge"><i class="fas fa-crown"></i> Pro</span>
                    </div>
                </div>
                <div class="collapsible-content" id="proSection">
                    <div class="pro-content">
                        <div class="pro-grid">
                            <div class="pro-field full">
                                <label>Logo</label>
                                <div class="logo-compact">
                                    <div class="logo-compact-row">
                                        <div class="logo-compact-preview" id="cbLogoEditorCanvas">
                                            <div class="logo-compact-placeholder" id="cbLogoEditorPlaceholder"><i class="fas fa-image"></i></div>
                                            <img class="logo-compact-img" id="cbLogoEditorImage" alt="Cash Box Logo" draggable="false">
                                        </div>
                                        <div class="logo-compact-controls">
                                            <div class="logo-compact-zoom">
                                                <button type="button" class="logo-compact-btn" id="cbLogoZoomOut" title="Smaller"><i class="fas fa-minus"></i></button>
                                                <span class="logo-compact-pct" id="cbLogoEditorInfo">100%</span>
                                                <button type="button" class="logo-compact-btn" id="cbLogoZoomIn" title="Bigger"><i class="fas fa-plus"></i></button>
                                            </div>
                                            <div class="logo-compact-actions">
                                                <input type="file" id="cbLogoFileInput" accept="image/*" style="display:none;">
                                                <button type="button" class="btn btn-secondary btn-small" id="cbLogoUploadBtn"><i class="fas fa-upload"></i> Upload</button>
                                                <button type="button" class="btn btn-secondary btn-small" id="cbLogoRemoveBtn"><i class="fas fa-trash"></i> Remove</button>
                                            </div>
                                            <div class="logo-compact-hint">1200×600px PNG/JPG</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pro-field">
                                <label>Receipt Title</label>
                                <input type="text" id="receiptTitle" placeholder="Cash Receipt">
                            </div>
                            <div class="pro-field">
                                <label>Total Label</label>
                                <input type="text" id="totalLabel" placeholder="Total handed over">
                            </div>
                            <div class="pro-field">
                                <label>From Label</label>
                                <input type="text" id="fromLabel" placeholder="FROM">
                            </div>
                            <div class="pro-field">
                                <label>To Label</label>
                                <input type="text" id="toLabel" placeholder="TO">
                            </div>
                            <div class="pro-field">
                                <label>Description Label</label>
                                <input type="text" id="descriptionLabel" placeholder="Description">
                            </div>
                            <div class="pro-field">
                                <label>Amount Label</label>
                                <input type="text" id="amountLabel" placeholder="Amount">
                            </div>
                            <div class="pro-field">
                                <label>Issued By Label</label>
                                <input type="text" id="issuedByLabel" placeholder="Issued by">
                            </div>
                            <div class="pro-field">
                                <label>Received By Label</label>
                                <input type="text" id="receivedByLabel" placeholder="Received by">
                            </div>
                            <div class="pro-field full">
                                <label>Footer Note</label>
                                <textarea rows="2" id="footerNote" placeholder="Thank you for your business!"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<footer class="app-footer">
    <div class="app-footer-container">
        <div class="app-footer-top">
            <div class="app-footer-brand">
                <a href="dashboard.html" class="app-footer-brand-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="white"/>
                        <path d="M32 4 L38 10 L32 10 Z" fill="rgba(0,0,0,0.15)"/>
                        <path d="M32 4 L32 10 L38 10" stroke="rgba(0,0,0,0.2)" stroke-width="1.5" stroke-linejoin="round"/>
                        <line x1="14" y1="14" x2="30" y2="14" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="rgba(0,0,0,0.12)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="rgba(0,0,0,0.1)" stroke-width="2.5" stroke-linecap="round"/>
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="rgba(0,0,0,0.2)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>SpendNote</span>
                </a>
                <p class="app-footer-brand-desc">Cash receipt management for modern teams.</p>
            </div>
            <div class="app-footer-right">
                <div class="app-footer-links-simple">
                    <a href="index.html#features">Features</a>
                    <a href="spendnote-pricing.html">Pricing</a>
                    <a href="spendnote-faq.html">FAQ</a>
                    <a href="spendnote-terms.html">Legal</a>
                </div>
                <div class="app-footer-brand-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <span>Cash handoff documentation only. Not a tax or accounting tool.</span>
                </div>
            </div>
        </div>
        <div class="app-footer-bottom">
            <div class="app-footer-copyright">2026 SpendNote. All rights reserved.</div>
        </div>
    </div>
</footer>

<script>
// ===== DUMMY DATA FOR RECEIPT PREVIEW =====
const DUMMY_TX = {
    id: 'demo-preview',
    display_id: 'SN1-042',
    transaction_date: 'Jan 15, 2026',
    type: 'in',
    amount: 249.97,
    description: 'Payment received',
    contact_name: 'John Doe',
    contact_address: '456 Oak Ave, Springfield, IL 62704',
    contact_custom_field_1: 'CUST-1007',
    note: 'Cash received in person.',
    line_items: [
        { description: 'Services', amount: 149.99 },
        { description: 'Service fee', amount: 79.99 },
        { description: 'Supplies', amount: 19.99 }
    ],
    cash_box: {
        name: 'Main Office',
        sequence_number: 1,
        currency: 'USD'
    },
    created_by_user_name: 'Alex Johnson'
};

const DUMMY_PROFILE = {
    company_name: 'Acme Corporation',
    full_name: 'Acme Corporation',
    address: '123 Main St, Springfield, IL 62701'
};

// ===== RECEIPT PREVIEW =====
const QUICK_PRESET = {
    logo: '1',
    addresses: '1',
    tracking: '1',
    additional: '0',
    note: '0',
    signatures: '1'
};

const DETAILED_PRESET = {
    logo: '1',
    addresses: '1',
    tracking: '1',
    additional: '1',
    note: '1',
    signatures: '1'
};

let receiptMode = 'quick';
let displayOptions = { ...QUICK_PRESET };

const LOGO_SCALE_KEY = 'spendnote.receipt.logoScale.v1';
const LOGO_ALIGN_KEY = 'spendnote.receipt.logoAlign.v1';
const LOGO_POSITION_KEY = 'spendnote.receipt.logoPosition.v1';
const LOGO_SETTINGS_MIN_SCALE = 0.5;
const LOGO_SETTINGS_MAX_SCALE = 3.0;

function clampLogoScale(value) {
    const n = Number(value);
    if (!Number.isFinite(n)) return 1;
    return Math.round(Math.min(LOGO_SETTINGS_MAX_SCALE, Math.max(LOGO_SETTINGS_MIN_SCALE, n)) * 100) / 100;
}

function normalizeLogoSettings(value) {
    const src = (value && typeof value === 'object') ? value : {};
    return {
        scale: clampLogoScale(src.scale),
        x: Number.isFinite(Number(src.x)) ? Math.round(Number(src.x) * 100) / 100 : 0,
        y: Number.isFinite(Number(src.y)) ? Math.round(Number(src.y) * 100) / 100 : 0
    };
}

function getCashBoxLogoSettingsStorageKey(cashBoxId) {
    const id = String(cashBoxId || '').trim();
    if (!id) return '';
    return `spendnote.cashBox.${id}.logoSettings.v1`;
}

function readStoredCashBoxLogoSettings(cashBoxId, includeGlobalFallback = true) {
    const key = getCashBoxLogoSettingsStorageKey(cashBoxId);
    if (key) {
        try {
            const raw = localStorage.getItem(key);
            if (raw) {
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    return normalizeLogoSettings(parsed);
                }
            }
        } catch (_) {}
    }

    if (!includeGlobalFallback) {
        return normalizeLogoSettings(null);
    }

    const fallback = { scale: 1, x: 0, y: 0 };
    try {
        const s = parseFloat(localStorage.getItem(LOGO_SCALE_KEY) || '1');
        if (Number.isFinite(s)) fallback.scale = s;
    } catch (_) {}

    try {
        const rawPos = localStorage.getItem(LOGO_POSITION_KEY);
        if (rawPos) {
            const p = JSON.parse(rawPos);
            if (Number.isFinite(Number(p?.x))) fallback.x = Number(p.x);
            if (Number.isFinite(Number(p?.y))) fallback.y = Number(p.y);
        }
    } catch (_) {}

    return normalizeLogoSettings(fallback);
}

function writeStoredCashBoxLogoSettings(cashBoxId, settings) {
    const key = getCashBoxLogoSettingsStorageKey(cashBoxId);
    if (!key) return;
    try {
        localStorage.setItem(key, JSON.stringify(normalizeLogoSettings(settings)));
    } catch (_) {}
}

let currentFormat = 'a4';
let currentZoom = 0.6;

function buildReceiptUrl(format) {
    const baseUrls = {
        'a4': 'spendnote-receipt-a4-two-copies.html',
        'pdf': 'spendnote-pdf-receipt.html',
        'email': 'spendnote-email-receipt.html'
    };
    
    const params = new URLSearchParams();
    params.append('v', 'settings-preview-02');
    params.append('demo', '1');
    
    // Display options
    for (const [key, value] of Object.entries(displayOptions)) {
        params.append(key, value);
    }

    params.append('itemsMode', receiptMode === 'quick' ? 'single' : 'full');
    params.append('recordedBy', '0');

    // Cash box logo takes priority over user settings logo
    try {
        const cbLogo = typeof window.getCashBoxLogo === 'function' ? window.getCashBoxLogo() : '';
        if (cbLogo) {
            const cbId = currentCashBoxData?.id || 'temp';
            const tempKey = 'spendnote.cbLogo.' + cbId;
            try { localStorage.setItem(tempKey, cbLogo); } catch (_) {}
            params.append('logoKey', tempKey);
        } else {
            // Fallback to user settings (global default) logo
            const userLogo = localStorage.getItem('spendnote.proLogoDataUrl')
                || localStorage.getItem('spendnote.receipt.logo.v1')
                || '';
            if (userLogo) {
                params.append('logoKey', 'spendnote.proLogoDataUrl');
            }
        }
    } catch (e) {}

    try {
        const keyId = String(currentCashBoxData?.id || '').trim();
        const logoSettings = (typeof window.getCashBoxLogoSettings === 'function')
            ? window.getCashBoxLogoSettings()
            : readStoredCashBoxLogoSettings(keyId, true);

        const scale = Number(logoSettings?.scale);
        if (Number.isFinite(scale) && scale > 0) {
            params.append('logoScale', String(scale));
        }
        if (Number.isFinite(Number(logoSettings?.x))) {
            params.append('logoX', String(Number(logoSettings.x)));
        }
        if (Number.isFinite(Number(logoSettings?.y))) {
            params.append('logoY', String(Number(logoSettings.y)));
        }
    } catch (e) {}

    try {
        const storedAlign = String(localStorage.getItem(LOGO_ALIGN_KEY) || '').trim().toLowerCase();
        if (storedAlign === 'left' || storedAlign === 'center' || storedAlign === 'right') {
            params.append('logoAlign', storedAlign);
        }
    } catch (e) {}

    // Dummy data params
    params.append('demoCompany', DUMMY_PROFILE.company_name);
    params.append('demoAddress', DUMMY_PROFILE.address);
    params.append('demoCompanyId', '');
    params.append('demoContact', DUMMY_TX.contact_name);
    params.append('demoContactAddress', DUMMY_TX.contact_address);
    params.append('demoContactId', DUMMY_TX.contact_custom_field_1 || '');
    params.append('demoAmount', DUMMY_TX.amount);
    params.append('demoCurrency', DUMMY_TX.cash_box.currency);
    params.append('demoDate', DUMMY_TX.transaction_date);
    params.append('demoReceiptId', DUMMY_TX.display_id);
    params.append('demoCashBoxId', 'SN-001');
    params.append('demoNote', DUMMY_TX.note);
    // recorded-by is intentionally not shown in settings previews

    const demoItems = (Array.isArray(DUMMY_TX.line_items) ? DUMMY_TX.line_items : [])
        .map(it => `${String(it.description || '').trim()}|${Number(it.amount)}`)
        .filter(Boolean)
        .join(';');
    params.append('demoItems', demoItems);
    
    // Pro text customizations
    const receiptTitle = document.getElementById('receiptTitle')?.value;
    const totalLabel = document.getElementById('totalLabel')?.value;
    const fromLabel = document.getElementById('fromLabel')?.value;
    const toLabel = document.getElementById('toLabel')?.value;
    const descriptionLabel = document.getElementById('descriptionLabel')?.value;
    const amountLabel = document.getElementById('amountLabel')?.value;
    const issuedByLabel = document.getElementById('issuedByLabel')?.value;
    const receivedByLabel = document.getElementById('receivedByLabel')?.value;
    const footerNote = document.getElementById('footerNote')?.value;
    
    if (receiptTitle) params.append('receiptTitle', receiptTitle);
    if (totalLabel) params.append('totalLabel', totalLabel);
    if (fromLabel) params.append('fromLabel', fromLabel);
    if (toLabel) params.append('toLabel', toLabel);
    if (descriptionLabel) params.append('descriptionLabel', descriptionLabel);
    if (amountLabel) params.append('amountLabel', amountLabel);
    if (issuedByLabel) params.append('issuedByLabel', issuedByLabel);
    if (receivedByLabel) params.append('receivedByLabel', receivedByLabel);
    if (footerNote) params.append('footerNote', footerNote);
    
    return `${baseUrls[format]}?${params.toString()}`;
}

function applyReceiptMode(mode) {
    const m = mode === 'detailed' ? 'detailed' : 'quick';
    receiptMode = m;

    const quickSummary = document.getElementById('receiptQuickSummary');
    const detailedToggles = document.getElementById('receiptDetailedToggles');
    if (quickSummary) quickSummary.style.display = m === 'quick' ? 'block' : 'none';
    if (detailedToggles) detailedToggles.style.display = 'flex';

    const quickRadio = document.getElementById('receiptModeQuick');
    const detailedRadio = document.getElementById('receiptModeDetailed');
    if (quickRadio) quickRadio.checked = m === 'quick';
    if (detailedRadio) detailedRadio.checked = m === 'detailed';

    displayOptions = m === 'quick' ? { ...QUICK_PRESET } : { ...DETAILED_PRESET };
    document.querySelectorAll('.toggle-list input[type="checkbox"]').forEach(toggle => {
        const field = toggle.dataset.field;
        if (field) toggle.checked = displayOptions[field] === '1';
    });
    reloadIframe();
}

function reloadIframe() {
    const iframe = document.getElementById('receiptFrame');
    if (iframe) {
        iframe.src = buildReceiptUrl(currentFormat);
    }
}

function applyIframeZoom(iframe) {
    try {
        const doc = iframe.contentDocument;
        if (!doc) return;
        const de = doc.documentElement;
        const body = doc.body;
        if (!de || !body) return;

        let style = doc.getElementById('txReceiptPreviewOverride');
        if (!style) {
            style = doc.createElement('style');
            style.id = 'txReceiptPreviewOverride';
            style.textContent = `
html, body { height: auto !important; overflow: auto !important; }
.page { height: auto !important; min-height: 0 !important; }
`;
            doc.head && doc.head.appendChild(style);
        }

        de.style.overflow = 'auto';
        body.style.overflow = 'auto';
        body.style.zoom = String(currentZoom);
    } catch (_) {}
}

function updateZoom() {
    const iframe = document.getElementById('receiptFrame');
    const zoomLevel = document.getElementById('zoomLevel');
    if (iframe) {
        iframe.style.transform = 'none';
        iframe.style.zoom = '1';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        applyIframeZoom(iframe);
    }
    if (zoomLevel) {
        zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
    }
}

function scheduleZoomUpdate() {
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            updateZoom();
        });
    });
}

function zoomIn() { currentZoom = Math.min(currentZoom + 0.1, 1.2); scheduleZoomUpdate(); }
function zoomOut() { currentZoom = Math.max(currentZoom - 0.1, 0.4); scheduleZoomUpdate(); }
function resetZoom() { currentZoom = 0.6; scheduleZoomUpdate(); }


// ===== COLOR PICKER =====
document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        
        const color = this.dataset.color;
        const rgb = this.dataset.rgb;
        if (color && rgb) {
            document.documentElement.style.setProperty('--active', color);
            document.documentElement.style.setProperty('--active-rgb', rgb);
            try {
                localStorage.setItem('activeCashBoxColor', color);
                localStorage.setItem('activeCashBoxRgb', rgb);
            } catch (e) {}
        }
    });
});

// ===== ICON PICKER =====
document.querySelectorAll('.icon-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
    });
});

// ===== FORMAT BUTTONS =====
document.querySelectorAll('.format-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFormat = this.dataset.format;
        reloadIframe();
    });
});

// ===== MODE TOGGLE =====
document.querySelectorAll('input[name="receiptMode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        applyReceiptMode(this.value);
    });
});


// ===== TOGGLE SWITCHES =====
document.querySelectorAll('.toggle-list input[type="checkbox"]').forEach(toggle => {
    toggle.addEventListener('change', function() {
        const field = this.dataset.field;
        if (field) {
            displayOptions[field] = this.checked ? '1' : '0';
            reloadIframe();
        }
    });
});

// ===== PRO TEXT FIELDS =====
['receiptTitle', 'totalLabel', 'fromLabel', 'toLabel', 'descriptionLabel', 'amountLabel', 'issuedByLabel', 'receivedByLabel', 'footerNote'].forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('input', function() {
            reloadIframe();
        });
    }
});

// ===== ZOOM CONTROLS =====
document.getElementById('zoomOutBtn')?.addEventListener('click', zoomOut);
document.getElementById('zoomInBtn')?.addEventListener('click', zoomIn);
document.getElementById('zoomResetBtn')?.addEventListener('click', resetZoom);

// ===== CASH BOX LOGO (Pro Options) =====
// This logo is cash-box-specific, stored in DB (cash_box_logo_url).
// Logo editor behavior mirrors User Settings (upload + zoom + drag).
let pendingCashBoxLogo = null; // null = no change, '' = removed, 'data:...' = new logo
let loadedCashBoxLogo = '';
let pendingCashBoxLogoSettings = null;
let loadedCashBoxLogoSettings = normalizeLogoSettings(null);

const cbLogoCanvas = document.getElementById('cbLogoEditorCanvas');
const cbLogoImage = document.getElementById('cbLogoEditorImage');
const cbLogoInfo = document.getElementById('cbLogoEditorInfo');
const cbLogoFileInput = document.getElementById('cbLogoFileInput');
const cbLogoUploadBtn = document.getElementById('cbLogoUploadBtn');
const cbLogoRemoveBtn = document.getElementById('cbLogoRemoveBtn');
const cbLogoZoomIn = document.getElementById('cbLogoZoomIn');
const cbLogoZoomOut = document.getElementById('cbLogoZoomOut');

let cbLogoDragActive = false;
let cbLogoDragStartX = 0;
let cbLogoDragStartY = 0;
let cbLogoDragBaseSettings = normalizeLogoSettings(null);

function getEffectiveCashBoxLogoSettings() {
    if (pendingCashBoxLogoSettings && typeof pendingCashBoxLogoSettings === 'object') {
        return normalizeLogoSettings(pendingCashBoxLogoSettings);
    }
    return normalizeLogoSettings(loadedCashBoxLogoSettings);
}

function applyCashBoxLogoTransform() {
    const settings = getEffectiveCashBoxLogoSettings();
    if (cbLogoInfo) {
        cbLogoInfo.textContent = `${Math.round(settings.scale * 100)}%`;
    }
    if (cbLogoImage) {
        cbLogoImage.style.transform = `translate(${settings.x}px, ${settings.y}px) scale(${settings.scale})`;
    }
}

function setCashBoxLogoSettings(nextSettings, markAsPending = true, reload = true) {
    const normalized = normalizeLogoSettings(nextSettings);
    if (markAsPending) {
        pendingCashBoxLogoSettings = normalized;
    } else {
        loadedCashBoxLogoSettings = normalized;
        pendingCashBoxLogoSettings = null;
    }

    applyCashBoxLogoTransform();
    if (reload) reloadIframe();
}

function showCashBoxLogo(dataUrl) {
    const value = String(dataUrl || '').trim();
    if (!cbLogoCanvas || !cbLogoImage) return;

    if (value) {
        cbLogoImage.src = value;
        cbLogoCanvas.classList.add('has-logo');
    } else {
        cbLogoImage.removeAttribute('src');
        cbLogoCanvas.classList.remove('has-logo');
    }

    applyCashBoxLogoTransform();
}

cbLogoUploadBtn?.addEventListener('click', () => {
    if (!cbLogoFileInput) return;
    try { cbLogoFileInput.value = ''; } catch (_) {}
    cbLogoFileInput.click();
});

cbLogoFileInput?.addEventListener('change', function(e) {
    const file = e.target?.files?.[0];
    if (!file) return;

    if (file.size > 2 * 1024 * 1024) {
        showAlert('File size must be less than 2MB.', { iconType: 'warning' });
        try { e.target.value = ''; } catch (_) {}
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        const dataUrl = String(event?.target?.result || '').trim();
        if (!/^data:image\//i.test(dataUrl)) {
            showAlert('Please upload a valid image file.', { iconType: 'warning' });
            return;
        }

        pendingCashBoxLogo = dataUrl;
        pendingCashBoxLogoSettings = normalizeLogoSettings({ scale: 1, x: 0, y: 0 });
        showCashBoxLogo(dataUrl);
        reloadIframe();
    };
    reader.readAsDataURL(file);
    try { e.target.value = ''; } catch (_) {}
});

cbLogoRemoveBtn?.addEventListener('click', () => {
    pendingCashBoxLogo = ''; // empty string = explicitly removed
    pendingCashBoxLogoSettings = normalizeLogoSettings({ scale: 1, x: 0, y: 0 });
    showCashBoxLogo('');
    if (cbLogoFileInput) cbLogoFileInput.value = '';
    reloadIframe();
});

const updateCashBoxLogoScale = (delta) => {
    if (!cbLogoCanvas || !cbLogoCanvas.classList.contains('has-logo')) return;
    const current = getEffectiveCashBoxLogoSettings();
    setCashBoxLogoSettings({
        ...current,
        scale: clampLogoScale(Number(current.scale) + delta)
    }, true, true);
};

cbLogoZoomIn?.addEventListener('click', () => updateCashBoxLogoScale(0.1));
cbLogoZoomOut?.addEventListener('click', () => updateCashBoxLogoScale(-0.1));

if (cbLogoCanvas) {
    cbLogoCanvas.style.cursor = 'grab';
    cbLogoCanvas.addEventListener('mousedown', (event) => {
        if (!cbLogoCanvas.classList.contains('has-logo')) return;
        cbLogoDragActive = true;
        cbLogoDragStartX = event.clientX;
        cbLogoDragStartY = event.clientY;
        cbLogoDragBaseSettings = getEffectiveCashBoxLogoSettings();
        cbLogoCanvas.style.cursor = 'grabbing';
        event.preventDefault();
    });
}

document.addEventListener('mousemove', (event) => {
    if (!cbLogoDragActive) return;
    const nextSettings = {
        ...cbLogoDragBaseSettings,
        x: cbLogoDragBaseSettings.x + (event.clientX - cbLogoDragStartX),
        y: cbLogoDragBaseSettings.y + (event.clientY - cbLogoDragStartY)
    };
    pendingCashBoxLogoSettings = normalizeLogoSettings(nextSettings);
    applyCashBoxLogoTransform();
});

document.addEventListener('mouseup', () => {
    if (!cbLogoDragActive) return;
    cbLogoDragActive = false;
    if (cbLogoCanvas) cbLogoCanvas.style.cursor = 'grab';
    setCashBoxLogoSettings(getEffectiveCashBoxLogoSettings(), true, true);
});

// ===== INIT =====
window.addEventListener('DOMContentLoaded', function() {
    applyReceiptMode('quick');

    const receiptFrame = document.getElementById('receiptFrame');
    if (receiptFrame) {
        receiptFrame.addEventListener('load', () => {
            scheduleZoomUpdate();
        });
    }

    scheduleZoomUpdate();

    // Cash box logo is loaded by loadCashBoxData via window.setCashBoxLogo
});

// Called from cash-box-settings-data.js after loading cash box data
window.setCashBoxLogo = function(dataUrl) {
    loadedCashBoxLogo = String(dataUrl || '').trim();
    pendingCashBoxLogo = null;
    const keyId = String(currentCashBoxData?.id || '').trim();
    loadedCashBoxLogoSettings = readStoredCashBoxLogoSettings(keyId, true);
    pendingCashBoxLogoSettings = null;
    showCashBoxLogo(loadedCashBoxLogo);
};

// Expose for buildReceiptUrl
window.getCashBoxLogo = function() {
    // pendingCashBoxLogo: null=no change (use loaded), ''=removed, 'data:...'=new
    if (pendingCashBoxLogo !== null) return pendingCashBoxLogo;
    return loadedCashBoxLogo || currentCashBoxData?.cash_box_logo_url || '';
};

// Expose for save logic: only persist when user explicitly changed logo in this session
window.getCashBoxLogoPendingState = function() {
    return pendingCashBoxLogo;
};

window.getCashBoxLogoSettings = function() {
    return { ...getEffectiveCashBoxLogoSettings() };
};

window.getCashBoxLogoSettingsPendingState = function() {
    return pendingCashBoxLogoSettings ? { ...pendingCashBoxLogoSettings } : null;
};

window.persistCashBoxLogoSettings = function(cashBoxId) {
    const keyId = String(cashBoxId || currentCashBoxData?.id || '').trim();
    if (!keyId) return;
    const settings = getEffectiveCashBoxLogoSettings();
    writeStoredCashBoxLogoSettings(keyId, settings);
    loadedCashBoxLogoSettings = normalizeLogoSettings(settings);
    pendingCashBoxLogoSettings = null;
};

loadedCashBoxLogoSettings = readStoredCashBoxLogoSettings('', true);
applyCashBoxLogoTransform();

// Cleanup temp logo keys on page leave
window.addEventListener('beforeunload', () => {
    try {
        localStorage.removeItem('spendnote.cashBoxLogo.temp');
        const cbId = currentCashBoxData?.id;
        if (cbId) localStorage.removeItem('spendnote.cbLogo.' + cbId);
    } catch (_) {}
});
</script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js?v=20260216-2236"></script>
<script src="assets/js/auth-guard.js"></script>
<script src="assets/js/modal-dialogs.js?v=20260208-1900"></script>
<script src="assets/js/nav-loader.js?v=8"></script>
<script>loadNav();</script>
<script src="assets/js/main.js?v=21"></script>
<script src="assets/js/cash-box-settings-data.js?v=44"></script>
</body>
</html>
