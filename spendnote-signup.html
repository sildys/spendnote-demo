semmi<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QPFM30F86Q"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-QPFM30F86Q');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Sign up for SpendNote - Start managing your cash receipts today.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Sign Up - SpendNote</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=23">
    <style>
        /* ===== SIGNUP PAGE SPECIFIC STYLES ===== */
        
        /* PREVIEW BANNER */
        .preview-banner {
            position: sticky;
            top: 0;
            z-index: 9999;
            background: linear-gradient(90deg, #0f172a, #1f2937 45%, #0f766e 100%);
            color: #ffffff;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
        }

        .preview-banner-inner {
            max-width: var(--max-width-page);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            font-size: 0.98rem;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .preview-banner-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            font-size: 0.78rem;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(16, 185, 129, 0.18);
            border: 1px solid rgba(16, 185, 129, 0.35);
        }

        .preview-banner-text {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .preview-banner-toggle {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .preview-banner-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .preview-banner-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 0;
        }

        .preview-banner-details.expanded {
            max-height: 500px;
            margin-top: 16px;
        }

        .preview-banner-details-inner {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .preview-benefits-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-benefits-section {
            margin-bottom: 16px;
        }

        .preview-benefits-section:last-child {
            margin-bottom: 0;
        }

        .preview-benefits-section h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        .preview-benefits-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .preview-benefits-list li {
            padding: 6px 0;
            padding-left: 24px;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.85);
        }

        .preview-benefits-list li::before {
            content: '-';
            position: absolute;
            left: 8px;
            color: #10b981;
            font-weight: 700;
        }

        .preview-banner-text strong {
            color: #fcd34d;
        }

        @media (max-width: 860px) {
            .preview-banner-inner {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* AUTH CONTAINER */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 4px 24px var(--shadow);
        }

        /* LOGO */
        .auth-logo {
            text-align: center;
            margin-bottom: 16px;
        }

        .logo-mark {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .logo-mark svg {
            width: 32px;
            height: 32px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 900;
            color: var(--text);
            letter-spacing: -0.03em;
        }

        /* HEADER */
        .auth-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .auth-title {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }

        .auth-subtitle {
            color: var(--text-muted);
            font-size: 13px;
        }

        /* FORM */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-hint {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* PASSWORD STRENGTH */
        .password-strength {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .strength-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .strength-bar.active {
            background: var(--primary);
        }

        .strength-bar.medium {
            background: #f59e0b;
        }

        .strength-bar.weak {
            background: var(--error);
        }

        .strength-text {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* CHECKBOX */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .checkbox-input {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text);
            flex: 1;
        }

        .checkbox-label a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .checkbox-label a:hover {
            text-decoration: underline;
        }

        /* BUTTON */
        /* DIVIDER */
        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 14px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider-text {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* SOCIAL BUTTONS */
        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-social {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-social:hover {
            border-color: var(--text);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-social i {
            font-size: 18px;
        }

        .btn-google {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-google:hover {
            border-color: #4285f4;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.2);
        }

        /* FOOTER LINK */
        .auth-footer {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* ERROR MESSAGE */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--error);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* SUCCESS MESSAGE */
        .success-message {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--success);
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .password-field {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            padding: 6px;
            line-height: 1;
        }

        .password-toggle:hover {
            color: var(--text);
        }

        /* RESPONSIVE */
        @media (max-width: 640px) {
            .auth-card {
                padding: 32px 24px;
            }

            .auth-title {
                font-size: 24px;
            }
        }
    </style></head>
<body>
<div class="preview-banner" role="status" aria-live="polite">
    <div class="preview-banner-inner">
        <span class="preview-banner-title"><i class="fas fa-flag"></i> Preview</span>
        <div class="preview-banner-text">
            <span>You're using early access. <strong>Things might change</strong> as we improve based on your feedback.</span>
            <button class="preview-banner-toggle" onclick="togglePreviewDetails()">
                <span id="previewToggleText">Show preview benefits</span>
                <i class="fas fa-chevron-down" id="previewToggleIcon"></i>
            </button>
        </div>
    </div>
    <div class="preview-banner-details" id="previewDetails">
        <div class="preview-banner-details-inner">
            <div class="preview-benefits-title">
                <i class="fas fa-gift"></i> Preview Release Benefits
            </div>
            <div class="preview-benefits-section">
                <h4>During Preview:</h4>
                <ul class="preview-benefits-list">
                    <li><strong>200 transactions included</strong> (vs. standard 20 in Free plan)</li>
                    <li>Access to all currently available features</li>
                    <li>Help shape the product with your feedback - <a href="mailto:feedback@spendnote.app" style="color: #10b981; text-decoration: underline;">feedback@spendnote.app</a></li>
                </ul>
            </div>
            <div class="preview-benefits-section">
                <h4>At Launch:</h4>
                <ul class="preview-benefits-list">
                    <li>Your account converts to Free plan (20 transactions)</li>
                    <li><strong>Exclusive: 30% discount coupon for 2 years</strong> on any paid plan</li>
                    <li>Priority support as an early adopter</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<script>
function togglePreviewDetails() {
    const details = document.getElementById('previewDetails');
    const icon = document.getElementById('previewToggleIcon');
    const text = document.getElementById('previewToggleText');
    
    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        icon.className = 'fas fa-chevron-down';
        text.textContent = 'Show preview benefits';
    } else {
        details.classList.add('expanded');
        icon.className = 'fas fa-chevron-up';
        text.textContent = 'Hide details';
    }
}
</script>
    <div class="auth-container">
        <div class="auth-card">
            <!-- Logo -->
            <div class="auth-logo">
                <a href="/" class="logo-mark">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4 C10.895 4 10 4.895 10 6 L10 38 L12 36 L14 38 L16 36 L18 38 L20 36 L22 38 L24 36 L26 38 L28 36 L30 38 L32 36 L34 38 L36 36 L38 38 L38 6 C38 4.895 37.105 4 36 4 Z" fill="url(#logo-gradient)"/>
                        <path d="M32 4 L38 10 L32 10 Z" fill="#000000" opacity="0.25"/>
                        <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
                        <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="logo-gradient" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#059669"/>
                                <stop offset="100%" stop-color="#10b981"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="logo-text">SpendNote</span>
                </a>
            </div>

            <!-- Header -->
            <div class="auth-header">
                <h1 class="auth-title">Create your account</h1>
                <p class="auth-subtitle">Start tracking cash receipts in 30 seconds</p>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> Error message will appear here
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> Account created! Redirecting...
            </div>

            <!-- Form -->
            <form class="auth-form" id="signupForm">
                <div class="form-group">
                    <label class="form-label" for="fullName">Full name</label>
                    <input 
                        type="text" 
                        id="fullName" 
                        class="form-input" 
                        placeholder="John Doe"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        class="form-input" 
                        placeholder="you@example.com"
                        required
                    >
                    <p style="margin-top: 6px; font-size: 0.85rem; color: var(--text-muted);">
                        If you were invited, use the same email address. The same email cannot create a separate account - it adds access to the invited workspace.
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <div class="password-field">
                        <input 
                            type="password" 
                            id="password" 
                            class="form-input" 
                            placeholder="Use at least 1 number or symbol"
                            required
                            minlength="8"
                        >
                        <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                    </div>
                    <span class="strength-text" id="strengthText"></span>
                </div>

                <div class="checkbox-group">
                    <input 
                        type="checkbox" 
                        id="terms" 
                        class="checkbox-input"
                        required
                    >
                    <label class="checkbox-label" for="terms">
                        I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input
                        type="checkbox"
                        id="previewDisclaimer"
                        class="checkbox-input"
                        required
                    >
                    <label class="checkbox-label" for="previewDisclaimer">
                        I understand this is a preview release (desktop-only) and features may change without notice.
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">
                    Create account
                </button>
            </form>

            <!-- Divider -->
            <div class="divider">
                <span class="divider-text">Or continue with</span>
            </div>

            <!-- Social Buttons -->
            <div class="social-buttons">
                <button type="button" class="btn-social btn-google" id="googleBtn">
                    <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
  <path d="M17.64 9.20455c0-.63864-.05727-1.25227-.16364-1.84091H9v3.48182h4.84364c-.20818 1.125-.84273 2.07818-1.79455 2.71636v2.25818h2.90545c1.70182-1.56636 2.68545-3.87273 2.68545-6.61545z" fill="#4285F4"/>
  <path d="M9 18c2.43 0 4.46727-.80545 5.95636-2.18182l-2.90545-2.25818c-.80545.54-1.83455.85909-3.05091.85909-2.34545 0-4.32818-1.58364-5.03636-3.71091H.95727v2.33273C2.43818 15.98364 5.48182 18 9 18z" fill="#34A853"/>
  <path d="M3.96364 10.70818c-.18-.54-.28227-1.11636-.28227-1.70818s.10227-1.16818.28227-1.70818V4.95909H.95727C.34727 6.17364 0 7.54727 0 9s.34727 2.82636.95727 4.04091l3.00637-2.33273z" fill="#FBBC05"/>
  <path d="M9 3.57955c1.32182 0 2.50727.45455 3.44 1.34636l2.58182-2.58182C13.46364.89182 11.42636 0 9 0 5.48182 0 2.43818 2.01636.95727 4.95909l3.00637 2.33273C4.67182 5.16364 6.65455 3.57955 9 3.57955z" fill="#EA4335"/>
</svg>
                    Sign up with Google
                </button>
            </div>

            <!-- No Card Disclaimer - HIDDEN to save space -->
            <div style="display: none;">
                <i class="fas fa-check-circle" style="color: var(--success);"></i>
                No credit card required
            </div>

            <!-- Footer -->
            <div class="auth-footer">
                Already have an account? <a id="loginLink" href="spendnote-login.html">Log in</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260227-1630"></script>
    <script>
        const ensureProfile = async () => {
            try {
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error || !user) return;

                try {
                    const { data: existing, error: selErr } = await window.supabaseClient
                        .from('profiles')
                        .select('id')
                        .eq('id', user.id)
                        .single();
                    if (!selErr && existing?.id) return;
                } catch (_) {}

                const email = String(user.email || '').trim();
                const fullName = String(user.user_metadata?.full_name || '').trim() || (email ? email.split('@')[0] : 'User');
                if (!email) return;

                try {
                    await window.supabaseClient
                        .from('profiles')
                        .insert([{ id: user.id, email, full_name: fullName, subscription_tier: 'preview', billing_status: 'preview' }]);
                } catch (_) {}
            } catch (_) {}
        };

        const acceptInviteToken = async (inviteToken) => {
            if (!inviteToken || !window.supabaseClient?.rpc) {
                console.warn('[signup-invite] skip: no token or no rpc');
                return;
            }
            console.warn('[signup-invite] acceptInviteToken called, token length=' + inviteToken.length);
            try {
                await ensureProfile();
                console.warn('[signup-invite] ensureProfile done');
            } catch (ep) { console.warn('[signup-invite] ensureProfile err:', ep); }
            try {
                console.warn('[signup-invite] calling v2...');
                const r = await window.supabaseClient.rpc('spendnote_accept_invite_v2', { p_token: inviteToken });
                console.warn('[signup-invite] v2 result:', JSON.stringify({ data: r?.data, error: r?.error }));
                if (r?.error) throw r.error;
                try {
                    await window.auth?.sendUserEventEmail?.({ eventType: 'invite_accepted_admin', inviteToken });
                } catch (_) {}
                console.warn('[signup-invite] SUCCESS v2');
            } catch (e1) {
                console.error('[signup-invite] v2 failed:', e1?.message || e1);
                try {
                    const r2 = await window.supabaseClient.rpc('spendnote_accept_invite', { p_token: inviteToken });
                    console.warn('[signup-invite] fallback result:', JSON.stringify({ data: r2?.data, error: r2?.error }));
                    if (r2?.error) throw r2.error;
                    try {
                        await window.auth?.sendUserEventEmail?.({ eventType: 'invite_accepted_admin', inviteToken });
                    } catch (_) {}
                    console.warn('[signup-invite] SUCCESS fallback');
                } catch (e2) {
                    console.error('[signup-invite] BOTH FAILED v2:', e1?.message || e1, 'fb:', e2?.message || e2);
                }
            }
        };

        const __spendnoteTryCloseSignupTab = () => {
            try { window.close(); } catch (_) {}
            try { window.location.href = 'index.html?confirmed=1'; } catch (_) {}
        };

        const __spendnoteHandleAuthConfirmedSignal = (value) => {
            const ts = Number(value);
            if (!Number.isFinite(ts) || ts <= 0) return;
            if (Date.now() - ts > 10 * 60 * 1000) return;
            try { localStorage.removeItem('spendnote.auth.confirmed.v1'); } catch (_) {}
            __spendnoteTryCloseSignupTab();
        };

        // Wait for DOM and scripts to load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                __spendnoteHandleAuthConfirmedSignal(localStorage.getItem('spendnote.auth.confirmed.v1'));
            } catch (_) {}
            try {
                window.addEventListener('storage', (e) => {
                    try {
                        if (!e || e.key !== 'spendnote.auth.confirmed.v1') return;
                        __spendnoteHandleAuthConfirmedSignal(e.newValue);
                    } catch (_) {}
                });
            } catch (_) {}
            try {
                const sp = new URLSearchParams(window.location.search);
                const inviteToken = String(sp.get('inviteToken') || '').trim();
                const invitedEmail = String(sp.get('invitedEmail') || '').trim();
                if (inviteToken && invitedEmail) {
                    const emailEl = document.getElementById('email');
                    if (emailEl) {
                        emailEl.value = invitedEmail;
                        emailEl.readOnly = true;
                    }
                }
                if (inviteToken) {
                    const loginLink = document.getElementById('loginLink');
                    if (loginLink) {
                        let href = 'spendnote-login.html?inviteToken=' + encodeURIComponent(inviteToken);
                        if (invitedEmail) href += '&invitedEmail=' + encodeURIComponent(invitedEmail);
                        loginLink.href = href;
                    }
                }
            } catch (_) {}
            // Check if already logged in
            try {
                await (window.__spendnoteAuthCallbackPromise || Promise.resolve());
            } catch (_) {
            }
            const user = await auth.getCurrentUser();
            if (user) {
                try {
                    const sp = new URLSearchParams(window.location.search);
                    const inviteToken = sp.get('inviteToken');
                    await acceptInviteToken(inviteToken);
                } catch (_) {

                }
                window.location.href = '/app';
            }

            // Password strength indicator
        const passwordInput = document.getElementById('password');
        const passwordToggle = document.getElementById('passwordToggle');
        const strengthBars = document.querySelectorAll('.strength-bar');
        const strengthText = document.getElementById('strengthText');

        if (passwordToggle && passwordInput) {
            passwordToggle.addEventListener('click', () => {
                const isPw = passwordInput.getAttribute('type') === 'password';
                passwordInput.setAttribute('type', isPw ? 'text' : 'password');
                const icon = passwordToggle.querySelector('i');
                if (icon) {
                    icon.className = isPw ? 'fas fa-eye-slash' : 'fas fa-eye';
                }
            });
        }

        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            // Reset bars
            strengthBars.forEach(bar => {
                bar.classList.remove('active', 'weak', 'medium');
            });

            // Set strength
            if (strength >= 1) {
                strengthBars[0].classList.add('active', 'weak');
                strengthText.textContent = 'Weak password';
                strengthText.style.color = 'var(--error)';
            }
            if (strength >= 2) {
                strengthBars[1].classList.add('active', 'medium');
                strengthText.textContent = 'Fair password';
                strengthText.style.color = '#f59e0b';
            }
            if (strength >= 3) {
                strengthBars[2].classList.add('active');
                strengthText.textContent = 'Good password';
                strengthText.style.color = 'var(--success)';
            }
            if (strength >= 4) {
                strengthBars[3].classList.add('active');
                strengthText.textContent = 'Strong password';
                strengthText.style.color = 'var(--success)';
            }
            
            if (password.length === 0) {
                strengthText.textContent = '';
            }
        });

        function calculatePasswordStrength(password) {
            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            return Math.min(strength, 4);
        }

        // Form submission
        const signupForm = document.getElementById('signupForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        signupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Hide messages
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');

            // Get form data
            const fullName = document.getElementById('fullName').value;
            let email = document.getElementById('email').value;
            try {
                const sp = new URLSearchParams(window.location.search);
                const inviteToken = String(sp.get('inviteToken') || '').trim();
                const invitedEmail = String(sp.get('invitedEmail') || '').trim();
                if (inviteToken && invitedEmail) {
                    email = invitedEmail;
                }
            } catch (_) {}
            const password = document.getElementById('password').value;
            const terms = document.getElementById('terms').checked;
            const previewDisclaimer = document.getElementById('previewDisclaimer').checked;

            // Validate
            if (!terms) {
                showError('Please agree to the Terms of Service');
                return;
            }

            if (!previewDisclaimer) {
                showError('Please acknowledge the preview release disclaimer');
                return;
            }

            if (window.SpendNotePasswordPolicy) {
                const pv = window.SpendNotePasswordPolicy.validate(password);
                if (!pv.valid) { showError(pv.message); return; }
            } else if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }

            // Disable button
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating account...';

            try {
                // Sign up with Supabase
                const sp = new URLSearchParams(window.location.search);
                const inviteToken = sp.get('inviteToken');
                const redirectBase = `${window.location.origin}/spendnote-login.html?confirmed=1`;
                const emailRedirectTo = inviteToken
                    ? `${redirectBase}&inviteToken=${encodeURIComponent(inviteToken)}`
                    : redirectBase;

                const result = await auth.signUp(email, password, fullName, { emailRedirectTo });
                
                if (result.success && Array.isArray(result.user?.identities) && result.user.identities.length === 0) {
                    showExistingEmailError(email);
                    return;
                }

                if (result.success) {
                    if (result.needsEmailConfirmation || !result.session) {
                        successMessage.classList.add('show');
                        const emailSafe = String(email || '').trim();
                        successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Account created. Please check your email to confirm your address, then come back to log in.';

                        const wrap = document.createElement('div');
                        wrap.style.marginTop = '10px';
                        wrap.style.display = 'flex';
                        wrap.style.gap = '10px';
                        wrap.style.alignItems = 'center';
                        wrap.style.justifyContent = 'center';
                        wrap.style.flexWrap = 'wrap';

                        const resendBtn = document.createElement('button');
                        resendBtn.type = 'button';
                        resendBtn.className = 'btn btn-secondary';
                        resendBtn.textContent = 'Resend confirmation email';
                        resendBtn.addEventListener('click', async () => {
                            try {
                                const sp = new URLSearchParams(window.location.search);
                                const inviteToken = sp.get('inviteToken');
                                const redirectBase = `${window.location.origin}/spendnote-login.html?confirmed=1`;
                                const emailRedirectTo = inviteToken
                                    ? `${redirectBase}&inviteToken=${encodeURIComponent(inviteToken)}`
                                    : redirectBase;
                                const r = await auth.resendSignupConfirmation(emailSafe, { emailRedirectTo });
                                if (!r?.success) {
                                    showError(r?.error || 'Failed to resend confirmation email.');
                                    return;
                                }
                                successMessage.classList.add('show');
                                successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Confirmation email sent. Please check your inbox.';
                            } catch (_) {
                                showError('Failed to resend confirmation email.');
                            }
                        });

                        wrap.appendChild(resendBtn);
                        successMessage.appendChild(wrap);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Create account';
                        return;
                    }

                    try {
                        await acceptInviteToken(inviteToken);
                    } catch (_) {

                    }

                    // Success
                    successMessage.classList.add('show');
                    successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Account created! Redirecting...';
                    
                    setTimeout(() => {
                        window.location.href = 'spendnote-welcome.html';
                    }, 1000);
                } else {
                    // Error
                    if (String(result.error || '').toLowerCase().includes('already registered')) {
                        showExistingEmailError(email);
                        return;
                    }
                    showError(result.error || 'Failed to create account. Please try again.');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        });

        function showError(message) {
            errorMessage.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
            
            const submitBtn = signupForm.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create account';
        }

        function showExistingEmailError(email) {
            const emailSafe = String(email || '').trim();
            errorMessage.innerHTML = '<i class="fas fa-exclamation-circle"></i> This email is already registered. Please log in instead. (If you received an invite for this email, ask to resend it to a different address - the same email can-t be registered twice.)';
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');

            const wrap = document.createElement('div');
            wrap.style.marginTop = '10px';
            wrap.style.display = 'flex';
            wrap.style.gap = '10px';
            wrap.style.alignItems = 'center';
            wrap.style.justifyContent = 'center';
            wrap.style.flexWrap = 'wrap';

            const loginBtn = document.createElement('button');
            loginBtn.type = 'button';
            loginBtn.className = 'btn btn-primary';
            loginBtn.textContent = 'Log in';
            loginBtn.addEventListener('click', () => {
                window.location.href = 'spendnote-login.html';
            });

            const resetBtn = document.createElement('button');
            resetBtn.type = 'button';
            resetBtn.className = 'btn btn-secondary';
            resetBtn.textContent = 'Send password reset';
            resetBtn.addEventListener('click', async () => {
                try {
                    const r = await auth.resetPassword(emailSafe);
                    if (!r?.success) {
                        showError(r?.error || 'Failed to send password reset email.');
                        return;
                    }
                    errorMessage.innerHTML = '<i class="fas fa-check-circle"></i> Password reset email sent. Please check your inbox.';
                    errorMessage.classList.add('show');
                } catch (_) {
                    showError('Failed to send password reset email.');
                }
            });

            wrap.appendChild(loginBtn);
            wrap.appendChild(resetBtn);
            errorMessage.appendChild(wrap);

            const submitBtn = signupForm.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create account';
        }

        // Google sign up
        document.getElementById('googleBtn').addEventListener('click', async function() {
            const googleBtn = document.getElementById('googleBtn');
            const termsChecked = Boolean(document.getElementById('terms')?.checked);
            const previewChecked = Boolean(document.getElementById('previewDisclaimer')?.checked);

            if (!termsChecked || !previewChecked) {
                showError('Please accept Terms and the preview notice before continuing with Google.');
                return;
            }

            const originalText = googleBtn.textContent;
            googleBtn.disabled = true;
            googleBtn.textContent = 'Redirecting...';

            try {
                const sp = new URLSearchParams(window.location.search);
                const inviteToken = sp.get('inviteToken');
                const redirectUrl = new URL(`${window.location.origin}/spendnote-welcome.html`);
                if (inviteToken) {
                    redirectUrl.searchParams.set('inviteToken', inviteToken);
                }

                const { error } = await window.supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectUrl.toString(),
                        queryParams: {
                            prompt: 'select_account'
                        }
                    }
                });

                if (error) {
                    showError(error.message || 'Google sign up failed. Please try again.');
                    googleBtn.disabled = false;
                    googleBtn.textContent = originalText;
                }
            } catch (error) {
                showError('Google sign up failed. Please try again.');
                googleBtn.disabled = false;
                googleBtn.textContent = originalText;
            }
        });
        }); // Close DOMContentLoaded
    </script>
</body>
</html>
