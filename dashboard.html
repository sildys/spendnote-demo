<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SpendNote Dashboard - Manage your cash receipts, transactions, and Cash Boxes in one place.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Dashboard - SpendNote</title>
    <script>
        (function() {
            try {
                document.documentElement.classList.add('dashboard-loading');
                var c = localStorage.getItem('activeCashBoxColor');
                var r = localStorage.getItem('activeCashBoxRgb');
                if (c && r) {
                    document.documentElement.style.setProperty('--active', c);
                    document.documentElement.style.setProperty('--active-rgb', r);
                }
            } catch (e) {}
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=10">
    <link rel="stylesheet" href="assets/css/app-layout.css?v=9">
    <style>
        /* ===== DASHBOARD PAGE SPECIFIC STYLES ===== */
        
        /* TOP NAV */
        .top-nav {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            box-shadow: 0 2px 16px var(--shadow);
        }

        /* MODERN LOGO */
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 900;
            color: var(--text);
            letter-spacing: -0.03em;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        .logo-icon::before {
            content: 'S';
            font-size: 22px;
            font-weight: 900;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .logo-icon::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 2px;
            background: white;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 1px;
        }
        .logo-text {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo img {
            height: 20px;
            width: auto;
        }

        /* Nav links styles now in app-layout.css */
        
        /* Compact invite banner */
        .invite-banner-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: rgba(99,102,241,0.06);
            border: 1px solid rgba(99,102,241,0.15);
            border-radius: 10px;
            margin: 0 0 20px 0;
            font-size: 14px;
            color: var(--text);
        }
        .invite-banner-compact > i { color: #6366f1; font-size: 14px; }
        .invite-banner-compact span { flex: 1; }
        .invite-btn-compact {
            padding: 6px 14px;
            background: rgba(99,102,241,0.12);
            border: 1px solid rgba(99,102,241,0.25);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #4f46e5;
            cursor: pointer;
            transition: all 0.2s;
        }
        .invite-btn-compact:hover { background: rgba(99,102,241,0.2); }
        .dismiss-btn-compact {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .dismiss-btn-compact:hover { background: rgba(0,0,0,0.05); color: var(--text); }
        
        .nav-link {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 12px;
            transition: all 0.2s ease;
            font-size: 14px;
            background: transparent;
            border: none;
        }
        .nav-link:hover { color: var(--text); background: var(--surface-elevated); }
        .nav-link.active { color: white; background: var(--active); }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--surface-elevated);
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid var(--border);
        }

        /* Cash Box CARDS */
        /* OLD - not used anymore
        .registers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        */
        .register-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .register-card .register-quick-actions {
            pointer-events: none;
        }

        .register-card.active .register-quick-actions {
            pointer-events: auto;
        }
        .register-card::before{
            content: none;
        }
        .register-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        .register-card.active {
            border: 2px solid var(--card-color, var(--active));
            background: linear-gradient(135deg, #ffffff 0%, rgba(var(--card-rgb, var(--active-rgb)), 0.04) 100%);
            box-shadow: 0 4px 16px rgba(var(--card-rgb, var(--active-rgb)), 0.2);
        }
        .register-card.active:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(var(--card-rgb, var(--active-rgb)), 0.25);
        }
        .register-card.active::before { opacity: 0.06; }

        .register-quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            justify-content: flex-end;
        }

        .register-quick-btn {
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid;
            background: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 104px;
        }

        .register-quick-btn.in {
            --quick-accent: #059669;
            color: var(--quick-accent);
            border-color: var(--quick-accent);
            background: white;
        }

        .register-quick-btn.out {
            --quick-accent: var(--out);
            color: var(--quick-accent);
            border-color: var(--quick-accent);
            background: white;
        }

        .register-quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .register-quick-btn.in:hover {
            background: rgba(5, 150, 105, 0.06);
            border-color: var(--quick-accent);
        }

        .register-quick-btn.out:hover {
            background: rgba(var(--out-rgb), 0.08);
            border-color: var(--quick-accent);
        }

        .register-quick-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .register-quick-btn .quick-icon {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--quick-accent);
            color: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            flex-shrink: 0;
        }

        .register-quick-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .register-quick-btn .quick-label {
            font-weight: 800;
            letter-spacing: 0.02em;
        }

        /* UNIFIED CARD STRUCTURE - SAME AS CASH BOX LIST */
        .register-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .register-header-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .register-actions {
            display: flex;
            gap: 8px;
        }

        .register-kebab {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s ease;
            cursor: pointer;
            text-decoration: none;
        }

        .register-kebab:hover {
            background: var(--surface-elevated);
            color: var(--text);
        }

        .register-name {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.01em;
            margin-bottom: 4px;
            position: relative;
            padding-left: 16px;
            color: var(--text);
            line-height: 1.1;
        }

        .register-card .register-name {
            font-size: 24px !important;
            font-weight: 900 !important;
        }

        .register-name::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--card-color, var(--active));
            box-shadow: 0 0 0 2px rgba(var(--card-rgb, var(--active-rgb)), 0.14);
        }

        /* Support for icon color classes */
        .register-card .register-name::before {
            background: var(--card-color, var(--active));
        }
        .register-card .register-icon.green { color: #059669; }
        .register-card .register-icon.orange { color: #f59e0b; }
        .register-card .register-icon.blue { color: #3b82f6; }
        .register-card .register-icon.purple { color: #8b5cf6; }
        .register-card .register-icon.red { color: #ef4444; }

        /* OLD STRUCTURE SUPPORT (deprecated) */
        .register-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .register-info {
            flex: 1;
            min-width: 0;
        }
        .register-info h3 {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text);
            position: relative;
            padding-left: 16px;
        }
        .register-info h3::before{
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--card-color, var(--active));
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 0 2px rgba(var(--card-rgb, var(--active-rgb)), 0.14);
        }
        .register-id {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            font-family: monospace;
            background: transparent;
            border: 1px solid var(--border);
            padding: 3px 8px;
            border-radius: 999px;
            display: inline-block;
        }
        .register-icon {
            width: 72px !important;
            height: 72px !important;
            border-radius: 18px !important;
            background: linear-gradient(
                135deg,
                rgba(var(--card-rgb, var(--active-rgb)), 0.08) 0%,
                #ffffff 55%,
                rgba(var(--card-rgb, var(--active-rgb)), 0.03) 100%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card-color, var(--active));
            font-size: 32px !important;
            border: 3px solid var(--card-color, var(--active));
            box-shadow: 0 6px 18px rgba(var(--card-rgb, var(--active-rgb)), 0.16);
            text-decoration: none;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .register-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(var(--card-rgb, var(--active-rgb)), 0.20);
        }

        .register-icon-link {
            text-decoration: none;
        }
        .register-balance {
            font-size: 32px;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 16px;
            letter-spacing: -0.04em;
            text-align: right;
        }

        .trend-indicator {
            font-size: 14px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .trend-indicator.up { background: rgba(16,185,129,0.12); color: #059669; }
        .trend-indicator.down { background: rgba(239,68,68,0.12); color: #dc2626; }
        .trend-indicator i { font-size: 12px; }

        .register-stats {
            display: none; /* Hidden - only balance shown */
        }
        .stat-item {
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 14px;
            position: relative;
        }

        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.9);
        }
        .stat-item:hover .tooltip { opacity: 1; }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 800;
        }
        .stat-value.in { color: #10b981; }
        .stat-value.out { color: var(--out); }

        /* CONTEXT ROW */
        .context-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 8px;
            gap: 12px;
        }

        .add-transaction-btn {
            background-color: var(--active);
            background-image: none;
            border: none;
            border-radius: 20px;
            padding: 24px 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
            box-shadow: 0 8px 24px rgba(var(--active-rgb), 0.28);
            position: relative;
        }
        .add-transaction-btn::before { display: none; }
        .add-transaction-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 34px rgba(var(--active-rgb), 0.38);
            filter: brightness(0.96);
        }
        .add-transaction-btn:hover::before { display: none; }
        
        .add-transaction-btn:active {
            transform: translateY(-2px);
            filter: brightness(0.94);
        }
        .add-btn-icon {
            width: 56px;
            height: 56px;
            background: rgba(255,255,255,0.25);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: 900;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .add-btn-text {
            font-size: 20px;
            font-weight: 900;
            color: white;
            line-height: 1.3;
            letter-spacing: -0.02em;
        }

        .context-pill {
            background: linear-gradient(135deg, var(--surface) 0%, rgba(var(--active-rgb), 0.08) 100%);
            border: 2px solid var(--active);
            border-radius: 18px;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 6px 28px rgba(var(--active-rgb), 0.2);
        }
        .context-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 20px;
            border-right: 2px solid var(--border);
            flex-shrink: 0;
        }
        .context-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--active);
            box-shadow: 0 0 20px rgba(var(--active-rgb), 0.6);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }
        .context-text {
            font-size: 15px;
            font-weight: 800;
            color: var(--active);
            white-space: nowrap;
        }
        .context-stats {
            display: flex;
            gap: 20px;
            flex: 1;
            justify-content: space-around;
        }
        .context-stat {
            text-align: center;
            position: relative;
        }
        .context-stat-value {
            font-size: 20px;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 2px;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .context-stat-trend {
            font-size: 12px;
            font-weight: 700;
        }
        .context-stat-trend.up { color: #059669; }
        .context-stat-trend.down { color: #dc2626; }
        .context-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        /* TRANSACTIONS */
        .transactions-card {
            background: var(--surface);
            border: 2px solid rgba(var(--active-rgb), 0.2);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 6px 28px rgba(var(--active-rgb), 0.12);
            width: 100%;
        }
        .transactions-header {
            padding: 16px 32px;
            border-bottom: 2px solid rgba(var(--cashbox-rgb, var(--active-rgb)), 0.25);
            background: transparent;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .transactions-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .view-all-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);
        }
        .view-all-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }
        .view-all-btn i {
            font-size: 13px;
        }

        .filter-toggle-btn {
            padding: 10px 20px;
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-toggle-btn:hover {
            background: var(--surface-elevated);
            border-color: var(--active);
        }
        .filter-toggle-btn.active {
            background: rgba(var(--active-rgb), 0.1);
            color: var(--active);
            border-color: var(--active);
        }
        .filter-toggle-btn i {
            transition: transform 0.3s;
        }
        .filter-toggle-btn.active i {
            transform: rotate(180deg);
        }

        .export-btn {
            padding: 10px 20px;
            background: var(--active);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .filter-panel-wrapper {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .filter-panel-wrapper.expanded {
            max-height: 400px;
        }

        .filter-panel {
            padding: 20px 32px;
            background: linear-gradient(135deg, rgba(var(--active-rgb), 0.02), transparent);
            border-bottom: 2px solid var(--border);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .filter-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-label i {
            font-size: 10px;
            color: var(--active);
        }
        .filter-input {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            background: white;
            transition: all 0.2s;
        }
        .filter-input:focus {
            border-color: var(--active);
            box-shadow: 0 0 0 3px rgba(var(--active-rgb), 0.1);
        }
        .filter-input::placeholder {
            color: var(--text-muted);
            font-weight: 500;
        }

        .amount-range {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .amount-range input {
            flex: 1;
        }
        .amount-range span {
            color: var(--text-muted);
            font-weight: 700;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid var(--border);
            background: white;
            color: var(--text);
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-btn:hover {
            background: var(--surface-elevated);
        }
        .filter-btn.primary {
            background: var(--active);
            color: white;
            border-color: var(--active);
        }
        .filter-btn.primary:hover {
            background: var(--primary-light);
        }
        .filter-btn.clear {
            color: #ef4444;
            border-color: rgba(239,68,68,0.3);
        }
        .filter-btn.clear:hover {
            background: rgba(239,68,68,0.1);
            border-color: #ef4444;
        }

        .filter-tabs {
            display: flex;
            gap: 6px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .filter-tab {
            padding: 8px 18px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .filter-tab:hover { 
            color: var(--text);
            background: var(--surface-elevated);
        }
        .filter-tab.active {
            background: var(--active);
            color: white;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            width: 100%;
        }

        .table-grid {
            display: grid;
            grid-template-columns: 70px 130px 140px 160px 1fr 110px 130px 80px;
            gap: 16px;
            padding: 12px 16px; /* Alacsonyabb (volt: 14px 20px) */
            align-items: center;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        /* Row hover/focus uses cashbox color */
        .table-grid:not(.table-header):hover {
            background: rgba(var(--cashbox-rgb, 5, 150, 105), 0.06);
        }
        .table-grid:not(.table-header):focus {
            background: rgba(var(--cashbox-rgb, 5, 150, 105), 0.1);
            outline: 2px solid var(--cashbox-color, #059669);
            outline-offset: -2px;
            border-radius: 8px;
        }
        .table-grid:hover .row-tooltip { opacity: 1; }
        .table-header {
            font-size: 11px !important;
            color: var(--text-muted) !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.06em !important;
            background: transparent !important;
            border-bottom: 1px solid rgba(var(--cashbox-rgb, var(--active-rgb)), 0.15) !important;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 12px 16px !important;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .table-header:hover { 
            background: rgba(var(--cashbox-rgb, var(--active-rgb)), 0.03) !important;
        }

        .row-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--active);
        }

        .row-tooltip {
            position: absolute;
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 50;
        }
        .row-tooltip strong { color: #10b981; }

        /* Type badge - IN/OUT (subtle table pill) */
        .tx-type {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 0.05em;
            border: 1px solid transparent;
            width: 56px;
            background: transparent;
        }
        .tx-type.in {
            color: #059669;
            background: rgba(5, 150, 105, 0.10);
            border-color: rgba(5, 150, 105, 0.18);
        }
        .tx-type.out {
            color: var(--out);
            background: rgba(var(--out-rgb), 0.10);
            border-color: rgba(var(--out-rgb), 0.18);
        }
        
        /* Cash Box badge */
        .tx-cashbox {
            font-size: 13px;
        }
        .cashbox-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }
        .cashbox-badge::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--cb-color, var(--text-muted));
            flex-shrink: 0;
        }

        .tx-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 800;
        }
        .tx-icon.in {
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.08));
            color: #059669;
            border: 1px solid rgba(16,185,129,0.2);
        }
        .tx-icon.out {
            background: linear-gradient(135deg, rgba(var(--out-rgb),0.15), rgba(var(--out-rgb),0.08));
            color: var(--out);
            border: 1px solid rgba(var(--out-rgb),0.2);
        }
        .tx-receipt {
            font-size: 15px;
            font-weight: 800;
            color: var(--active);
            font-family: monospace;
        }
        .tx-desc {
            font-size: 13px; 
            font-weight: 500; 
            color: var(--text-muted); 
        }
        .tx-person {
            font-size: 14px; 
            color: var(--text); 
            font-weight: 600;
        }
        .tx-amount {
            font-size: 17px;
            font-weight: 900;
            text-align: right;
        }
        .tx-amount.in { color: #10b981; }
        .tx-amount.out { color: var(--out); }
        .tx-datetime {
            font-size: 12px;
            color: var(--text);
            font-weight: 600;
            text-align: left;
            padding-left: 20px;
        }
        .tx-datetime .date {
            display: block;
            font-weight: 700;
        }
        .tx-datetime .time {
            display: block;
            color: var(--text-muted);
        }

        .tx-action {
            padding: 8px 14px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .tx-action:hover {
            background: rgba(5, 150, 105, 0.08);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }
        .tx-action i {
            font-size: 11px;
        }

        .bulk-actions {
            padding: 12px 32px;
            background: rgba(var(--active-rgb), 0.05);
            border-bottom: 2px solid var(--border);
            display: none;
            align-items: center;
            gap: 16px;
        }
        .bulk-actions.active { display: flex; }
        .bulk-actions-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }
        .bulk-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .bulk-action-btn:hover {
            background: var(--active);
            color: white;
            border-color: var(--active);
        }
        .bulk-action-btn.delete {
            color: #ef4444;
            border-color: #ef4444;
        }
        .bulk-action-btn.delete:hover {
            background: #ef4444;
            color: white;
        }

        .table-wrapper::-webkit-scrollbar { width: 10px; }
        .table-wrapper::-webkit-scrollbar-track { background: var(--surface-elevated); }
        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }
        .table-wrapper::-webkit-scrollbar-thumb:hover { background: var(--active); }

        @media (max-width: 1024px) {
            .context-row { grid-template-columns: 1fr; }
            .context-pill { flex-direction: column; gap: 16px; }
            .context-badge { border: none; padding: 0; }
            .filter-grid { grid-template-columns: 1fr; }
        }
    
        /* ===== CAROUSEL STYLES ===== */
        .registers-carousel-section {
            margin-bottom: 30px;
            width: 100%;
            max-width: 100%;
            overflow: visible;
            position: relative;
            padding-top: 8px;
        }

        .carousel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .carousel-title {
            font-size: 18px; /* Section subtitle size */
            font-weight: 700;
            color: var(--text);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .carousel-nav {
            position: absolute;
            top: -50px;
            right: 0;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .carousel-arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-arrow:hover:not(.swiper-button-disabled) {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .carousel-arrow.swiper-button-disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-arrow i {
            color: #6b7280;
            font-size: 16px;
        }

        /* Swiper overrides */
        .registers-swiper {
            padding: 8px 0 50px 0;
            overflow: visible !important;
            width: 100%;
        }

        html.dashboard-loading .registers-swiper {
            opacity: 0;
        }

        html.dashboard-ready .registers-swiper {
            opacity: 1;
            transition: opacity 160ms ease;
        }
        
        .swiper-wrapper {
            display: flex;
            overflow: visible !important;
        }

        .swiper-slide {
            height: auto;
            display: flex;
        }

        .registers-swiper .register-card,
        .registers-swiper .add-cash-box-card {
            margin: 0;
            height: 100%;
            max-width: 420px;
            width: 100%;
            flex: 1;
        }

        /* Pagination */
        .swiper-pagination {
            bottom: 10px !important;
        }

        .swiper-pagination-bullet {
            width: 8px;
            height: 8px;
            background: #d1d5db;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .swiper-pagination-bullet-active {
            background: #10b981;
            width: 24px;
            border-radius: 4px;
        }

        /* Add Cash Box Button */
        .add-register-container {
            text-align: center;
            margin-top: 20px;
        }

        .add-register-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }

        .add-register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
        }

        .add-register-btn i {
            font-size: 18px;
        }


        /* Fix pagination overlap */
        .swiper-pagination {
            bottom: 20px !important;
            position: relative !important;
            margin-top: 20px;
        }

        /* Prevent icon color change on hover */
        .register-card:hover .register-icon i,
        .register-card.active .register-icon i {
            color: inherit;
        }

        
        /* ADD CASH BOX CARD - UNIFIED DESIGN */
        .add-cash-box-card {
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .add-cash-box-card:hover {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.02);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.12);
        }

        .add-cash-box-card.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .add-cash-box-card.disabled:hover {
            border-color: var(--border);
            background: var(--surface);
            transform: none;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .add-cash-box-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(5, 150, 105, 0.1);
            border: 2px solid rgba(5, 150, 105, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .add-cash-box-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 6px;
        }

        .add-cash-box-subtitle {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0;
        }

        .add-cash-box-upgrade {
            margin-top: 12px;
            padding: 10px 18px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            color: #f59e0b;
            font-size: 13px;
            font-weight: 700;
            display: none;
        }

        .add-cash-box-card.disabled .add-cash-box-upgrade {
            display: block;
        }

        .add-cash-box-card.disabled .add-cash-box-subtitle {
            display: none;
        }

        .add-register-message {
            margin-top: 16px;
            text-align: center;
        }

        .add-register-message p {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        
                /* Responsive */
        @media (max-width: 768px) {
            .logo img {
                height: 18px;
            }
            
            .carousel-title {
                font-size: 22px; /* Slightly smaller on mobile */
            }
            
            .carousel-nav {
                display: none;
            }
        }

        /* Site-nav styles now in app-layout.css */
        
/* FOOTER (dashboard specific if needed) */
        footer {
            background: var(--surface);
            padding: 3rem 2rem 2rem;
            border-top: 1px solid var(--border);
        }

        .footer-brand p {
            color: #000000;
            line-height: 1.6;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .newsletter-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .newsletter-form input {
            flex: 1;
            padding: 0.65rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .newsletter-form button {
            padding: 0.65rem 1.25rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 0.9rem;
        }

        .newsletter-form button:hover {
            transform: translateY(-2px);
        }

        .footer-links h4 {
            margin-bottom: 1rem;
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .footer-links ul {
            list-style: none;
        }

        .footer-links a {
            color: #000000;
            text-decoration: none;
            display: block;
            padding: 0.4rem 0;
            transition: color 0.2s;
            font-size: 0.9rem;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .footer-bottom {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            color: #000000;
            font-size: 0.85rem;
        }

        .footer-social {
            display: flex;
            gap: 0.75rem;
        }

        .footer-social a {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(5, 150, 105, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            transition: all 0.2s;
        }

        .footer-social a:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        

        .site-nav .nav-links a.active {
            color: var(--active);
        }

        .site-nav .nav-links a{
            position: relative;
        }
        .site-nav .nav-links a.active::after{
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -6px;
            height: 3px;
            border-radius: 999px;
            background: var(--active);
            opacity: 0.9;
        }

/* ===== End imported ===== */

        /* ===== App topbar enhancements ===== */
        .app-topbar{
            margin: 0 auto;
            max-width: 1400px;
            padding: 18px 20px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: linear-gradient(180deg, rgba(5, 150, 105, 0.06), rgba(255,255,255,0.9));
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        }
        .app-topbar .context-row{
            margin: 0;
        }
        .app-topbar .add-transaction-btn{
            border-radius: 14px;
        }
        .app-topbar .context-pill{
            border-radius: 16px;
            background: rgba(255,255,255,0.85);
        }
        .app-topbar .context-stat-balance .context-stat-value{
            font-size: 1.35rem;
            font-weight: 900;
            letter-spacing: -0.02em;
        }
        .registers-carousel-section {
            margin-top: 0; /* No extra margin, page-header handles spacing */
        }
        /* Carousel navigation moved to top-right of carousel section */


        /* ===== Cash Box card kebab menu (settings/delete) ===== */
.register-top{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:14px;
}

.register-header-left{
  display:flex;
  align-items:flex-start;
  gap:12px;
  min-width:0;
}

.register-icon.small{
  width:34px;
  height:34px;
  border-radius:10px;
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
}

.register-info{
  min-width:0;
}

.register-actions{
  position:relative;
  flex:0 0 auto;
}

.register-kebab{
  width:32px;
  height:32px;
  border-radius:10px;
  border:1px solid var(--border);
  background: rgba(148, 163, 184, 0.10);
  color: var(--text-secondary);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: all .15s ease;
}

.register-kebab:hover{
  background: rgba(148, 163, 184, 0.16);
  color: var(--text);
}

.register-menu{
  position:absolute;
  top: calc(100% + 8px);
  right: 0;
  width: 220px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 8px;
  display:none;
  z-index: 50;
}

.register-menu.open{ display:block; }

.register-menu button{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:10px;
  background:transparent;
  border:0;
  color: var(--text);
  cursor:pointer;
  font-weight:600;
  font-size:14px;
}

.register-menu button:hover{
  background: rgba(148, 163, 184, 0.10);
}

.register-menu .divider{
  height:1px;
  background: var(--border);
  margin: 6px 4px;
}

.register-menu .danger{
  color: var(--danger);
}
.register-menu.open{ display: block; }
        .register-menu button{
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            color: var(--text);
        }
        .register-menu button:hover{ background: rgba(var(--active-rgb), 0.06); }
        .register-menu .danger{
            color: #dc2626;
        }
        .register-menu .danger:hover{
            background: rgba(239, 68, 68, 0.08);
        }
        .register-menu .divider{
            height: 1px;
            background: var(--border);
        }

        .tx-desc, .tx-person, .tx-receipt{
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tx-receipt{ text-align: left; }
        /* Add breathing room between Amount and Date columns */
        .tx-amount{ padding-right: 10px; }
        .tx-datetime{ padding-left: 16px; }
        .tx-action{ width: 100%; text-align: center; }
        .table-header > div{
            white-space: nowrap;
        }
        .table-header > div:nth-child(9){ padding-left: 16px; }


.tx-by{font-size:11px;color:#6b7280;margin-top:2px;}

        /* ===== Invite banner (team tip) ===== */
        .invite-banner{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:16px;
            padding:16px 18px;
            border:2px dashed rgba(99,102,241,0.25);
            background: rgba(99,102,241,0.06);
            border-radius: 16px;
            margin: 14px 0 18px 0;
        }
        .invite-banner-left{
            display:flex;
            align-items:flex-start;
            gap:12px;
            min-width: 0;
        }
        .invite-banner-icon{
            width:28px;
            height:28px;
            display:flex;
            align-items:center;
            justify-content:center;
            color: rgba(5,150,105,0.95);
            flex: 0 0 auto;
            margin-top:2px;
        }
        .invite-banner-title{
            font-weight: 800;
            font-size: 16px;
            color: var(--text);
            margin: 0;
            line-height: 1.2;
        }
        .invite-banner-text{
            margin: 2px 0 0 0;
            color: rgba(15,23,42,0.75);
            font-size: 14px;
            line-height: 1.35;
        }
        .invite-banner-actions{
            display:flex;
            align-items:center;
            gap:10px;
            flex: 0 0 auto;
        }
        .invite-btn{
            border: 1px solid rgba(99,102,241,0.25);
            background: rgba(99,102,241,0.12);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }
        .dismiss-btn{
            border: 1px solid rgba(15,23,42,0.12);
            background: rgba(255,255,255,0.9);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }
        .invite-btn:hover{ filter: brightness(0.98); }
        .dismiss-btn:hover{ filter: brightness(0.98); }

        .tx-createdby{ font-weight:700; color: rgba(15,23,42,0.75); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* --- FIX: Filters wrap into two rows (no overflow) --- */
.filters-row, .filters-grid, .filters-container {
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 10px !important;
}
.filters-row > *, .filters-grid > *, .filters-container > * {
  flex: 1 1 220px !important;
  min-width: 220px !important;
}
@media (min-width: 1100px) {
  .filters-row > *, .filters-grid > *, .filters-container > * {
    flex: 1 1 calc(50% - 10px) !important;
    min-width: 260px !important;
  }
}
/* Ensure filter dropdown panel fits viewport */
.filters-dropdown, .filters-menu, .filter-dropdown-panel {
  max-width: min(920px, 95vw) !important;
  width: auto !important;
}


/* --- FIX: Transactions table fits screen (no horizontal scroll) --- */
.transactions-table, table.transactions-table, .table-transactions {
  width: 100% !important;
  table-layout: fixed !important;
}
.transactions-table th, .transactions-table td,
table.transactions-table th, table.transactions-table td,
.table-transactions th, .table-transactions td {
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}
/* Narrower "Name/Description" style columns */
.transactions-table .col-name, .transactions-table .col-vendor, .transactions-table .col-desc,
.table-transactions .col-name, .table-transactions .col-vendor, .table-transactions .col-desc {
  width: 22% !important;
}
/* Standard widths for other columns */
.transactions-table .col-date, .table-transactions .col-date { width: 12% !important; }
.transactions-table .col-amount, .table-transactions .col-amount { width: 12% !important; text-align: right !important; }
.transactions-table .col-category, .table-transactions .col-category { width: 14% !important; }
.transactions-table .col-cashbox, .table-transactions .col-cashbox { width: 16% !important; }
.transactions-table .col-createdby, .table-transactions .col-createdby { width: 14% !important; }


/* Remove forced horizontal scroll on table wrappers */
.table-responsive, .transactions-table-wrap, .table-wrap {
  overflow-x: visible !important;
}


/* === v23 FIXES === */

/* 1) Kill horizontal scrolling for the transactions table area */
.table-responsive,
.transactions-table-wrap,
.table-wrap,
.table-container,
.recent-transactions .table-responsive,
.recent-transactions .transactions-table-wrap,
.recent-transactions .table-wrap {
  overflow-x: hidden !important;
}

/* Make sure the table can actually fit */
.transactions-table,
table.transactions-table,
.table-transactions,
.recent-transactions table {
  width: 100% !important;
  table-layout: fixed !important;
}

/* Tighter table density */
.transactions-table th,
.transactions-table td,
table.transactions-table th,
table.transactions-table td,
.table-transactions th,
.table-transactions td,
.recent-transactions table th,
.recent-transactions table td {
  padding: 8px 6px !important;
  font-size: 12px !important;
}

/* Default: no-nowrap only where needed; allow wrap on text-heavy columns */
.transactions-table th,
.transactions-table td,
table.transactions-table th,
table.transactions-table td,
.table-transactions th,
.table-transactions td,
.recent-transactions table th,
.recent-transactions table td {
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

/* Allow wrapping on description + date/time so we don't force width */
.transactions-table .col-desc,
.table-transactions .col-desc,
.recent-transactions .col-desc,
.transactions-table .col-date,
.table-transactions .col-date,
.recent-transactions .col-date {
  white-space: normal !important;
  line-height: 1.2 !important;
}

/* Column width map (tuned to avoid horizontal scroll) */
.transactions-table .col-check,
.table-transactions .col-check,
.recent-transactions .col-check { width: 4% !important; }

.transactions-table .col-idx,
.table-transactions .col-idx,
.recent-transactions .col-idx { width: 4% !important; }

.transactions-table .col-type,
.table-transactions .col-type,
.recent-transactions .col-type { width: 6% !important; }

.transactions-table .col-receipt,
.table-transactions .col-receipt,
.recent-transactions .col-receipt { width: 8% !important; }

.transactions-table .col-desc,
.table-transactions .col-desc,
.recent-transactions .col-desc { width: 22% !important; }

.transactions-table .col-from,
.table-transactions .col-from,
.recent-transactions .col-from { width: 12% !important; }

.transactions-table .col-to,
.table-transactions .col-to,
.recent-transactions .col-to { width: 12% !important; }

.transactions-table .col-amount,
.table-transactions .col-amount,
.recent-transactions .col-amount { width: 10% !important; text-align: right !important; }

.transactions-table .col-date,
.table-transactions .col-date,
.recent-transactions .col-date { width: 14% !important; }

.transactions-table .col-createdby,
.table-transactions .col-createdby,
.recent-transactions .col-createdby { width: 10% !important; }

.transactions-table .col-action,
.table-transactions .col-action,
.recent-transactions .col-action { width: 8% !important; }

/* If there is any leftover forced scrollbar, hide it (last resort) */
.recent-transactions,
.recent-transactions .card,
.recent-transactions .card-body {
  overflow-x: hidden !important;
}

/* 2) Remove hover-only "category" labels/tags/badges on rows (not used in Spendnote) */
.category,
.category-tag,
.category-badge,
.row-category,
.badge-category,
.tag-category,
.hover-category,
[class*="categoryTag"],
[class*="category-tag"],
[class*="category_badge"],
[data-category],
[data-category-tag] {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
}

/* If they are shown only on hover, ensure hover doesn't reveal anything */
tr:hover .category,
tr:hover .category-tag,
tr:hover .category-badge,
tr:hover .row-category,
tr:hover [data-category],
tr:hover [data-category-tag] {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
}


/* === v24 FIXES: no horizontal scroll + proper row selection === */

/* Hide any remaining tooltip UI */
.row-tooltip { display: none !important; }

/* Ensure the container never shows a horizontal scrollbar */
.recent-transactions,
.table-container,
.table-wrap,
.transactions-table-wrap {
  overflow-x: hidden !important;
}

/* Proper selected-row styling that spans full width */
.table-grid.is-selected {
  background: rgba(var(--active-rgb), 0.06) !important;
  box-shadow: inset 0 0 0 2px rgba(var(--active-rgb), 0.55) !important;
  border-radius: 12px;
}

/* Hook selection via focus too (keyboard) */
.table-grid:focus-within {
  outline: none;
  box-shadow: inset 0 0 0 2px rgba(var(--active-rgb), 0.35);
}

/* Created by typography: same visual weight as From/To, and short username */
.tx-createdby{
  font-size: 13px !important;
  font-weight: 600 !important;
  color: var(--text-muted) !important;
  text-transform: none !important;
}

/* Keep date/time readable but compact */
.tx-datetime .date { font-size: 13px !important; }
.tx-datetime .time { font-size: 12px !important; }

/* Action button must not overflow */
.tx-action{
  width: 100% !important;
  min-width: 0 !important;
  padding: 10px 12px !important;
  font-size: 13px !important;
  white-space: nowrap !important;
}


/* === v25 FIX: Filters panel layout (2-column grid, no overflow) === */
.filter-panel-wrapper { 
  max-width: min(960px, 95vw) !important;
  width: auto !important;
}
.filter-panel {
  max-width: min(960px, 95vw) !important;
  width: auto !important;
  overflow-x: hidden !important;
}
/* Force filters into two columns on desktop, one on mobile */
.filter-grid {
  display: grid !important;
  grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
  gap: 14px !important;
  align-items: start !important;
}
@media (max-width: 820px) {
  .filter-grid { grid-template-columns: 1fr !important; }
}
/* Amount range: keep inputs inside the card, allow shrink */
.amount-range {
  display: grid !important;
  grid-template-columns: 1fr auto 1fr !important;
  gap: 8px !important;
  align-items: center !important;
}
.amount-range .filter-input { min-width: 0 !important; width: 100% !important; }
/* Ensure filter groups don't force min widths */
.filter-group { min-width: 0 !important; }
.filter-input { min-width: 0 !important; }


/* === v26 TWEAK: Filters in TWO ROWS (3 columns) === */
.filter-grid{
  grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
}
@media (max-width: 1100px){
  .filter-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
}
@media (max-width: 820px){
  .filter-grid{ grid-template-columns: 1fr !important; }
}

/* ===== MODAL ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
 }

 body.modal-open {
     overflow: hidden;
 }

 .modal-overlay.active {
     display: flex;
 }

.modal-container {
    background: white;
    border-radius: 16px;
    max-width: 1200px;
    width: 100%;
    max-height: 92vh;
    overflow-x: hidden;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    margin: auto;
}

/* Modal direction-based background tint */
#createTransactionModalContainer {
    --modal-dir-color: #059669;
    --modal-dir-rgb: 5, 150, 105;
    background: linear-gradient(180deg, rgba(5, 150, 105, 0.08) 0%, white 120px);
}

#createTransactionModalContainer[data-direction="out"] {
    --modal-dir-color: #6b7280;
    --modal-dir-rgb: 107, 114, 128;
    background: linear-gradient(180deg, rgba(107, 114, 128, 0.08) 0%, white 120px);
}

/* Modal Header - single row with watermark */
.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 3px solid rgba(var(--modal-dir-rgb), 0.6);
    background: white;
    position: relative;
    overflow: hidden;
}

.modal-header-left {
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 1;
}

.modal-header-right {
    display: flex;
    align-items: center;
    gap: 14px;
    z-index: 1;
    position: relative;
}

/* Watermark - to the right of cashbox selector */
.modal-watermark {
    font-size: 64px;
    font-weight: 900;
    letter-spacing: 0.08em;
    color: rgba(var(--active-rgb), 0.15);
    pointer-events: none;
    user-select: none;
    line-height: 1;
}

.modal-watermark::after {
    content: "IN";
}

#createTransactionModalContainer[data-direction="out"] .modal-watermark::after {
    content: "OUT";
}

/* Direction buttons */
.modal-direction-primary {
    display: flex;
    gap: 8px;
}

.modal-direction-primary input[type="radio"] {
    display: none;
}

.direction-primary-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
    border: 2px solid var(--border);
    background: white;
    font-size: 13px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    transition: all 0.15s ease;
    height: 48px;
}

.direction-primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.direction-primary-btn:active {
    transform: translateY(0) scale(0.98);
    box-shadow: none;
}

.direction-primary-btn .quick-icon {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.15s ease;
}

.direction-primary-btn.in .quick-icon {
    background: rgba(5, 150, 105, 0.1);
    color: #059669;
}

.direction-primary-btn.out .quick-icon {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

#modalDirectionIn:checked + .direction-primary-btn.in {
    background: #059669;
    border-color: #059669;
    color: white;
}

#modalDirectionIn:checked + .direction-primary-btn.in .quick-icon {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

#modalDirectionOut:checked + .direction-primary-btn.out {
    background: #6b7280;
    border-color: #6b7280;
    color: white;
}

#modalDirectionOut:checked + .direction-primary-btn.out .quick-icon {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

/* Cashbox selector - elegant carousel with arrows inside card */
.cashbox-display {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: white;
    border: 2px solid var(--border);
    border-radius: 10px;
    min-width: 200px;
    height: 48px;
}

.cashbox-display .cashbox-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
    flex-shrink: 0;
}

.cashbox-display .cashbox-info {
    flex: 1;
    min-width: 0;
}

.cashbox-display .cashbox-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.cashbox-display .cashbox-balance {
    font-size: 11px;
    color: var(--text-muted);
}

.cashbox-display .cashbox-arrows {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-left: auto;
}

.cashbox-display .cashbox-arrow {
    width: 18px;
    height: 14px;
    border: none;
    background: var(--surface-elevated);
    border-radius: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 8px;
    transition: all 0.15s;
    padding: 0;
}

.cashbox-display .cashbox-arrow:hover {
    background: var(--active);
    color: white;
}

/* Mode toggle - polished pill style */
.modal-mode-toggle {
    display: inline-flex;
    align-items: center;
    padding: 4px;
    border-radius: 10px;
    background: white;
    border: 2px solid rgba(var(--modal-dir-rgb), 0.2);
    gap: 4px;
}

.modal-mode-toggle input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.modal-mode-toggle label {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 32px;
    padding: 0 16px;
    border-radius: 7px;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.modal-mode-toggle label:hover {
    color: var(--text);
    background: rgba(var(--modal-dir-rgb), 0.05);
}

#modalModeQuick:checked + label,
#modalModeDetailed:checked + label {
    background: var(--modal-dir-color);
    color: white;
    box-shadow: 0 2px 8px rgba(var(--modal-dir-rgb), 0.3);
}

/* Close button */
.modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--surface-elevated);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 14px;
    transition: all 0.15s;
}

.modal-close:hover {
    background: var(--border);
    color: var(--text);
}

/* Quick mode overrides */
#createTransactionModalContainer[data-mode="quick"] {
    max-width: 1000px;
}

#createTransactionModalContainer[data-mode="quick"] .modal-detailed-only {
    display: none !important;
}

#createTransactionModalContainer[data-mode="quick"] #lineItemsTotal {
    display: none !important;
}

#createTransactionModalContainer[data-mode="quick"] .modal-contact-grid {
    grid-template-columns: 1fr 2fr 2fr !important;
}

/* Direction-based field styling */
#createTransactionModalContainer .form-control,
#createTransactionModalContainer .form-input,
#createTransactionModalContainer .form-textarea,
#createTransactionModalContainer .form-select {
    border: 2px solid rgba(var(--modal-dir-rgb), 0.25);
    transition: border-color 0.2s, box-shadow 0.2s;
}

#createTransactionModalContainer .form-control:focus,
#createTransactionModalContainer .form-input:focus,
#createTransactionModalContainer .form-textarea:focus,
#createTransactionModalContainer .form-select:focus {
    border-color: rgba(var(--modal-dir-rgb), 0.6);
    box-shadow: 0 0 0 3px rgba(var(--modal-dir-rgb), 0.1);
    outline: none;
}

#createTransactionModalContainer .modal-section {
    background: rgba(var(--modal-dir-rgb), 0.03);
    border: 1px solid rgba(var(--modal-dir-rgb), 0.12);
    border-radius: 12px;
}

#createTransactionModalContainer .modal-section-title {
    color: var(--modal-dir-color);
}

#createTransactionModalContainer .receipt-items-header {
    border-bottom-color: rgba(var(--modal-dir-rgb), 0.2);
}

#createTransactionModalContainer #lineItemsTotal {
    border: 2px solid rgba(var(--modal-dir-rgb), 0.3);
    background: rgba(var(--modal-dir-rgb), 0.05);
}

#createTransactionModalContainer #lineItemsTotalAmount {
    color: var(--modal-dir-color);
}

#createTransactionModalContainer .modal-collapsible {
    border: 1px solid rgba(var(--modal-dir-rgb), 0.2);
}

#createTransactionModalContainer .modal-collapsible summary .summary-icon i {
    color: var(--modal-dir-color);
}

#createTransactionModalContainer .btn-primary {
    background: var(--modal-dir-color);
    border-color: var(--modal-dir-color);
}

#createTransactionModalContainer .btn-primary:hover {
    background: rgba(var(--modal-dir-rgb), 0.85);
    box-shadow: 0 4px 12px rgba(var(--modal-dir-rgb), 0.3);
}

#createTransactionModalContainer .add-contact-btn {
    border-color: var(--modal-dir-color);
    color: var(--modal-dir-color);
}

#createTransactionModalContainer .add-contact-btn:hover {
    background: var(--modal-dir-color);
    color: white;
}




.modal-title {
    font-size: 20px;
    font-weight: 900;
    color: var(--text);
    margin: 0;
    letter-spacing: -0.02em;
    white-space: nowrap;
}

.header-info-item i {
    font-size: 12px;
    color: var(--active);
}

.header-info-divider {
    color: var(--border);
}

.register-selector-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
}

.register-selector-icon {
    position: absolute;
    left: 14px;
    font-size: 18px;
    color: var(--active);
    pointer-events: none;
    z-index: 1;
    transition: color 0.3s;
}

.header-info-select {
    border: none;
    background: linear-gradient(135deg, rgba(var(--active-rgb), 0.15), rgba(var(--active-rgb), 0.08));
    font-weight: 800;
    color: var(--active);
    cursor: pointer;
    font-family: inherit;
    font-size: 16px;
    padding: 10px 20px 10px 44px;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(var(--active-rgb), 0.15);
    position: relative;
    min-width: 180px;
}

.header-info-select:hover {
    background: linear-gradient(135deg, rgba(var(--active-rgb), 0.25), rgba(var(--active-rgb), 0.15));
    box-shadow: 0 4px 16px rgba(var(--active-rgb), 0.25);
    transform: translateY(-1px);
}

.header-info-select:focus {
    outline: none;
    box-shadow: 0 0 0 4px rgba(var(--active-rgb), 0.2), 0 4px 16px rgba(var(--active-rgb), 0.3);
    transform: translateY(-1px);
}

.header-info-select option {
    padding: 10px;
    font-size: 16px;
}

.modal-close {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: var(--text-muted);
    font-size: 18px;
}

.modal-close:hover {
    background: rgba(0, 0, 0, 0.1);
    color: var(--text);
}

.modal-body {
    padding: 16px 24px;
}

.expanded-fields {
    display: none;
    margin-top: 12px;
    padding: 16px;
    background: var(--bg);
    border-radius: 12px;
    border: 1px solid var(--border);
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
}

.expanded-fields.show {
    display: block;
    max-height: 500px;
    opacity: 1;
}

.modal-info-bar {
    display: flex;
    gap: 24px;
    padding: 16px 20px;
    background: var(--bg);
    border-radius: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.modal-info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.modal-info-label {
    color: var(--text-muted);
    font-weight: 500;
}

.modal-info-value {
    color: var(--text);
    font-weight: 700;
}

.modal-info-select {
    border: none;
    background: transparent;
    font-weight: 700;
    color: var(--active);
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
}

.modal-info-select:focus {
    outline: 2px solid var(--active);
    outline-offset: 2px;
    border-radius: 4px;
}

@media (max-width: 640px) {
    .modal-container {
        max-height: 95vh;
        border-radius: 16px;
    }
    
    .modal-header {
        padding: 20px 24px;
        border-radius: 16px 16px 0 0;
    }
    
    .modal-title {
        font-size: 20px;
    }
    
    .modal-body {
        padding: 16px;
    }
}

.receipt-modal-layout {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.receipt-modal-grid {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 14px;
}

.receipt-panel {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: box-shadow 0.2s ease;
}

.receipt-panel:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

.receipt-panel-title {
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.receipt-panel-title::before {
    content: '';
    width: 3px;
    height: 12px;
    background: var(--active);
    border-radius: 2px;
}

.receipt-items-header {
    display: grid;
    grid-template-columns: 1fr 150px;
    gap: 12px;
    padding: 0 4px 8px 4px;
    border-bottom: 2px solid var(--border);
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.receipt-items-header div:last-child {
    text-align: right;
}

.receipt-meta-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
}

.receipt-meta-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.receipt-notes .form-textarea {
    min-height: 68px;
    resize: vertical;
}

.receipt-panel .form-group {
    margin-bottom: 10px;
}

.receipt-panel .form-group:last-child {
    margin-bottom: 0;
}

.modal-header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-direction-group {
    display: flex;
    gap: 8px;
}

.modal-direction-group input[type="radio"] {
    display: none;
}

.modal-direction-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.modal-direction-btn:hover {
    border-color: var(--active);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.modal-direction-btn .quick-icon {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.06);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
    flex-shrink: 0;
    font-size: 12px;
}

.modal-direction-btn.in .quick-icon {
    background: #059669;
}

.modal-direction-btn.out .quick-icon {
    background: #6b7280;
}

#modalDirectionIn:checked + .modal-direction-btn.in {
    border-color: #059669;
    background: rgba(5, 150, 105, 0.06);
    color: #059669;
}

#modalDirectionIn:checked + .modal-direction-btn.in i,
#modalDirectionIn:checked + .modal-direction-btn.in span {
    color: white;
}

#modalDirectionOut:checked + .modal-direction-btn.out {
    border-color: #6b7280;
    background: rgba(107, 114, 128, 0.06);
    color: #6b7280;
}

#modalDirectionOut:checked + .modal-direction-btn.out i,
#modalDirectionOut:checked + .modal-direction-btn.out span {
    color: white;
}

.modal-cashbox-select {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 220px;
}

.modal-cashbox-select:hover {
    border-color: var(--active);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.modal-cashbox-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 16px;
    color: white;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(var(--active-rgb), 0.2);
}

.modal-cashbox-select select {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
}

.modal-cashbox-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}

.modal-cashbox-label {
    font-size: 14px;
    font-weight: 800;
    color: var(--text);
    letter-spacing: -0.01em;
}

.modal-cashbox-sublabel {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.modal-cashbox-select i.fa-chevron-down {
    font-size: 11px;
    color: var(--text-muted);
}

.modal-section {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
}

.add-contact-btn {
    width: 100%;
    padding: 10px 16px;
    border: 2px solid var(--active);
    border-radius: 10px;
    background: white;
    color: var(--active);
    font-size: 13px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.add-contact-btn:hover {
    background: var(--active);
    color: white;
    box-shadow: 0 2px 8px rgba(var(--active-rgb), 0.3);
}

.add-contact-btn i {
    font-size: 14px;
}

.modal-cashbox-carousel {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 420px;
    flex-shrink: 0;
}

.cashbox-carousel-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.cashbox-arrow {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 16px;
    transition: all 0.2s;
    flex-shrink: 0;
    opacity: 0.5;
}

.cashbox-arrow:hover {
    color: var(--active);
    opacity: 1;
    transform: scale(1.2);
}

.cashbox-arrow:active {
    transform: scale(0.9);
}

.cashbox-display {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border: 2px solid var(--active);
    border-radius: 10px;
    background: linear-gradient(135deg, rgba(var(--active-rgb), 0.08), rgba(var(--active-rgb), 0.02));
    transition: all 0.3s ease;
    height: 64px;
    min-width: 280px;
    max-width: 380px;
}

.cashbox-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    background: var(--active);
    box-shadow: 0 2px 6px rgba(var(--active-rgb), 0.2);
    flex-shrink: 0;
    transition: all 0.3s;
}

.cashbox-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.modal-direction-primary {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.modal-direction-primary input[type="radio"] {
    display: none;
}

.direction-primary-btn {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid var(--border);
    background: white;
    width: 164px;
    height: 64px;
    color: var(--text-muted);
}

.direction-primary-btn:focus,
.direction-primary-btn:focus-visible {
    outline: none;
    border-color: rgba(var(--dir-rgb), 0.75);
    box-shadow: 0 0 0 4px rgba(var(--dir-rgb), 0.22);
}

.direction-primary-btn .quick-icon {
    width: 34px;
    height: 34px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--dir-color);
    border: 2px solid var(--dir-color);
    background: linear-gradient(135deg, rgba(var(--dir-rgb), 0.16), #ffffff);
    box-shadow: 0 4px 12px rgba(var(--dir-rgb), 0.18);
    flex-shrink: 0;
    font-size: 14px;
    transition: all 0.2s;
}

.direction-primary-btn.in {
    --dir-color: #059669;
    --dir-rgb: 5, 150, 105;
}

.direction-primary-btn.out {
    --dir-color: #6b7280;
    --dir-rgb: 107, 114, 128;
}

.direction-primary-btn .direction-label {
    font-size: 12px;
    font-weight: 900;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-muted);
    line-height: 1;
}

.direction-primary-btn:hover {
    border-color: rgba(var(--dir-rgb), 0.55);
    box-shadow: 0 6px 18px rgba(var(--dir-rgb), 0.14);
    transform: translateY(-1px);
}

#modalDirectionIn:checked + .direction-primary-btn.in,
#modalDirectionOut:checked + .direction-primary-btn.out {
    background: var(--dir-color);
    border-color: var(--dir-color);
    box-shadow: 0 10px 26px rgba(var(--dir-rgb), 0.32);
}

#modalDirectionIn:checked + .direction-primary-btn.in .direction-label,
#modalDirectionOut:checked + .direction-primary-btn.out .direction-label {
    color: #ffffff;
}

#modalDirectionIn:checked + .direction-primary-btn.in .quick-icon,
#modalDirectionOut:checked + .direction-primary-btn.out .quick-icon {
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.28);
    background: rgba(255, 255, 255, 0.14);
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.18);
}


.cashbox-name {
    font-size: 13px;
    font-weight: 800;
    color: var(--text);
    letter-spacing: -0.01em;
}

.cashbox-balance {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
}

.cashbox-position {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    background: var(--surface-elevated);
    padding: 3px 8px;
    border-radius: 5px;
    white-space: nowrap;
}

.modal-date-info {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
    height: 36px;
    padding: 0 12px;
    background: var(--surface-elevated);
    border-radius: 10px;
    border: 1px solid var(--border);
    flex-shrink: 0;
}

.modal-date-info i {
    font-size: 13px;
    opacity: 0.6;
    color: var(--active);
}

.contact-details-toggle summary {
    list-style: none;
}

.contact-details-toggle summary::-webkit-details-marker {
    display: none;
}

.contact-details-toggle[open] summary i.fa-plus-circle::before {
    content: "\f056";
}

.modal-section-title {
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.modal-two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.modal-field-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.modal-collapsible {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    transition: all 0.2s;
}

.modal-collapsible:hover {
    border-color: var(--border);
}

.modal-collapsible[open] {
    border-color: var(--border);
}

.modal-collapsible > summary {
    list-style: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    user-select: none;
}

.modal-collapsible > summary::-webkit-details-marker {
    display: none;
}

.modal-collapsible > summary::after {
    content: '\f078';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    font-size: 11px;
    color: var(--text-muted);
    transition: transform 0.2s;
}

.modal-collapsible[open] > summary::after {
    transform: rotate(180deg);
}

.modal-collapsible > summary .summary-icon {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.modal-collapsible > summary .summary-icon i {
    font-size: 13px;
    color: var(--active);
}

.modal-collapsible[open] > summary {
    margin-bottom: 14px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}

.modal-collapsible-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

@media (max-width: 900px) {
    .modal-two-col {
        grid-template-columns: 1fr;
    }
    .modal-header-controls {
        flex-wrap: wrap;
    }
}

@media (max-width: 900px) {
    .receipt-modal-grid {
        grid-template-columns: 1fr;
    }
    .receipt-meta-split {
        grid-template-columns: 1fr;
    }
}

/* ===== FORM STYLES FOR MODAL ===== */
.form-row {
    display: grid;
    grid-template-columns: 1fr 260px;
    gap: 16px;
    margin-bottom: 12px;
}

.form-group {
    margin-bottom: 12px;
}

.form-row-line-item {
    display: grid;
    grid-template-columns: 1fr 150px;
    gap: 12px;
    margin-bottom: 12px;
}

.form-row-line-item .form-group {
    margin-bottom: 0;
}

.optional-buttons-row {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.optional-buttons-row .add-section-btn {
    flex: 1;
    min-width: 200px;
}

.form-group-flex {
    flex: 1;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
}

.form-label .required {
    color: var(--error);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    background: var(--surface);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.form-hint {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 6px;
}

.input-with-button {
    display: flex;
    gap: 8px;
    align-items: flex-start;
}

.input-with-button .form-input {
    flex: 1;
}

.input-with-prefix {
    position: relative;
    display: flex;
    align-items: center;
}

.input-prefix {
    position: absolute;
    left: 16px;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-muted);
    pointer-events: none;
    z-index: 1;
}

.input-with-prefix .form-input {
    padding-left: 32px;
}

.add-detail-btn {
    width: 40px;
    height: 40px;
    border: 2px solid var(--border);
    background: var(--surface);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: var(--text-muted);
    flex-shrink: 0;
}

.add-detail-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(5, 150, 105, 0.05);
}

.add-detail-btn.active {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(5, 150, 105, 0.1);
}

.remove-item-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-item-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

.add-line-item-btn {
    padding: 9px 14px;
    border: 2px dashed var(--border);
    background: transparent;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    width: 100%;
    font-family: inherit;
}

.add-line-item-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(5, 150, 105, 0.05);
}

.add-line-item-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.add-section-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border: 2px dashed var(--border);
    background: transparent;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    font-family: inherit;
    margin-bottom: 0;
}

.add-section-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(5, 150, 105, 0.05);
}

.add-section-btn.active {
    border-style: solid;
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(5, 150, 105, 0.08);
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    justify-content: flex-end;
}

.btn-blue {
    background: #64748b;
    color: white;
}

.btn-blue:hover {
    background: #475569;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
}

.btn-tertiary {
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
}

.btn-tertiary:hover {
    border-color: var(--text);
    background: var(--bg);
    transform: translateY(-1px);
}

.btn-tertiary i {
    color: #ef4444;
}

.direction-toggle-compact {
    display: flex;
    gap: 8px;
}

.direction-toggle-compact input[type="radio"] {
    display: none;
}

.direction-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.direction-btn-in {
    background: linear-gradient(135deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06));
    color: #059669;
    border-color: rgba(16,185,129,0.15);
}

.direction-btn-in:hover {
    background: linear-gradient(135deg, rgba(16,185,129,0.18), rgba(16,185,129,0.10));
    border-color: rgba(16,185,129,0.25);
}

#modalDirectionIn:checked + .direction-btn-in {
    background: linear-gradient(135deg, #059669, #047857);
    color: white;
    border-color: #047857;
    box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
    font-weight: 700;
}

.direction-btn-out {
    background: linear-gradient(135deg, rgba(107,114,128,0.12), rgba(107,114,128,0.06));
    color: #6b7280;
    border-color: rgba(107,114,128, 0.15);
}

.direction-btn-out:hover {
    background: linear-gradient(135deg, rgba(107,114,128, 0.18), rgba(107,114,128, 0.10));
    border-color: rgba(107,114,128, 0.25);
}

#modalDirectionOut:checked + .direction-btn-out {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
    border-color: #4b5563;
    box-shadow: 0 0 0 3px rgba(107,114,128, 0.2);
    font-weight: 700;
}

@media (max-width: 640px) {
    .direction-toggle {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .line-item {
        grid-template-columns: 1fr;
    }
    
    .line-item-amount {
        width: 100%;
    }
}

.line-items-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 12px;
}

.line-item {
    display: grid;
    grid-template-columns: 1fr 200px 40px;
    gap: 10px;
    align-items: center;
}

.line-item-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
    background: var(--surface);
}

.line-item-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
}

.line-item-amount {
    text-align: right;
}

.autocomplete-wrapper {
    position: relative;
    flex: 1;
}

.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface);
    border: 2px solid var(--primary);
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 280px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.autocomplete-dropdown.show {
    display: block;
}

.autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid var(--border);
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover {
    background: var(--bg);
}

.autocomplete-item.active {
    background: rgba(var(--active-rgb), 0.1);
}

.autocomplete-item-name {
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
}

.autocomplete-item-details {
    font-size: 13px;
    color: var(--text-muted);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.autocomplete-item-detail {
    display: flex;
    align-items: center;
    gap: 4px;
}

.autocomplete-item-detail i {
    font-size: 11px;
}

.autocomplete-add-new {
    padding: 12px 16px;
    cursor: pointer;
    background: linear-gradient(135deg, rgba(var(--active-rgb), 0.08), rgba(var(--active-rgb), 0.04));
    color: var(--primary);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
    border-top: 2px solid var(--border);
    transition: all 0.2s;
}

.autocomplete-add-new:hover {
    background: linear-gradient(135deg, rgba(var(--active-rgb), 0.15), rgba(var(--active-rgb), 0.08));
}

.autocomplete-add-new i {
    font-size: 14px;
}

.autocomplete-empty {
    padding: 20px 16px;
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
}

    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" /></head>
<body>
<nav class="site-nav">
  <div class="nav-container">
            <a href="dashboard.html" class="logo">
                <svg width="36" height="36" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#nav-logo-gradient)"/>
                    <path d="M32 4 L38 10 L32 10 Z" fill="#000000" opacity="0.25"/>
                    <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
                    <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                    <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
                    <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                    <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
                    <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="nav-logo-gradient" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#059669"/>
                            <stop offset="100%" stop-color="#10b981"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span>SpendNote</span>
            </a>
            <ul class="nav-links">
                <li><a href="dashboard.html" class="nav-cash-item active">Dashboard</a></li>
                <li><a href="spendnote-cash-box-list.html" class="nav-cash-item" id="navCashBoxes">Cash Boxes</a></li>
                <li><a href="spendnote-transaction-history.html" class="nav-cash-item" id="navTransactions">Transactions</a></li>
                <li><a href="spendnote-contact-list.html">Contacts</a></li>
                <li><button class="nav-new-transaction-btn" id="addTransactionBtn"><i class="fas fa-plus"></i> New Transaction</button></li>
                <li class="user-avatar-wrapper" id="userAvatarBtn">
                    <div class="user-avatar">
                        <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="User">
                    </div>
                    <span class="user-name"></span>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-menu">
                            <a href="spendnote-user-settings.html" class="user-dropdown-item">
                                <i class="fas fa-cog"></i>
                                Settings
                            </a>
                            <div class="user-dropdown-divider"></div>
                            <a href="index.html" class="user-dropdown-item">
                                <i class="fas fa-sign-out-alt"></i>
                                Log out
                            </a>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

<div class="app-container">
    <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title-group">
                    <h1>Dashboard</h1>
                    <p class="page-subtitle">Your financial overview and quick access to Cash Boxes</p>
                </div>
            </div>

            <!-- Cash Boxes Carousel -->
            <div class="registers-carousel-section">
                <div class="carousel-nav">
                    <button class="carousel-arrow swiper-button-prev-custom" aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-arrow swiper-button-next-custom" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="swiper registers-swiper">
                    <div class="swiper-wrapper">
                        <!-- Cash boxes will be loaded dynamically from Supabase -->
                        <!-- Add Cash Box Card -->
                        <div class="swiper-slide">
                            <div class="add-cash-box-card" onclick="handleAddCashBoxDashboard()" data-plan="pro" data-box-count="5" role="button" tabindex="0">
                                <!-- Invisible spacer to match register-card height -->
                                <div style="height: 11px; visibility: hidden;"></div>
                                <div class="add-cash-box-icon">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div class="add-cash-box-title">Add Cash Box</div>
                                <div class="add-cash-box-subtitle">Keep your cash organized</div>
                                <!-- Conditional upgrade message - only shown when limit reached -->
                                <div class="add-cash-box-upgrade" data-upgrade-text="standard">Upgrade to Standard for more Cash Boxes</div>
                                <div class="add-cash-box-upgrade" data-upgrade-text="pro">Upgrade to Pro for unlimited Cash Boxes</div>
                                <!-- Invisible spacer to match register-card height -->
                                <div style="height: 23px; visibility: hidden;"></div>
                            </div>
                        </div>
                    </div>
                    <!-- End of swiper-wrapper -->
                    
                    <!-- Pagination -->
                    <div class="swiper-pagination"></div>
                </div>
                <!-- End of registers-swiper -->

            <!-- Tip: invite your team (compact) - Moved below Cash Boxes -->
            <div class="invite-banner-compact" id="inviteBanner">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> Invite your team  they can add receipts from their phones.</span>
                <button class="invite-btn-compact" type="button">Invite</button>
                <button class="dismiss-btn-compact" type="button" onclick="document.getElementById('inviteBanner').style.display='none'" title="Dismiss"></button>
            </div>

            <div class="transactions-card">
                <div class="transactions-header" id="transactionsHeader" style="--cashbox-rgb: 5, 150, 105;">
                    <div class="header-top">
                        <h2 class="transactions-title">Latest Transactions</h2>
                        <a href="spendnote-transaction-history.html" class="view-all-btn">
                            <span>View All</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <div class="table-wrapper" id="tableWrapper">
                    <div class="table-grid table-header" id="transactionTableHeader" style="--cashbox-rgb: 5, 150, 105;">
                        <div>Type</div>
                        <div>Date & Time</div>
                        <div>Cash Box</div>
                        <div>Contact</div>
                        <div>Description</div>
                        <div>Amount</div>
                        <div>Created by</div>
                        <div>Action</div>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <!-- CREATE TRANSACTION MODAL v20260128a - cashbox right + icon fix -->
    <div class="modal-overlay" id="createTransactionModal" aria-hidden="true">
        <div class="modal-container" id="createTransactionModalContainer" data-direction="in" data-mode="quick" role="dialog" aria-modal="true" aria-label="Create transaction" tabindex="-1">
            <div class="modal-header">
                <div class="modal-header-left">
                    <!-- Direction buttons -->
                    <div class="modal-direction-primary">
                        <input type="radio" name="modalDirection" id="modalDirectionIn" value="in" checked>
                        <label for="modalDirectionIn" class="direction-primary-btn in" tabindex="0">
                            <span class="quick-icon"><i class="fas fa-arrow-down"></i></span>
                            <span>IN</span>
                        </label>
                        <input type="radio" name="modalDirection" id="modalDirectionOut" value="out">
                        <label for="modalDirectionOut" class="direction-primary-btn out" tabindex="0">
                            <span class="quick-icon"><i class="fas fa-arrow-up"></i></span>
                            <span>OUT</span>
                        </label>
                    </div>
                </div>

                <div class="modal-header-right">
                    <!-- Cashbox selector -->
                    <div class="cashbox-display" id="modalCashboxDisplay">
                        <div class="cashbox-icon" id="modalCashboxIcon"></div>
                        <div class="cashbox-info">
                            <div class="cashbox-name" id="modalCashboxName">Loading...</div>
                            <div class="cashbox-balance" id="modalCashboxBalance"></div>
                        </div>
                        <div class="cashbox-arrows">
                            <button type="button" class="cashbox-arrow" id="modalCashboxPrev" title="Previous">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button type="button" class="cashbox-arrow" id="modalCashboxNext" title="Next">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <input type="hidden" id="modalCashBoxId" value="">
                    </div>

                    <!-- Watermark placeholder for spacing -->
                    <div class="modal-watermark" aria-hidden="true"></div>

                    <button class="modal-close" id="closeModalBtn" type="button" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="padding: 16px 24px;">
                <form id="modalTransactionForm" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Contact Section -->
                    <div class="modal-section" style="padding: 16px;">
                        <!-- Mode toggle + Date row -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div class="modal-mode-toggle" id="modalModeToggle">
                                <input type="radio" name="modalMode" id="modalModeQuick" value="quick" checked>
                                <label for="modalModeQuick">Quick</label>
                                <input type="radio" name="modalMode" id="modalModeDetailed" value="detailed">
                                <label for="modalModeDetailed">Detailed</label>
                            </div>
                            <div class="form-group" style="margin: 0; width: 140px;">
                                <input type="text" id="modalDateField" class="form-control" readonly style="background: rgba(255,255,255,0.7); cursor: default; color: var(--text-muted); text-align: center; font-size: 12px;">
                            </div>
                        </div>
                        
                        <!-- Name + Address row -->
                        <div class="modal-contact-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="modalContactName">Name <span class="required">*</span></label>
                                <input 
                                    type="text" 
                                    id="modalContactName" 
                                    class="form-control" 
                                    placeholder="Contact name"
                                    autocomplete="off"
                                >
                                <div id="ContactAutocomplete" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label for="modalContactAddress">Address <span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">(optional)</span></label>
                                <input 
                                    type="text" 
                                    id="modalContactAddress" 
                                    class="form-control" 
                                    placeholder="Street, City, State"
                                >
                            </div>
                            <div class="form-group modal-detailed-only">
                                <label for="modalContactCompanyId">Other ID / Company ID</label>
                                <input 
                                    type="text" 
                                    id="modalContactCompanyId" 
                                    class="form-control" 
                                    placeholder="Company ID"
                                >
                            </div>
                        </div>
                        
                        <!-- Additional Contact Details (Collapsible) -->
                        <details class="contact-details-toggle modal-detailed-only" id="modalContactDetails" style="margin-top: 12px;">
                            <summary style="cursor: pointer; font-size: 11px; font-weight: 700; color: var(--text); user-select: none;">
                                <i class="fas fa-plus-circle" style="margin-right: 6px; color: var(--active);"></i>
                                Phone/Email & Save to Contacts
                            </summary>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px;">
                                <div class="form-group">
                                    <label for="modalContactPhone">Phone</label>
                                    <input 
                                        type="tel" 
                                        id="modalContactPhone" 
                                        class="form-control" 
                                        placeholder="+1 (555) 123-4567"
                                    >
                                </div>
                                <div class="form-group">
                                    <label for="modalContactEmail">Email</label>
                                    <input 
                                        type="email" 
                                        id="modalContactEmail" 
                                        class="form-control" 
                                        placeholder="email@example.com"
                                    >
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <button type="button" id="modalAddContactBtn" class="add-contact-btn" style="width: 100%;">
                                        <i class="fas fa-user-plus"></i>
                                        Save to Contacts
                                    </button>
                                </div>
                            </div>
                        </details>
                        <input type="hidden" id="modalContactId">
                    </div>

                    <!-- Items Section -->
                    <div class="modal-section" style="padding: 12px;">
                        <div class="modal-section-title">Items</div>
                        
                        <!-- First Item (always visible) -->
                        <div class="receipt-items-header" style="border-bottom: 1px solid var(--border); padding-bottom: 6px; margin-bottom: 8px;">
                            <div>Description <span class="required">*</span></div>
                            <div>Amount <span class="required">*</span></div>
                        </div>
                        
                        <div class="form-row-line-item" style="margin-bottom: 10px;">
                            <div class="form-group">
                                <div class="autocomplete-wrapper">
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        id="modalDescription"
                                        placeholder="Item description"
                                        autocomplete="off"
                                        required
                                    >
                                    <div class="autocomplete-dropdown" id="descriptionAutocomplete"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="input-with-prefix">
                                    <span class="input-prefix">$</span>
                                    <input 
                                        type="number" 
                                        class="form-input" 
                                        id="modalAmount"
                                        placeholder="0.00"
                                        step="0.01"
                                        min="0"
                                        required
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Total (always visible) -->
                        <div id="lineItemsTotal" style="display: flex; padding: 12px 16px; background: white; border: 2px solid var(--border); border-radius: 10px; font-weight: 800; font-size: 15px; justify-content: space-between; align-items:center; margin-bottom: 10px;">
                            <span style="color: var(--text);">Total</span>
                            <span id="lineItemsTotalAmount" style="color: var(--text); font-size: 18px; letter-spacing: -0.02em;">$0.00</span>
                        </div>

                        <!-- Additional Items (collapsible) -->
                        <details class="modal-collapsible modal-detailed-only" id="modalExtraItemsDetails" style="padding: 10px 12px;">
                            <summary>
                                <span class="summary-icon">
                                    <i class="fas fa-plus-circle"></i>
                                    Add more items
                                </span>
                            </summary>
                            <div class="modal-collapsible-content">
                                <div class="line-items-container" id="modalLineItemsContainer"></div>
                                <button type="button" class="add-line-item-btn" id="modalAddLineItemBtn">
                                    <i class="fas fa-plus"></i>
                                    Add line item (max 4)
                                </button>
                            </div>
                        </details>
                    </div>

                    <!-- Note Section (collapsible) -->
                    <details class="modal-collapsible modal-detailed-only" id="modalNoteSection" style="padding: 10px 12px;">
                        <summary>
                            <span class="summary-icon">
                                <i class="fas fa-sticky-note"></i>
                                Add note
                            </span>
                        </summary>
                        <div class="modal-collapsible-content">
                            <textarea 
                                class="form-textarea" 
                                id="modalNote"
                                placeholder="Add any additional notes or comments"
                                rows="2"
                            ></textarea>
                        </div>
                    </details>

                    <!-- ACTIONS -->
                    <div class="form-actions">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); font-weight: 600; cursor: pointer; user-select: none; margin-right: auto;">
                            <input type="checkbox" id="modalAddAnother" style="width: 16px; height: 16px;">
                            <span>Add another after saving</span>
                        </label>
                        <button type="submit" class="btn btn-blue" name="action" value="done">
                            <i class="fas fa-check"></i>
                            Done
                        </button>
                        <button type="submit" class="btn btn-primary" name="action" value="done-receipt">
                            <i class="fas fa-file-pdf"></i>
                            Done & Receipt
                        </button>
                        <button type="button" class="btn btn-tertiary" id="modalCancelBtn">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                    
                    <!-- Receipt Note -->
                    <div class="modal-detailed-only" style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-muted); font-style: italic;">
                        You can print a receipt now, or later from the transaction list.
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modern 2-Row Footer -->
<footer class="app-footer">
    <div class="app-footer-container">
        <!-- Top Row -->
        <div class="app-footer-top">
            <!-- Brand Section with Disclaimer -->
            <div class="app-footer-brand">
                <a href="dashboard.html" class="app-footer-brand-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Main body with subtle gray pattern -->
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="white"/>
                        <!-- Folded corner - darker gray -->
                        <path d="M32 4 L38 10 L32 10 Z" fill="rgba(0,0,0,0.15)"/>
                        <!-- Folded corner outline -->
                        <path d="M32 4 L32 10 L38 10" stroke="rgba(0,0,0,0.2)" stroke-width="1.5" stroke-linejoin="round"/>
                        <!-- Receipt lines - light gray -->
                        <line x1="14" y1="14" x2="30" y2="14" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="rgba(0,0,0,0.12)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="rgba(0,0,0,0.1)" stroke-width="2.5" stroke-linecap="round"/>
                        <!-- Bottom zigzag - gray -->
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="rgba(0,0,0,0.2)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>SpendNote</span>
                </a>
                <p class="app-footer-brand-desc">
                    Cash receipt management for modern teams. Simple, secure, transparent.
                </p>
            </div>
            
            <!-- Right: Links + Disclaimer -->
            <div class="app-footer-right">
                <div class="app-footer-links-simple">
                    <a href="index.html#features">Features</a>
                    <a href="spendnote-pricing.html">Pricing</a>
                    <a href="spendnote-faq.html">FAQ</a>
                    <a href="spendnote-terms.html">Legal</a>
                </div>
                
                <!-- Disclaimer on right side -->
                <div class="app-footer-brand-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <span>Cash handoff documentation only. Not a tax or accounting tool.</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row -->
        <div class="app-footer-bottom">
            <div class="app-footer-copyright">
                2026 SpendNote. All rights reserved.
            </div>
        </div>
    </div>
</footer>







    <script>
        // ========================================
        // CASH BOX KEBAB MENUS
        // ========================================
        function closeAllRegisterMenus() {
            document.querySelectorAll('.register-menu.open').forEach(m => m.classList.remove('open'));
        }

        document.querySelectorAll('.register-kebab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const card = btn.closest('.register-card');
                const menu = card ? card.querySelector('.register-menu') : null;
                if (!menu) return;
                const isOpen = menu.classList.contains('open');
                closeAllRegisterMenus();
                if (!isOpen) menu.classList.add('open');
            });

            btn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    btn.click();
                }
            });
        });

        document.querySelectorAll('.register-menu').forEach(menu => {
            menu.addEventListener('click', (e) => e.stopPropagation());
        });

        document.querySelectorAll('.menu-settings').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const card = btn.closest('.register-card');
                const name = card?.dataset?.name || 'this Cash Box';
                alert(`Open settings for ${name} (demo).`);
                closeAllRegisterMenus();
            });
        });

        document.querySelectorAll('.menu-delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const card = btn.closest('.register-card');
                const name = card?.dataset?.name || 'this Cash Box';
                alert(`Delete ${name} (demo).`);
                closeAllRegisterMenus();
            });
        });

        document.addEventListener('click', closeAllRegisterMenus);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAllRegisterMenus();
        });


        // Filter toggle
        const filterToggle = document.getElementById('filterToggle');
        const filterPanel = document.getElementById('filterPanel');

        if (filterToggle) {
            filterToggle.addEventListener('click', () => {
                filterPanel.classList.toggle('expanded');
                filterToggle.classList.toggle('active');
            });
        }

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        // Nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // Bulk selection
        const selectAllCheckbox = document.getElementById('selectAll');
        const txCheckboxes = document.querySelectorAll('.tx-checkbox');
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        
        // v24: toggle selected row styling
        function syncRowSelection() {
            txCheckboxes.forEach(cb => {
                const row = cb.closest('.table-grid');
                if (row) row.classList.toggle('is-selected', cb.checked);
            });
        }

        function updateBulkActions() {
            const checkedCount = document.querySelectorAll('.tx-checkbox:checked').length;
            if (selectedCount) selectedCount.textContent = checkedCount;
            if (bulkActions) bulkActions.classList.toggle('active', checkedCount > 0);
            if (selectAllCheckbox) selectAllCheckbox.checked = checkedCount === txCheckboxes.length;
            syncRowSelection();
        }

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', () => {
                txCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                updateBulkActions();
            });
        }
        
        txCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                updateBulkActions();
                syncRowSelection();
            });
        });
        
        syncRowSelection();

        // Export button
        const exportBtn = document.querySelector('.export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                alert('Exporting transactions to CSV...');
            });
        }

        // Clear filters
        const clearFiltersBtn = document.getElementById('clearFilters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                const filterName = document.getElementById('filterName');
                const filterDesc = document.getElementById('filterDesc');
                const filterDateFrom = document.getElementById('filterDateFrom');
                const filterDateTo = document.getElementById('filterDateTo');
                const filterAmountMin = document.getElementById('filterAmountMin');
                const filterAmountMax = document.getElementById('filterAmountMax');
                if (filterName) filterName.value = '';
                if (filterDesc) filterDesc.value = '';
                if (filterDateFrom) filterDateFrom.value = '';
                if (filterDateTo) filterDateTo.value = '';
                if (filterAmountMin) filterAmountMin.value = '';
                if (filterAmountMax) filterAmountMax.value = '';
            });
        }

        // Apply filters
        const applyFiltersBtn = document.getElementById('applyFilters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                alert('Filters applied! (Demo mode)');
            });
        }

        // ========================================
        // MODAL - Simple and Clean
        // ========================================
        const modal = document.getElementById('createTransactionModal');
        const openModalBtn = document.getElementById('addTransactionBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('modalCancelBtn');

        const modalContainerEl = document.getElementById('createTransactionModalContainer');
        const modeQuickEl = document.getElementById('modalModeQuick');
        const modeDetailedEl = document.getElementById('modalModeDetailed');
        const contactDetailsEl = document.getElementById('modalContactDetails');
        const extraItemsDetailsEl = document.getElementById('modalExtraItemsDetails');
        const noteDetailsEl = document.getElementById('modalNoteSection');

        let lastModalFocusEl = null;
        let isModalSubmitting = false;

        let modalLineItemCount = 0;
        const maxModalLineItems = 4;
        const modalLineItemsContainer = document.getElementById('modalLineItemsContainer');
        const modalAddLineItemBtn = document.getElementById('modalAddLineItemBtn');

        function setModalSubmittingState(isSubmitting) {
            isModalSubmitting = Boolean(isSubmitting);

            if (closeModalBtn) closeModalBtn.disabled = isModalSubmitting;
            if (cancelModalBtn) cancelModalBtn.disabled = isModalSubmitting;
        }

        function getModalFocusableEls() {
            if (!modalContainerEl) return [];
            return Array.from(
                modalContainerEl.querySelectorAll(
                    'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                )
            ).filter((el) => {
                if (!el) return false;
                if (el.getAttribute('aria-hidden') === 'true') return false;
                return el.offsetParent !== null;
            });
        }

        function handleModalKeydown(e) {
            if (!modal || !modal.classList.contains('active')) return;

            if (e.key === 'Escape') {
                if (isModalSubmitting) {
                    e.preventDefault();
                    return;
                }
                e.preventDefault();
                closeModal();
                return;
            }

            if (e.key === 'Tab') {
                const focusables = getModalFocusableEls();
                if (focusables.length === 0) {
                    e.preventDefault();
                    modalContainerEl?.focus();
                    return;
                }

                const first = focusables[0];
                const last = focusables[focusables.length - 1];
                const active = document.activeElement;

                if (e.shiftKey) {
                    if (active === first || !modalContainerEl.contains(active)) {
                        e.preventDefault();
                        last.focus();
                    }
                    return;
                }

                if (!modalContainerEl.contains(active)) {
                    e.preventDefault();
                    first.focus();
                    return;
                }

                if (active === last) {
                    e.preventDefault();
                    first.focus();
                }
            }
        }

        function handleModalFocusIn(e) {
            if (!modal || !modal.classList.contains('active')) return;
            if (!modalContainerEl) return;

            const target = e.target;
            if (target && modalContainerEl.contains(target)) return;

            const focusables = getModalFocusableEls();
            const first = focusables[0];
            if (first && typeof first.focus === 'function') {
                first.focus();
                return;
            }

            modalContainerEl.focus();
        }

        function setModalBackgroundInert(isInert) {
            const bodyChildren = Array.from(document.body.children || []);
            bodyChildren.forEach((el) => {
                if (!el || el.id === 'createTransactionModal') return;
                if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE') return;

                if (isInert) {
                    el.setAttribute('inert', '');
                } else {
                    el.removeAttribute('inert');
                }
            });
        }

        function updateModalDirectionUI(direction) {
            if (!modalContainerEl) return;
            const dir = direction === 'out' ? 'out' : 'in';
            modalContainerEl.dataset.direction = dir;
        }

        function getStoredModalMode() {
            try {
                const v = localStorage.getItem('spendnote.modalMode');
                return v === 'detailed' ? 'detailed' : 'quick';
            } catch {
                return 'quick';
            }
        }

        function storeModalMode(mode) {
            try {
                localStorage.setItem('spendnote.modalMode', mode);
            } catch {
                // ignore
            }
        }

        function ensureExtraLineItems(targetCount) {
            const btn = document.getElementById('modalAddLineItemBtn');
            if (!btn) return;
            if (typeof modalLineItemCount !== 'number') return;
            while (!btn.disabled && modalLineItemCount < targetCount) {
                btn.click();
            }
        }

        function updateModalModeUI(mode, { persist = true } = {}) {
            if (!modalContainerEl) return;
            const m = mode === 'detailed' ? 'detailed' : 'quick';
            modalContainerEl.dataset.mode = m;

            if (modeQuickEl && modeDetailedEl) {
                modeQuickEl.checked = m === 'quick';
                modeDetailedEl.checked = m === 'detailed';
            }

            if (m === 'detailed') {
                if (contactDetailsEl) contactDetailsEl.open = true;
                if (extraItemsDetailsEl) extraItemsDetailsEl.open = true;
                if (noteDetailsEl) noteDetailsEl.open = true;
                // 5 item rows total = main row + 4 extras
                ensureExtraLineItems(4);
            }

            if (persist) storeModalMode(m);
            if (typeof updateLineItemsTotal === 'function') updateLineItemsTotal();
        }

        function openModal(preset) {
            const isEventLike = preset && typeof preset === 'object' && 'preventDefault' in preset && 'target' in preset;
            const options = isEventLike ? {} : (preset || {});

            lastModalFocusEl = document.activeElement;

            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            setModalBackgroundInert(true);
            document.addEventListener('keydown', handleModalKeydown, true);
            document.addEventListener('focusin', handleModalFocusIn, true);
            console.log('Modal should be visible now');

            const dateFieldEl = document.getElementById('modalDateField');
            if (dateFieldEl) {
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                dateFieldEl.value = `${yyyy}-${mm}-${dd} ${hh}:${min}`;
                dateFieldEl.dataset.fullDate = now.toISOString();
            }
            
            // Initialize cash box carousel from real Supabase data
            initModalCashboxCarousel();

            if (options.cashBoxId) {
                // Find the cash box index by ID and set it
                const idx = modalCashBoxes.findIndex(cb => cb.id === options.cashBoxId);
                if (idx >= 0) {
                    modalCashBoxIndex = idx;
                    updateModalCashboxDisplay();
                }
            }

            if (options.direction === 'in' || options.direction === 'out') {
                const inEl = document.getElementById('modalDirectionIn');
                const outEl = document.getElementById('modalDirectionOut');
                if (inEl && outEl) {
                    inEl.checked = options.direction === 'in';
                    outEl.checked = options.direction === 'out';
                }
            }

            const checkedDirEl = document.querySelector('input[name="modalDirection"]:checked');
            updateModalDirectionUI(checkedDirEl ? checkedDirEl.value : 'in');

            const initialMode = (options.mode === 'detailed' || options.mode === 'quick')
                ? options.mode
                : getStoredModalMode();
            updateModalModeUI(initialMode, { persist: false });

            if (initialMode !== 'detailed') {
                const extraItemsDetails = document.getElementById('modalExtraItemsDetails');
                if (extraItemsDetails) extraItemsDetails.open = false;
                const noteSection = document.getElementById('modalNoteSection');
                if (noteSection) noteSection.open = false;
            }

            const focusPrimary = () => {
                const checkedDirElForFocus = document.querySelector('input[name="modalDirection"]:checked');
                const focusId = checkedDirElForFocus ? checkedDirElForFocus.id : 'modalDirectionIn';
                const focusLabelEl = modalContainerEl?.querySelector(`label[for="${focusId}"]`);
                if (focusLabelEl && typeof focusLabelEl.focus === 'function') {
                    focusLabelEl.focus();
                    return;
                }
                if (checkedDirElForFocus && typeof checkedDirElForFocus.focus === 'function') {
                    checkedDirElForFocus.focus();
                    return;
                }
                modalContainerEl?.focus();
            };

            requestAnimationFrame(() => requestAnimationFrame(focusPrimary));
        }

        // Make openModal available globally for testing
        window.openModal = openModal;

        if (openModalBtn) {
            openModalBtn.addEventListener('click', openModal);
            console.log('Modal button listener attached');
        } else {
            console.warn('Modal button not found');
        }

        // Open modal if hash is #new-transaction
        (function() {
            if (window.location.hash !== '#new-transaction') return;
            const getPresetFromUrl = () => {
                const params = new URLSearchParams(window.location.search);
                const cashBoxId = params.get('cashbox');
                const direction = params.get('direction');
                const preset = {};
                if (cashBoxId) preset.cashBoxId = cashBoxId;
                if (direction === 'in' || direction === 'out') preset.direction = direction;
                return preset;
            };
            const openFromHash = () => {
                const preset = getPresetFromUrl();
                setTimeout(() => openModal(preset), 0);
                history.replaceState(null, null, 'dashboard.html');
            };
            if (window.__spendnoteDashboardDataLoaded) {
                openFromHash();
                return;
            }
            window.addEventListener('SpendNoteDashboardDataLoaded', openFromHash, { once: true });
        })();

        // Close modal
        function closeModal() {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            setModalBackgroundInert(false);
            document.removeEventListener('keydown', handleModalKeydown, true);
            document.removeEventListener('focusin', handleModalFocusIn, true);
            // Reset form
            document.getElementById('modalTransactionForm').reset();
            updateModalDirectionUI('in');
            updateModalModeUI(getStoredModalMode(), { persist: false });
            const lineItemsContainer = document.getElementById('modalLineItemsContainer');
            if (lineItemsContainer) {
                lineItemsContainer.innerHTML = '';
            }
            if (contactDetailsEl) contactDetailsEl.open = false;
            const extraItemsDetails = document.getElementById('modalExtraItemsDetails');
            if (extraItemsDetails) extraItemsDetails.open = false;
            const noteSection = document.getElementById('modalNoteSection');
            if (noteSection) noteSection.open = false;
            modalLineItemCount = 0;
            updateModalLineItemsButton();
            if (typeof updateLineItemsTotal === 'function') {
                updateLineItemsTotal();
            }

            if (lastModalFocusEl && typeof lastModalFocusEl.focus === 'function') {
                try {
                    lastModalFocusEl.focus();
                } catch {
                    // ignore
                }
            }
            lastModalFocusEl = null;
        }

        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);

        const dirInRadio = document.getElementById('modalDirectionIn');
        const dirOutRadio = document.getElementById('modalDirectionOut');
        if (dirInRadio) dirInRadio.addEventListener('change', () => updateModalDirectionUI('in'));
        if (dirOutRadio) dirOutRadio.addEventListener('change', () => updateModalDirectionUI('out'));

        const dirInLabel = document.querySelector('label[for="modalDirectionIn"]');
        const dirOutLabel = document.querySelector('label[for="modalDirectionOut"]');
        if (dirInLabel) {
            dirInLabel.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    dirInLabel.click();
                }
            });
        }
        if (dirOutLabel) {
            dirOutLabel.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    dirOutLabel.click();
                }
            });
        }

        if (modeQuickEl) modeQuickEl.addEventListener('change', () => updateModalModeUI('quick'));
        if (modeDetailedEl) modeDetailedEl.addEventListener('change', () => updateModalModeUI('detailed'));

        // Close on overlay click
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (isModalSubmitting) return;
                if (e.target === modal) closeModal();
            });
        }

        // Modal Cash Box Carousel - uses real Supabase cash boxes
        let modalCashBoxes = [];
        let modalCashBoxIndex = 0;
        
        function initModalCashboxCarousel() {
            // Get cash boxes from the dashboard cards (already loaded from Supabase)
            const dashboardCards = document.querySelectorAll('.register-card');
            modalCashBoxes = [];
            
            dashboardCards.forEach(card => {
                if (card.dataset.id) {
                    const renderedIconEl = card.querySelector('.register-icon i');
                    const renderedIconClass = renderedIconEl
                        ? Array.from(renderedIconEl.classList).find((cls) => cls.startsWith('fa-') && cls !== 'fa-fw')
                        : null;

                    modalCashBoxes.push({
                        id: card.dataset.id,
                        name: card.querySelector('.register-name')?.textContent || 'Cash Box',
                        color: card.dataset.color || '#059669',
                        rgb: card.dataset.rgb || '5, 150, 105',
                        icon: renderedIconClass || card.dataset.icon || 'fa-cash-register'
                    });
                }
            });
            
            if (modalCashBoxes.length === 0) {
                // Fallback if no cash boxes loaded yet
                modalCashBoxes = [{ id: 'default', name: 'Default Cash Box', color: '#059669', rgb: '5, 150, 105', icon: 'fa-cash-register' }];
            }
            
            modalCashBoxIndex = 0;
            updateModalCashboxDisplay();
        }
        
        function updateModalCashboxDisplay() {
            const cashbox = modalCashBoxes[modalCashBoxIndex];
            if (!cashbox) return;
            
            const iconEl = document.getElementById('modalCashboxIcon');
            const nameEl = document.getElementById('modalCashboxName');
            const balanceEl = document.getElementById('modalCashboxBalance');
            const idInput = document.getElementById('modalCashBoxId');
            
            if (iconEl) {
                iconEl.innerHTML = `<i class="fas ${cashbox.icon}"></i>`;
                iconEl.style.background = cashbox.color;
            }
            if (nameEl) {
                nameEl.textContent = cashbox.name;
            }
            if (balanceEl) {
                // Get balance from dashboard card if available
                const dashboardCard = document.querySelector(`.register-card[data-id="${cashbox.id}"]`);
                const balanceText = dashboardCard?.querySelector('.register-balance')?.textContent || '';
                balanceEl.textContent = balanceText ? `Balance: ${balanceText}` : '';
            }
            if (idInput) {
                idInput.value = cashbox.id;
            }
            
            // Update active color
            if (cashbox.color && cashbox.rgb) {
                document.documentElement.style.setProperty('--active', cashbox.color);
                document.documentElement.style.setProperty('--active-rgb', cashbox.rgb);
                localStorage.setItem('activeCashBoxColor', cashbox.color);
                localStorage.setItem('activeCashBoxRgb', cashbox.rgb);
                updateMenuColors(cashbox.color);
            }
        }
        
        // Cash box carousel navigation (tiny up/down arrows)
        const cashboxPrevBtn = document.getElementById('modalCashboxPrev');
        const cashboxNextBtn = document.getElementById('modalCashboxNext');
        
        if (cashboxPrevBtn) {
            cashboxPrevBtn.addEventListener('click', () => {
                if (modalCashBoxes.length > 1) {
                    modalCashBoxIndex = (modalCashBoxIndex - 1 + modalCashBoxes.length) % modalCashBoxes.length;
                    updateModalCashboxDisplay();
                }
            });
        }
        
        if (cashboxNextBtn) {
            cashboxNextBtn.addEventListener('click', () => {
                if (modalCashBoxes.length > 1) {
                    modalCashBoxIndex = (modalCashBoxIndex + 1) % modalCashBoxes.length;
                    updateModalCashboxDisplay();
                }
            });
        }
        
        // Add to Contacts button
        const addContactBtn = document.getElementById('modalAddContactBtn');
        if (addContactBtn) {
            addContactBtn.addEventListener('click', () => {
                const name = document.getElementById('modalContactName').value;
                const phone = document.getElementById('modalContactPhone').value;
                const email = document.getElementById('modalContactEmail').value;
                const address = document.getElementById('modalContactAddress').value;
                
                if (!name.trim()) {
                    alert('Please enter a contact name first.');
                    return;
                }
                
                // TODO: Add to contacts database
                alert(`Contact "${name}" will be added to your contacts list.\n\nPhone: ${phone || 'N/A'}\nEmail: ${email || 'N/A'}\nAddress: ${address || 'N/A'}`);
            });
        }

        // Contact Autocomplete
        const ContactInput = document.getElementById('modalContactName');
        const ContactDropdown = document.getElementById('ContactAutocomplete');
        const ContactAddressInput = document.getElementById('modalContactAddress');
        const ContactIdInput = document.getElementById('modalContactId');
        
        // Contact database (in production, this would come from API)
        const Contacts = [
            { name: 'ABC Supplies', address: '123 Main St, New York, NY 10001', id: 'SUPP-001', contact: 'contact@abcsupplies.com' },
            { name: 'John Smith', address: '456 Oak Ave, Los Angeles, CA 90001', id: '', contact: 'john.smith@email.com' },
            { name: 'Mary Johnson', address: '789 Pine Rd, Chicago, IL 60601', id: 'CLI-MJ-2025', contact: 'mary.j@company.com' },
            { name: 'AdCorp Media', address: '321 Market St, San Francisco, CA 94102', id: 'VEND-AC-789', contact: 'billing@adcorpmedia.com' },
            { name: 'Sarah Williams', address: '555 Elm St, Boston, MA 02101', id: '', contact: 'sarah.w@email.com' },
            { name: 'David Chen', address: '777 Maple Dr, Seattle, WA 98101', id: 'EMP-DC-456', contact: 'david.chen@company.com' }
        ];
        
        let selectedContactIndex = -1;
        
        function filterContacts(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return Contacts.filter(p => 
                p.name.toLowerCase().includes(lowerQuery) ||
                (p.id && p.id.toLowerCase().includes(lowerQuery)) ||
                (p.address && p.address.toLowerCase().includes(lowerQuery))
            );
        }
        
        function showAutocomplete(results) {
            if (results.length === 0 && ContactInput.value.length > 0) {
                ContactDropdown.innerHTML = `
                    <div class="autocomplete-add-new" data-action="add-new">
                        <i class="fas fa-plus"></i>
                        Add "${ContactInput.value}" as new Contact
                    </div>
                `;
                ContactDropdown.classList.add('show');
                return;
            }
            
            if (results.length === 0) {
                ContactDropdown.classList.remove('show');
                return;
            }
            
            let html = results.map((Contact, index) => `
                <div class="autocomplete-item ${index === selectedContactIndex ? 'active' : ''}" data-index="${index}">
                    <div class="autocomplete-item-name">${Contact.name}</div>
                    <div class="autocomplete-item-details">
                        ${Contact.id ? `<div class="autocomplete-item-detail"><i class="fas fa-tag"></i>${Contact.id}</div>` : ''}
                        ${Contact.address ? `<div class="autocomplete-item-detail"><i class="fas fa-map-marker-alt"></i>${Contact.address.split(',')[0]}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            html += `
                <div class="autocomplete-add-new" data-action="add-new">
                    <i class="fas fa-plus"></i>
                    Add new Contact
                </div>
            `;
            
            ContactDropdown.innerHTML = html;
            ContactDropdown.classList.add('show');
            
            // Add click handlers
            ContactDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectContact(Contacts.filter(p => 
                        p.name.toLowerCase().includes(ContactInput.value.toLowerCase()) ||
                        (p.id && p.id.toLowerCase().includes(ContactInput.value.toLowerCase())) ||
                        (p.address && p.address.toLowerCase().includes(ContactInput.value.toLowerCase()))
                    )[index]);
                });
            });
            
            ContactDropdown.querySelector('.autocomplete-add-new').addEventListener('click', () => {
                ContactDropdown.classList.remove('show');
                ContactInput.focus();
            });
        }
        
        function selectContact(Contact) {
            ContactInput.value = Contact.name;
            document.getElementById('modalContactAddress').value = Contact.address;
            document.getElementById('modalContactId').value = Contact.id;
            ContactDropdown.classList.remove('show');
            selectedContactIndex = -1;
        }
        
        // Input event
        ContactInput.addEventListener('input', (e) => {
            const results = filterContacts(e.target.value);
            showAutocomplete(results);
            selectedContactIndex = -1;
        });
        
        // Focus event
        ContactInput.addEventListener('focus', (e) => {
            if (e.target.value) {
                const results = filterContacts(e.target.value);
                showAutocomplete(results);
            }
        });
        
        // Keyboard navigation
        ContactInput.addEventListener('keydown', (e) => {
            const items = ContactDropdown.querySelectorAll('.autocomplete-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedContactIndex = Math.min(selectedContactIndex + 1, items.length - 1);
                updateActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedContactIndex = Math.max(selectedContactIndex - 1, -1);
                updateActiveItem();
            } else if (e.key === 'Enter' && selectedContactIndex >= 0) {
                e.preventDefault();
                const results = filterContacts(ContactInput.value);
                if (results[selectedContactIndex]) {
                    selectContact(results[selectedContactIndex]);
                }
            } else if (e.key === 'Escape') {
                ContactDropdown.classList.remove('show');
                selectedContactIndex = -1;
            }
        });
        
        function updateActiveItem() {
            const items = ContactDropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === selectedContactIndex);
            });
            
            // Scroll into view
            if (selectedContactIndex >= 0 && items[selectedContactIndex]) {
                items[selectedContactIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!ContactInput.contains(e.target) && !ContactDropdown.contains(e.target)) {
                ContactDropdown.classList.remove('show');
                selectedContactIndex = -1;
            }
        });

        // Description Autocomplete
        const descriptionInput = document.getElementById('modalDescription');
        const descriptionDropdown = document.getElementById('descriptionAutocomplete');
        
        const recentDescriptions = [
            'Office supplies',
            'Retail cash deposit',
            'Customer payment',
            'Marketing campaign',
            'Product sales',
            'Employee salary',
            'Rent payment',
            'Utility bills',
            'Equipment purchase',
            'Consulting services'
        ];
        
        function setupSimpleAutocomplete(input, dropdown, dataArray) {
            if (!input || !dropdown || !Array.isArray(dataArray)) return;
            let selectedIndex = -1;
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (!query) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const results = dataArray.filter(item => item.toLowerCase().includes(query));
                
                if (results.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const html = results.map((item, index) => `
                    <div class="autocomplete-item ${index === selectedIndex ? 'active' : ''}" data-value="${item}">
                        <div class="autocomplete-item-name">${item}</div>
                    </div>
                `).join('');
                
                dropdown.innerHTML = html;
                dropdown.classList.add('show');
                
                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        input.value = item.dataset.value;
                        dropdown.classList.remove('show');
                        selectedIndex = -1;
                    });
                });
            });
            
            input.addEventListener('focus', (e) => {
                if (e.target.value) {
                    const event = new Event('input', { bubbles: true });
                    e.target.dispatchEvent(event);
                }
            });
            
            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateItems();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateItems();
                } else if (e.key === 'Enter' && selectedIndex >= 0 && items[selectedIndex]) {
                    e.preventDefault();
                    input.value = items[selectedIndex].dataset.value;
                    dropdown.classList.remove('show');
                    selectedIndex = -1;
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    selectedIndex = -1;
                }
            });
            
            function updateItems() {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === selectedIndex);
                });
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].scrollIntoView({ block: 'nearest' });
                }
            }
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    selectedIndex = -1;
                }
            });
        }
        
        if (descriptionInput && descriptionDropdown) {
            setupSimpleAutocomplete(descriptionInput, descriptionDropdown, recentDescriptions);
        }
        
        // Transaction ID Autocomplete
        const transactionIdInput = document.getElementById('modalTransactionId');
        const transactionIdDropdown = document.getElementById('transactionIdAutocomplete');
        
        const recentTransactionIds = [
            'PO-2026-001',
            'INV-2026-045',
            'ORD-2025-789',
            'REF-2026-012',
            'PO-2025-998',
            'INV-2025-999'
        ];
        
        if (transactionIdInput && transactionIdDropdown) {
            setupSimpleAutocomplete(transactionIdInput, transactionIdDropdown, recentTransactionIds);
        }

        // Receipt-style modal: fields are always visible (no toggle sections)

        // Line items management
        if (modalAddLineItemBtn && modalLineItemsContainer) modalAddLineItemBtn.addEventListener('click', () => {
            if (modalLineItemCount >= maxModalLineItems) return;
            
            modalLineItemCount++;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'line-item';
            itemDiv.innerHTML = `
                <input 
                    type="text" 
                    class="line-item-input" 
                    placeholder="Item description"
                    data-item-index="${modalLineItemCount}"
                >
                <input 
                    type="number" 
                    class="line-item-input line-item-amount" 
                    placeholder="$0.00"
                    step="0.01"
                    min="0"
                    data-amount-index="${modalLineItemCount}"
                >
                <button type="button" class="remove-item-btn" data-remove-index="${modalLineItemCount}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            modalLineItemsContainer.appendChild(itemDiv);
            
            // Remove button
            itemDiv.querySelector('.remove-item-btn').addEventListener('click', function() {
                itemDiv.remove();
                modalLineItemCount--;
                updateModalLineItemsButton();
                updateLineItemsTotal();
            });
            
            // Add input listeners for live total calculation
            itemDiv.querySelectorAll('.line-item-amount').forEach(input => {
                input.addEventListener('input', updateLineItemsTotal);
            });
            
            updateModalLineItemsButton();
            updateLineItemsTotal();
        });

        function updateModalLineItemsButton() {
            if (!modalAddLineItemBtn) return;
            modalAddLineItemBtn.disabled = modalLineItemCount >= maxModalLineItems;
            modalAddLineItemBtn.innerHTML = `
                <i class="fas fa-plus"></i>
                Add line item (${modalLineItemCount}/${maxModalLineItems})
            `;
        }

        function parseModalAmount(value) {
            const normalized = String(value || '')
                .replace(/\s+/g, '')
                .replace(/,/g, '.');
            const num = parseFloat(normalized);
            return Number.isFinite(num) ? num : 0;
        }

        function updateLineItemsTotal() {
            const lineItemsTotal = document.getElementById('lineItemsTotal');
            const lineItemsTotalAmount = document.getElementById('lineItemsTotalAmount');
            const mainAmountField = document.getElementById('modalAmount');
            if (!lineItemsTotal || !lineItemsTotalAmount) return;

            const isDetailed = document.getElementById('createTransactionModalContainer')?.dataset?.mode === 'detailed';
            
            const baseAmount = parseModalAmount(mainAmountField?.value);
            let extrasTotal = 0;

            if (isDetailed) {
                document.querySelectorAll('#modalLineItemsContainer .line-item-amount').forEach(input => {
                    const value = parseModalAmount(input.value);
                    if (value > 0) {
                        extrasTotal += value;
                    }
                });
            }

            const total = baseAmount + extrasTotal;

            lineItemsTotal.style.display = 'block';
            lineItemsTotalAmount.textContent = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(total);
        }

        const modalAmountInputForTotal = document.getElementById('modalAmount');
        if (modalAmountInputForTotal) {
            modalAmountInputForTotal.addEventListener('input', updateLineItemsTotal);
        }

        // Form submission
        document.getElementById('modalTransactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isModalSubmitting) return;
            
            const actionBtn = e.submitter;
            const action = actionBtn ? actionBtn.value : 'done';

            const mode = document.getElementById('createTransactionModalContainer')?.dataset?.mode === 'detailed' ? 'detailed' : 'quick';

            const modalDateEl = document.getElementById('modalDate');
            
            const cashBoxEl = document.getElementById('modalCashBoxId');
            const contactNameEl = document.getElementById('modalContactName');
            const amountEl = document.getElementById('modalAmount');
            const directionEl = document.querySelector('input[name="modalDirection"]:checked');

            const formData = {
                cashBox: cashBoxEl ? cashBoxEl.value : '',
                loggedBy: document.querySelector('.user-name')?.textContent || 'John',
                ContactName: contactNameEl ? contactNameEl.value : '',
                ContactAddress: mode === 'detailed' ? (document.getElementById('modalContactAddress')?.value || '') : '',
                ContactId: document.getElementById('modalContactId')?.value || '',
                direction: directionEl ? directionEl.value : 'in',
                amount: amountEl ? amountEl.value : '',
                date: modalDateEl ? modalDateEl.value : new Date().toISOString().slice(0, 10),
                transactionId: document.getElementById('modalTransactionId')?.value || '',
                note: mode === 'detailed' ? (document.getElementById('modalNote')?.value || '') : '',
                lineItems: []
            };

            // Collect line items
            if (mode === 'detailed') {
                document.querySelectorAll('#modalLineItemsContainer .line-item').forEach(item => {
                    const desc = item.querySelector('[data-item-index]').value;
                    const amt = item.querySelector('[data-amount-index]').value;
                    const parsedAmt = parseModalAmount(amt);
                    if (desc || parsedAmt > 0) {
                        formData.lineItems.push({
                            description: String(desc || '').trim(),
                            amount: parsedAmt
                        });
                    }
                });
            }

            console.log('Transaction data:', formData);
            console.log('Action:', action);

            const submitButtons = Array.from(e.currentTarget.querySelectorAll('button[type="submit"]'));
            submitButtons.forEach((btn) => {
                if (!btn.dataset.originalHtml) {
                    btn.dataset.originalHtml = btn.innerHTML;
                }
                btn.disabled = true;
            });

            if (actionBtn) {
                if (!actionBtn.dataset.originalHtml) {
                    actionBtn.dataset.originalHtml = actionBtn.innerHTML;
                }
                actionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            }

            setModalSubmittingState(true);

            try {
                if (!window.auth || !window.db || !window.supabaseClient) {
                    window.location.href = '/spendnote-login.html';
                    return;
                }

                const user = await window.auth.getCurrentUser();
                if (!user) {
                    window.location.href = '/spendnote-login.html';
                    return;
                }

                const isUuid = (value) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(value || ''));
                if (!isUuid(formData.cashBox)) {
                    alert('Please create and select a Cash Box first.');
                    return;
                }

                const amountValue = parseModalAmount(formData.amount);
                if (!Number.isFinite(amountValue) || amountValue <= 0) {
                    alert('Please enter a valid amount.');
                    return;
                }

                const description = (document.getElementById('modalDescription')?.value || '').trim();
                if (!description) {
                    alert('Description is required.');
                    return;
                }

                const contactName = String(formData.ContactName || '').trim();
                if (!contactName) {
                    alert('Contact Name is required.');
                    return;
                }

                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const transactionDate = `${yyyy}-${mm}-${dd}`;

                let profile = null;
                try {
                    profile = await window.db.profiles.getCurrent();
                } catch (err) {
                    profile = null;
                }

                if (!profile) {
                    const fallbackName = user.user_metadata?.full_name || user.email || 'User';
                    const { data: createdProfile, error: profileError } = await window.supabaseClient
                        .from('profiles')
                        .insert([{ id: user.id, email: user.email, full_name: fallbackName }])
                        .select()
                        .single();
                    if (!profileError) {
                        profile = createdProfile;
                    }
                }

                // Final amount shown on dashboard = main amount + extra line items
                const extrasTotal = (formData.lineItems || []).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                const finalAmount = amountValue + extrasTotal;

                const persistedLineItems = [
                    { description: description, amount: amountValue },
                    ...(formData.lineItems || [])
                ];

                const payload = {
                    user_id: user.id,
                    cash_box_id: document.getElementById('modalCashBoxId')?.value || modalCashBoxes[modalCashBoxIndex]?.id || null,
                    type: formData.direction === 'out' ? 'expense' : 'income',
                    amount: finalAmount,
                    description: description || null,
                    notes: String(formData.note || '').trim() || null,
                    transaction_date: transactionDate,
                    receipt_number: String(formData.transactionId || '').trim() || null,
                    line_items: persistedLineItems,
                    contact_id: null,
                    contact_name: contactName,
                    contact_email: null,
                    contact_phone: null,
                    contact_address: String(formData.ContactAddress || '').trim() || null,
                    created_by_user_id: user.id,
                    created_by_user_name: profile?.full_name || user.user_metadata?.full_name || user.email || null
                };

                let ensuredContact = null;
                if (window.db?.contacts?.getOrCreate && typeof window.db.contacts.getOrCreate === 'function') {
                    ensuredContact = await window.db.contacts.getOrCreate({
                        name: contactName,
                        address: payload.contact_address
                    });
                } else if (window.db?.contacts?.create && typeof window.db.contacts.create === 'function') {
                    ensuredContact = await window.db.contacts.create({
                        user_id: user.id,
                        name: contactName,
                        email: null,
                        phone: null,
                        address: payload.contact_address,
                        notes: null
                    });
                }

                if (ensuredContact && ensuredContact.success && ensuredContact.data && ensuredContact.data.id) {
                    payload.contact_id = ensuredContact.data.id;
                }

                const result = await window.db.transactions.create(payload);
                if (!result || !result.success) {
                    alert(result?.error || 'Failed to create transaction.');
                    return;
                }

                const addAnother = Boolean(document.getElementById('modalAddAnother')?.checked);

                if (typeof loadDashboardData === 'function') {
                    await loadDashboardData();
                }

                if (action === 'done-receipt') {
                    closeModal();
                    alert('Transaction saved. Receipt generation is not implemented yet.');
                    return;
                }

                if (addAnother) {
                    const amountInput = document.getElementById('modalAmount');
                    const descInput = document.getElementById('modalDescription');
                    const txIdInput = document.getElementById('modalTransactionId');
                    const noteInput = document.getElementById('modalNote');
                    const lineItemsContainer = document.getElementById('modalLineItemsContainer');

                    if (amountInput) amountInput.value = '';
                    if (descInput) descInput.value = '';
                    if (txIdInput) txIdInput.value = '';
                    if (noteInput) noteInput.value = '';

                    const extraItemsDetails = document.getElementById('modalExtraItemsDetails');
                    if (extraItemsDetails) extraItemsDetails.open = false;
                    const noteSection = document.getElementById('modalNoteSection');
                    if (noteSection) noteSection.open = false;

                    const txIdGroup = document.getElementById('modalTransactionIdGroup');
                    const noteGroup = document.getElementById('modalNoteGroup');
                    if (txIdGroup) txIdGroup.style.display = 'none';
                    if (noteGroup) noteGroup.style.display = 'none';

                    if (lineItemsContainer) {
                        lineItemsContainer.innerHTML = '';
                        modalLineItemCount = 0;
                        updateModalLineItemsButton();
                        updateLineItemsTotal();
                    }

                    const checkedDirElForFocus = document.querySelector('input[name="modalDirection"]:checked');
                    const focusId = checkedDirElForFocus ? checkedDirElForFocus.id : 'modalDirectionIn';
                    const focusLabelEl = modalContainerEl?.querySelector(`label[for="${focusId}"]`);
                    if (focusLabelEl && typeof focusLabelEl.focus === 'function') {
                        focusLabelEl.focus();
                    } else if (checkedDirElForFocus && typeof checkedDirElForFocus.focus === 'function') {
                        checkedDirElForFocus.focus();
                    }
                    return;
                }

                closeModal();
            } finally {
                submitButtons.forEach((btn) => {
                    btn.disabled = false;
                    if (btn.dataset.originalHtml) {
                        btn.innerHTML = btn.dataset.originalHtml;
                    }
                });

                setModalSubmittingState(false);
            }
        });

    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=15"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/main.js?v=17"></script>
    <script src="assets/js/dashboard-data.js?v=49&t=202601260002"></script>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // ========================================
        // CASH BOX CARDS INITIALIZATION
        // ========================================
        function initCashBoxCards() {
            const cards = document.querySelectorAll('.register-card');
            const addCashBoxCard = document.querySelector('.add-cash-box-card');

            const activateCard = (card) => {
                if (!card) return;
                const color = card.dataset.color;
                const rgb = card.dataset.rgb;

                cards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');

                document.documentElement.style.setProperty('--active', color);
                document.documentElement.style.setProperty('--active-rgb', rgb);

                localStorage.setItem('activeCashBoxColor', color);
                localStorage.setItem('activeCashBoxRgb', rgb);
                localStorage.setItem('activeCashBoxId', card.dataset.id);

                updateMenuColors(color);
                updateTableHeaderColor(rgb);
            };
            
            cards.forEach(card => {
                // Set card color CSS variables
                const color = card.dataset.color;
                const rgb = card.dataset.rgb;
                card.style.setProperty('--card-color', color);
                card.style.setProperty('--card-rgb', rgb);

                const quickButtons = Array.from(card.querySelectorAll('.register-quick-btn'));
                quickButtons.forEach((btn) => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const direction = btn.getAttribute('data-quick');
                        activateCard(card);
                        if (typeof window.openModal === 'function') {
                            window.openModal({ cashBoxId: card.dataset.id, direction });
                        }
                    });
                });

                // Click to activate
                card.addEventListener('click', (e) => {
                    // Don't activate if clicking menu button
                    if (e.target.closest('.register-kebab') || e.target.closest('.register-menu') || e.target.closest('.register-quick-actions') || e.target.closest('.register-icon-link')) {
                        return;
                    }

                    activateCard(card);
                });
                
                // Double-click to navigate to Cash Box Detail
                card.addEventListener('dblclick', (e) => {
                    if (e.target.closest('.register-kebab') || e.target.closest('.register-menu') || e.target.closest('.register-quick-actions') || e.target.closest('.register-icon-link')) {
                        return;
                    }
                    const cashboxId = card.dataset.id;
                    window.location.href = `spendnote-cash-box-detail.html?id=${cashboxId}`;
                });
            });
            
            // Load saved active cash box from localStorage
            const savedId = localStorage.getItem('activeCashBoxId');
            const savedCard = savedId ? Array.from(cards).find(card => card.dataset.id === savedId) : null;
            if (savedCard) {
                activateCard(savedCard);
            }

            if (addCashBoxCard) {
                requestAnimationFrame(() => {
                    const heights = Array.from(document.querySelectorAll('.register-card'))
                        .map((el) => el.getBoundingClientRect().height)
                        .filter((h) => Number.isFinite(h) && h > 0);
                    const maxHeight = heights.length ? Math.max(...heights) : 0;
                    if (maxHeight) {
                        addCashBoxCard.style.minHeight = `${Math.ceil(maxHeight)}px`;
                    }
                });
            }
        }

        // Update menu item colors based on active cash box
        function updateMenuColors(color) {
            // Update all nav-cash-item links (Dashboard, Cash Boxes, Transactions)
            const navCashItems = document.querySelectorAll('.nav-cash-item');
            navCashItems.forEach(item => {
                item.style.color = color;
            });
            
            // Update other menu items (Contacts, Settings) - not Log out button
            const otherNavItems = document.querySelectorAll('.nav-links a:not(.nav-cash-item):not(.btn)');
            otherNavItems.forEach(item => {
                item.style.color = color;
            });
            
            // Update New Transaction button background color (keep text white)
            const newTransactionBtn = document.querySelector('.nav-new-transaction-btn');
            if (newTransactionBtn) {
                newTransactionBtn.style.background = `linear-gradient(135deg, ${color}, ${color})`;
                newTransactionBtn.style.color = 'white';
            }
        }

        // Update table header color dynamically
        function updateTableHeaderColor(rgb) {
            const tableHeader = document.getElementById('transactionTableHeader');
            if (tableHeader) {
                tableHeader.style.setProperty('--cashbox-rgb', rgb);
            }
            const transactionsHeader = document.getElementById('transactionsHeader');
            if (transactionsHeader) {
                transactionsHeader.style.setProperty('--cashbox-rgb', rgb);
            }
        }

        // ========================================
        // SWIPER INITIALIZATION
        // ========================================
        window.registersSwiper = new Swiper('.registers-swiper', {
            slidesPerView: 1,
            spaceBetween: 20,
            loop: false,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next-custom',
                prevEl: '.swiper-button-prev-custom',
            },
            breakpoints: {
                640: {
                    slidesPerView: 2,
                    spaceBetween: 20,
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 24,
                },
            },
        });

        // Note: we intentionally do NOT update the selected cash box on slide change.
        // Selection should follow click, while Swiper navigation only changes what is visible.

        // ========================================
        // INITIALIZE EVERYTHING AFTER SWIPER
        // ========================================
        initCashBoxCards();
        
        // Navigate to the correct slide based on URL parameter (cashbox ID)
        const urlParams = new URLSearchParams(window.location.search);
        const returnFromCashBoxId = urlParams.get('cashbox');
        if (returnFromCashBoxId) {
            // Find the slide index for the cashbox ID
            const allSlides = document.querySelectorAll('.swiper-slide');
            let targetIndex = -1;
            allSlides.forEach((slide, index) => {
                const card = slide.querySelector('.register-card');
                if (card) {
                    const cashBoxId = card.dataset.id;
                    if (cashBoxId && cashBoxId === returnFromCashBoxId) {
                        targetIndex = index;
                    }
                }
            });
            // Navigate to the slide (including index 0)
            if (targetIndex >= 0) {
                registersSwiper.slideTo(targetIndex, 0); // 0 = instant, no animation
            }
        }
        
        // Set initial active card color
        const activeCard = document.querySelector('.register-card.active');
        if (activeCard) {
            document.documentElement.style.setProperty('--active', activeCard.dataset.color);
            document.documentElement.style.setProperty('--active-rgb', activeCard.dataset.rgb);
            // Set initial menu colors
            updateMenuColors(activeCard.dataset.color);
            // Update table header color
            updateTableHeaderColor(activeCard.dataset.rgb);
        }

        // ========================================
        // LOAD REAL DATA FROM SUPABASE
        // ========================================
        // Load dashboard data after Swiper is initialized
        if (typeof loadDashboardData === 'function') {
            loadDashboardData();
        }

        // ========================================
        // TRANSACTIONS MENU - ADD CASHBOX FILTER
        // ========================================
        const transactionsLink = document.getElementById('navTransactions');
        if (transactionsLink) {
            transactionsLink.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Get active cash box
                const activeCashBox = document.querySelector('.register-card.active');
                if (activeCashBox) {
                    const cashBoxName = activeCashBox.dataset.name;
                    const cashBoxColor = activeCashBox.dataset.color;
                    
                    // Navigate with URL parameters
                    window.location.href = `spendnote-transaction-history.html?cashbox=${encodeURIComponent(cashBoxName)}&color=${encodeURIComponent(cashBoxColor)}`;
                } else {
                    // No active cash box, navigate without filter
                    window.location.href = 'spendnote-transaction-history.html';
                }
            });
        }

        // ========================================
        // ADD CASH BOX CARD - CONDITIONAL LOGIC
        // ========================================
        function handleAddCashBoxDashboard() {
            const card = document.querySelector('.add-cash-box-card');
            const plan = card.getAttribute('data-plan'); // 'free', 'standard', 'pro'
            const boxCount = parseInt(card.getAttribute('data-box-count'));
            
            // Plan limits: Free = 1, Standard = 2, Pro = unlimited
            const planLimits = {
                'free': 1,
                'standard': 2,
                'pro': Infinity
            };
            
            const limit = planLimits[plan] || 1;
            
            if (boxCount >= limit) {
                // User reached limit - show upgrade message
                if (plan === 'free') {
                    alert('You have reached the Free plan limit (1 Cash Box).\n\nUpgrade to Standard to create up to 2 Cash Boxes.');
                } else if (plan === 'standard') {
                    alert('You have reached the Standard plan limit (2 Cash Boxes).\n\nUpgrade to Pro for unlimited Cash Boxes.');
                }
            } else {
                // User can still add more - open create flow
                window.location.href = 'spendnote-cash-box-settings.html';
            }
        }

        // Initialize Add Cash Box card state on page load
        (function initAddCashBoxCard() {
            const card = document.querySelector('.add-cash-box-card');
            if (!card) return;
            
            const plan = card.getAttribute('data-plan');
            const boxCount = parseInt(card.getAttribute('data-box-count'));
            
            const planLimits = {
                'free': 1,
                'standard': 2,
                'pro': Infinity
            };
            
            const limit = planLimits[plan] || 1;
            const upgradeMessages = card.querySelectorAll('.add-cash-box-upgrade');
            
            if (boxCount >= limit) {
                // Disable card and show appropriate upgrade message
                card.classList.add('disabled');
                
                upgradeMessages.forEach(msg => {
                    const upgradeType = msg.getAttribute('data-upgrade-text');
                    if ((plan === 'free' && upgradeType === 'standard') ||
                        (plan === 'standard' && upgradeType === 'pro')) {
                        msg.style.display = 'block';
                    } else {
                        msg.style.display = 'none';
                    }
                });
            } else {
                // Card is clickable, hide all upgrade messages
                card.classList.remove('disabled');
                upgradeMessages.forEach(msg => msg.style.display = 'none');
            }
        })();

    </script>
</body>
</html>
