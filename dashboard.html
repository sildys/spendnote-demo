<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SpendNote Dashboard - Manage your cash receipts, transactions, and Cash Boxes in one place.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Dashboard - SpendNote</title>
    <script>
        (function() {
            try {
                window.__spendnoteDashboardHtmlBuild = '20260129-1353';
                document.documentElement.classList.add('dashboard-loading');
                var c = localStorage.getItem('activeCashBoxColor');
                var r = localStorage.getItem('activeCashBoxRgb');
                if (c && r) {
                    document.documentElement.style.setProperty('--active', c);
                    document.documentElement.style.setProperty('--active-rgb', r);
                }
            } catch (e) {}
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css?v=12">
    <link rel="stylesheet" href="assets/css/app-layout.css?v=14">
    <link rel="stylesheet" href="assets/css/dashboard.css?v=20260208-1925">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" /></head>
<body>
<!-- Navigation loaded dynamically by nav-loader.js -->
<div id="nav-container"></div>

<div class="app-container">
    <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title-group">
                    <h1>Dashboard</h1>
                    <p class="page-subtitle">Your financial overview and quick access to Cash Boxes</p>
                </div>
            </div>

            <!-- Cash Boxes Carousel -->
            <div class="registers-carousel-section">
                <div class="carousel-nav">
                    <button class="carousel-arrow swiper-button-prev-custom" aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-arrow swiper-button-next-custom" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="swiper registers-swiper">
                    <div class="swiper-wrapper">
                        <!-- Cash boxes will be loaded dynamically from Supabase -->
                        <!-- Add Cash Box Card -->
                        <div class="swiper-slide">
                            <div class="add-cash-box-card" onclick="handleAddCashBoxDashboard()" data-plan="pro" data-box-count="5" role="button" tabindex="0">
                                <!-- Invisible spacer to match register-card height -->
                                <div style="height: 11px; visibility: hidden;"></div>
                                <div class="add-cash-box-icon">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div class="add-cash-box-title">Add Cash Box</div>
                                <div class="add-cash-box-subtitle">Keep your cash organized</div>
                                <!-- Conditional upgrade message - only shown when limit reached -->
                                <div class="add-cash-box-upgrade" data-upgrade-text="standard">Upgrade to Standard for more Cash Boxes</div>
                                <div class="add-cash-box-upgrade" data-upgrade-text="pro">Upgrade to Pro for unlimited Cash Boxes</div>
                                <!-- Invisible spacer to match register-card height -->
                                <div style="height: 23px; visibility: hidden;"></div>
                            </div>
                        </div>
                    </div>
                    <!-- End of swiper-wrapper -->
                    
                    <!-- Pagination -->
                    <div class="swiper-pagination"></div>
                </div>
                <!-- End of registers-swiper -->

            <!-- Tip: invite your team (compact) - Moved below Cash Boxes -->
            <div class="invite-banner-compact" id="inviteBanner">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> Invite your team – they can add receipts from their phones.</span>
                <button class="invite-btn-compact" type="button">Invite</button>
                <button class="dismiss-btn-compact" type="button" onclick="document.getElementById('inviteBanner').style.display='none'" title="Dismiss">×</button>
            </div>

            <div class="transactions-card">
                <div class="transactions-header" id="transactionsHeader" style="--cashbox-rgb: 5, 150, 105;">
                    <div class="header-top">
                        <h2 class="transactions-title">Latest Transactions</h2>
                        <a href="spendnote-transaction-history.html" class="view-all-btn">
                            <span>View All</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-wrapper">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Cash Box</th>
                                    <th>Contact</th>
                                    <th>Description</th>
                                    <th class="col-amount">Amount</th>
                                    <th>Created by</th>
                                    <th class="col-action">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <!-- CREATE TRANSACTION MODAL v20260128a - cashbox right + icon fix -->
    <div class="modal-overlay" id="createTransactionModal" aria-hidden="true">
        <div class="modal-container" id="createTransactionModalContainer" data-direction="in" data-mode="quick" role="dialog" aria-modal="true" aria-label="Create transaction" tabindex="-1">
            <div class="modal-header">
                <div class="modal-header-left">
                    <!-- Direction buttons -->
                    <div class="modal-direction-primary">
                        <input type="radio" name="modalDirection" id="modalDirectionIn" value="in" checked>
                        <label for="modalDirectionIn" class="direction-primary-btn in" tabindex="0">
                            <span class="quick-icon"><i class="fas fa-arrow-down"></i></span>
                            <span>IN</span>
                        </label>
                        <input type="radio" name="modalDirection" id="modalDirectionOut" value="out">
                        <label for="modalDirectionOut" class="direction-primary-btn out" tabindex="0">
                            <span class="quick-icon"><i class="fas fa-arrow-up"></i></span>
                            <span>OUT</span>
                        </label>
                    </div>
                </div>

                <div class="modal-header-right">
                    <!-- Cashbox selector -->
                    <div class="cashbox-display" id="modalCashboxDisplay">
                        <div class="cashbox-icon" id="modalCashboxIcon"></div>
                        <div class="cashbox-info">
                            <div class="cashbox-name"><span class="cashbox-id" id="modalCashboxIdDisplay"></span> <span id="modalCashboxName">Loading...</span></div>
                            <div class="cashbox-balance" id="modalCashboxBalance"></div>
                        </div>
                        <div class="cashbox-arrows">
                            <button type="button" class="cashbox-arrow" id="modalCashboxPrev" title="Previous">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button type="button" class="cashbox-arrow" id="modalCashboxNext" title="Next">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <input type="hidden" id="modalCashBoxId" value="">
                    </div>

                    <!-- Watermark placeholder for spacing -->
                    <div class="modal-watermark" aria-hidden="true"></div>

                    <button class="modal-close" id="closeModalBtn" type="button" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="padding: 16px 24px;">
                <form id="modalTransactionForm" autocomplete="off" style="display: flex; flex-direction: column; gap: 12px;">
                    <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;">
                    <input type="password" name="password" autocomplete="new-password" tabindex="-1" aria-hidden="true" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;">
                    <!-- Contact Section -->
                    <div class="modal-section" style="padding: 16px;">
                        <!-- Mode toggle + Date row -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div class="modal-mode-toggle" id="modalModeToggle">
                                <input type="radio" name="modalMode" id="modalModeQuick" value="quick" checked>
                                <label for="modalModeQuick">Quick</label>
                                <input type="radio" name="modalMode" id="modalModeDetailed" value="detailed">
                                <label for="modalModeDetailed">Detailed</label>
                            </div>
                            <div class="form-group" style="margin: 0; width: 140px;">
                                <input type="text" id="modalDateField" class="form-control" readonly style="background: rgba(255,255,255,0.7); cursor: default; color: var(--text-muted); text-align: center; font-size: 12px;">
                            </div>
                        </div>

                        <input type="hidden" id="modalDate">
                        
                        <div class="modal-contact-grid">
                            <div class="form-group modal-contact-name">
                                <label for="modalContactName">Name <span class="required">*</span></label>
                                <input 
                                    type="text" 
                                    id="modalContactName" 
                                    name="modalContactName"
                                    class="form-control" 
                                    placeholder="Contact name"
                                    autocomplete="new-password"
                                    spellcheck="false"
                                    autocapitalize="off"
                                    autocorrect="off"
                                >
                                <div id="ContactAutocomplete" class="autocomplete-dropdown"></div>
                                <label for="modalSaveContact" style="display: inline-flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 12px; font-weight: 600; color: var(--text-muted);">
                                    <input type="checkbox" id="modalSaveContact" style="width: 14px; height: 14px; accent-color: var(--active);" />
                                    Save to Contacts
                                </label>
                            </div>
                            <div class="form-group modal-contact-address">
                                <label for="modalContactAddress">Address <span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">(optional)</span></label>
                                <textarea 
                                    id="modalContactAddress" 
                                    name="modalContactAddress"
                                    autocomplete="off"
                                    spellcheck="false"
                                    autocapitalize="off"
                                    autocorrect="off"
                                    class="form-control modal-address-textarea" 
                                    placeholder="Street (press Enter for line 2)"
                                    rows="1"
                                ></textarea>
                            </div>
                            <div class="form-group modal-detailed-only modal-contact-company" id="modalContactDetails">
                                <label for="modalContactCompanyId">Other ID</label>
                                <input 
                                    type="text" 
                                    id="modalContactCompanyId" 
                                    class="form-control" 
                                    placeholder="Other ID"
                                >
                            </div>
                        </div>
                        <input type="hidden" id="modalContactId">
                    </div>

                    <!-- Items Section -->
                    <div class="modal-section" style="padding: 12px;">
                        <div class="modal-section-title" id="modalItemsSectionTitle">Items</div>
                        
                        <!-- First Item (always visible) -->
                        <div class="receipt-items-header" style="border-bottom: 1px solid var(--border); padding-bottom: 6px; margin-bottom: 8px;">
                            <div id="modalItemsDescriptionHeader">Description <span class="required">*</span></div>
                            <div>Amount <span class="required">*</span></div>
                        </div>
                        
                        <div class="form-row-line-item" style="margin-bottom: 10px;">
                            <div class="form-group">
                                <div class="autocomplete-wrapper">
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        id="modalDescription"
                                        placeholder="Item description"
                                        autocomplete="off"
                                        required
                                    >
                                    <div class="autocomplete-dropdown" id="descriptionAutocomplete"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="input-with-prefix">
                                    <span class="input-prefix">$</span>
                                    <input 
                                        type="number" 
                                        class="form-input" 
                                        id="modalAmount"
                                        placeholder="0.00"
                                        step="0.01"
                                        min="0"
                                        required
                                    >
                                </div>
                            </div>
                        </div>

                        <button type="button" class="add-line-item-btn modal-detailed-only" id="modalExpandItemsBtn" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-plus-circle"></i>
                            Add more items
                        </button>

                        <div class="line-items-container modal-detailed-only" id="modalLineItemsContainer" style="display: none;"></div>

                        <!-- Total (always visible) -->
                        <div id="lineItemsTotal" style="display: flex; padding: 12px 16px; background: white; border: 2px solid var(--border); border-radius: 10px; font-weight: 800; font-size: 15px; justify-content: space-between; align-items:center; margin-bottom: 10px;">
                            <span style="color: var(--text);">Total</span>
                            <span id="lineItemsTotalAmount" style="color: var(--text); font-size: 18px; letter-spacing: -0.02em;">$0.00</span>
                        </div>
                    </div>

                    <!-- Note Section (collapsible) -->
                    <details class="modal-collapsible modal-detailed-only" id="modalNoteSection" style="padding: 10px 12px;">
                        <summary>
                            <span class="summary-icon">
                                <i class="fas fa-sticky-note"></i>
                                Add note
                            </span>
                        </summary>
                        <div class="modal-collapsible-content">
                            <textarea 
                                class="form-textarea" 
                                id="modalNote"
                                placeholder="Add any additional notes or comments"
                                rows="2"
                            ></textarea>
                        </div>
                    </details>

                    <!-- ACTIONS -->
                    <div class="form-actions">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); font-weight: 600; cursor: pointer; user-select: none; margin-right: auto;">
                            <input type="checkbox" id="modalAddAnother" style="width: 16px; height: 16px;">
                            <span>Add another after saving</span>
                        </label>
                        <button type="submit" class="btn btn-blue" name="action" value="done">
                            <i class="fas fa-check"></i>
                            Done
                        </button>
                        <button type="submit" class="btn btn-primary" name="action" value="done-receipt">
                            <i class="fas fa-print"></i>
                            Done & Print
                        </button>
                        <button type="button" class="btn btn-tertiary" id="modalCancelBtn">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                    
                    <!-- Receipt Note -->
                    <div class="modal-detailed-only" id="modalReceiptNote" style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-muted); font-style: italic;">
                        You can print a receipt now, or later from the transaction list.
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modern 2-Row Footer -->
<footer class="app-footer">
    <div class="app-footer-container">
        <!-- Top Row -->
        <div class="app-footer-top">
            <!-- Brand Section with Disclaimer -->
            <div class="app-footer-brand">
                <a href="dashboard.html" class="app-footer-brand-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Main body with subtle gray pattern -->
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="white"/>
                        <!-- Folded corner - darker gray -->
                        <path d="M32 4 L38 10 L32 10 Z" fill="rgba(0,0,0,0.15)"/>
                        <!-- Folded corner outline -->
                        <path d="M32 4 L32 10 L38 10" stroke="rgba(0,0,0,0.2)" stroke-width="1.5" stroke-linejoin="round"/>
                        <!-- Receipt lines - light gray -->
                        <line x1="14" y1="14" x2="30" y2="14" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="rgba(0,0,0,0.12)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="rgba(0,0,0,0.15)" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="rgba(0,0,0,0.1)" stroke-width="2.5" stroke-linecap="round"/>
                        <!-- Bottom zigzag - gray -->
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="rgba(0,0,0,0.2)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>SpendNote</span>
                </a>
                <p class="app-footer-brand-desc">
                    Cash receipt management for modern teams. Simple, secure, transparent.
                </p>
            </div>
            
            <!-- Right: Links + Disclaimer -->
            <div class="app-footer-right">
                <div class="app-footer-links-simple">
                    <a href="index.html#features">Features</a>
                    <a href="spendnote-pricing.html">Pricing</a>
                    <a href="spendnote-faq.html">FAQ</a>
                    <a href="spendnote-terms.html">Legal</a>
                </div>
                
                <!-- Disclaimer on right side -->
                <div class="app-footer-brand-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <span>Cash handoff documentation only. Not a tax or accounting tool.</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row -->
        <div class="app-footer-bottom">
            <div class="app-footer-copyright">
                2026 SpendNote. All rights reserved.
            </div>
        </div>
    </div>
</footer>







    <script>
        // ========================================
        // CASH BOX KEBAB MENUS
        // ========================================
        function closeAllRegisterMenus() {
            document.querySelectorAll('.register-menu.open').forEach(m => m.classList.remove('open'));
        }

        document.querySelectorAll('.register-kebab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const card = btn.closest('.register-card');
                const menu = card ? card.querySelector('.register-menu') : null;
                if (!menu) return;
                const isOpen = menu.classList.contains('open');
                closeAllRegisterMenus();
                if (!isOpen) menu.classList.add('open');
            });

            btn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    btn.click();
                }
            });
        });

        document.querySelectorAll('.register-menu').forEach(menu => {
            menu.addEventListener('click', (e) => e.stopPropagation());
        });

        document.querySelectorAll('.menu-settings').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const card = btn.closest('.register-card');
                const cashBoxId = card?.dataset?.id;
                if (cashBoxId) {
                    window.location.href = `spendnote-cash-box-settings.html?cashBoxId=${encodeURIComponent(cashBoxId)}`;
                }
                closeAllRegisterMenus();
            });
        });

        document.querySelectorAll('.menu-delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const card = btn.closest('.register-card');
                const cashBoxId = card?.dataset?.id;
                const name = card?.dataset?.name || 'this Cash Box';
                if (!cashBoxId) {
                    closeAllRegisterMenus();
                    return;
                }

                closeAllRegisterMenus();
                const confirmed = await showConfirm(`Delete "${name}"? This will remove the Cash Box and its data.`, { title: 'Delete Cash Box', iconType: 'danger', okLabel: 'Delete', danger: true });
                if (!confirmed) {
                    return;
                }

                try {
                    if (window.db && window.db.cashBoxes && typeof window.db.cashBoxes.delete === 'function') {
                        const result = await window.db.cashBoxes.delete(cashBoxId);
                        if (result && result.success === false) {
                            throw new Error(result.error || 'Delete failed');
                        }
                    }
                    window.location.reload();
                } catch (error) {
                    console.error('Failed to delete cash box:', error);
                    showAlert('Could not delete the Cash Box.', { iconType: 'error' });
                }
            });
        });

        document.addEventListener('click', closeAllRegisterMenus);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAllRegisterMenus();
        });


        // Filter toggle
        const filterToggle = document.getElementById('filterToggle');
        const filterPanel = document.getElementById('filterPanel');

        if (filterToggle) {
            filterToggle.addEventListener('click', () => {
                filterPanel.classList.toggle('expanded');
                filterToggle.classList.toggle('active');
            });
        }

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        // Nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // Bulk selection
        const selectAllCheckbox = document.getElementById('selectAll');
        const txCheckboxes = document.querySelectorAll('.tx-checkbox');
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        
        // v24: toggle selected row styling
        function syncRowSelection() {
            txCheckboxes.forEach(cb => {
                const row = cb.closest('.table-grid');
                if (row) row.classList.toggle('is-selected', cb.checked);
            });
        }

        function updateBulkActions() {
            const checkedCount = document.querySelectorAll('.tx-checkbox:checked').length;
            if (selectedCount) selectedCount.textContent = checkedCount;
            if (bulkActions) bulkActions.classList.toggle('active', checkedCount > 0);
            if (selectAllCheckbox) selectAllCheckbox.checked = checkedCount === txCheckboxes.length;
            syncRowSelection();
        }

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', () => {
                txCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                updateBulkActions();
            });
        }
        
        txCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                updateBulkActions();
                syncRowSelection();
            });
        });
        
        syncRowSelection();

        // Export button
        const exportBtn = document.querySelector('.export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const rows = document.querySelectorAll('.transactions-table .table-grid:not(.table-header)');
                if (!rows.length) {
                    showAlert('No transactions to export.', { iconType: 'info' });
                    return;
                }
                showAlert(`Export feature coming soon. ${rows.length} transactions ready.`, { iconType: 'info' });
            });
        }

        // Clear filters
        const clearFiltersBtn = document.getElementById('clearFilters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                const filterName = document.getElementById('filterName');
                const filterDesc = document.getElementById('filterDesc');
                const filterDateFrom = document.getElementById('filterDateFrom');
                const filterDateTo = document.getElementById('filterDateTo');
                const filterAmountMin = document.getElementById('filterAmountMin');
                const filterAmountMax = document.getElementById('filterAmountMax');
                if (filterName) filterName.value = '';
                if (filterDesc) filterDesc.value = '';
                if (filterDateFrom) filterDateFrom.value = '';
                if (filterDateTo) filterDateTo.value = '';
                if (filterAmountMin) filterAmountMin.value = '';
                if (filterAmountMax) filterAmountMax.value = '';
            });
        }

        // Apply filters
        const applyFiltersBtn = document.getElementById('applyFilters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                if (filterPanel) filterPanel.classList.remove('expanded');
                if (filterToggle) filterToggle.classList.remove('active');
            });
        }

        if (false) {
        // ========================================
        // MODAL - Simple and Clean
        // ========================================
        const modal = document.getElementById('createTransactionModal');
        const openModalBtn = document.getElementById('addTransactionBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('modalCancelBtn');

        const modalContainerEl = document.getElementById('createTransactionModalContainer');
        const modeQuickEl = document.getElementById('modalModeQuick');
        const modeDetailedEl = document.getElementById('modalModeDetailed');
        const contactDetailsEl = document.getElementById('modalContactDetails');
        const noteDetailsEl = document.getElementById('modalNoteSection');

        let lastModalFocusEl = null;
        let isModalSubmitting = false;

        let modalLineItemCount = 0;
        const maxModalLineItems = 4;
        const modalLineItemsContainer = document.getElementById('modalLineItemsContainer');
        const modalExpandItemsBtn = document.getElementById('modalExpandItemsBtn');
        let modalItemsExpanded = false;

        function updateExpandItemsBtnUI() {
            if (!modalExpandItemsBtn) return;
            if (modalItemsExpanded) {
                modalExpandItemsBtn.innerHTML = `
                    <i class="fas fa-minus-circle"></i>
                    Hide extra items
                `;
            } else {
                modalExpandItemsBtn.innerHTML = `
                    <i class="fas fa-plus-circle"></i>
                    Add more items
                `;
            }
        }

        function setModalSubmittingState(isSubmitting) {
            isModalSubmitting = Boolean(isSubmitting);

            if (closeModalBtn) closeModalBtn.disabled = isModalSubmitting;
            if (cancelModalBtn) cancelModalBtn.disabled = isModalSubmitting;
        }

        function getModalFocusableEls() {
            if (!modalContainerEl) return [];
            return Array.from(
                modalContainerEl.querySelectorAll(
                    'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                )
            ).filter((el) => {
                if (!el) return false;
                if (el.getAttribute('aria-hidden') === 'true') return false;
                return el.offsetParent !== null;
            });
        }

        function handleModalKeydown(e) {
            if (!modal || !modal.classList.contains('active')) return;

            if (e.key === 'Escape') {
                if (isModalSubmitting) {
                    e.preventDefault();
                    return;
                }
                e.preventDefault();
                if (typeof window.closeModal === 'function') window.closeModal();
                else legacyCloseModal();
                return;
            }

            if (e.key === 'Tab') {
                const focusables = getModalFocusableEls();
                if (focusables.length === 0) {
                    e.preventDefault();
                    modalContainerEl?.focus();
                    return;
                }

                const first = focusables[0];
                const last = focusables[focusables.length - 1];
                const active = document.activeElement;

                if (e.shiftKey) {
                    if (active === first || !modalContainerEl.contains(active)) {
                        e.preventDefault();
                        last.focus();
                    }
                    return;
                }

                if (!modalContainerEl.contains(active)) {
                    e.preventDefault();
                    first.focus();
                    return;
                }

                if (active === last) {
                    e.preventDefault();
                    first.focus();
                }
            }
        }

        function handleModalFocusIn(e) {
            if (!modal || !modal.classList.contains('active')) return;
            if (!modalContainerEl) return;

            const target = e.target;
            if (target && modalContainerEl.contains(target)) return;

            const focusables = getModalFocusableEls();
            const first = focusables[0];
            if (first && typeof first.focus === 'function') {
                first.focus();
                return;
            }

            modalContainerEl.focus();
        }

        function setModalBackgroundInert(isInert) {
            const bodyChildren = Array.from(document.body.children || []);
            bodyChildren.forEach((el) => {
                if (!el || el.id === 'createTransactionModal') return;
                if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE') return;

                if (isInert) {
                    el.setAttribute('inert', '');
                } else {
                    el.removeAttribute('inert');
                }
            });
        }

        function updateModalDirectionUI(direction) {
            if (!modalContainerEl) return;
            const dir = direction === 'out' ? 'out' : 'in';
            modalContainerEl.dataset.direction = dir;
        }

        function getStoredModalMode() {
            try {
                const v = localStorage.getItem('spendnote.modalMode');
                return v === 'detailed' ? 'detailed' : 'quick';
            } catch {
                return 'quick';
            }
        }

        function storeModalMode(mode) {
            try {
                localStorage.setItem('spendnote.modalMode', mode);
            } catch {
                // ignore
            }
        }

        function setDetailedItemsExpanded(expanded) {
            modalItemsExpanded = Boolean(expanded);
            if (modalLineItemsContainer) {
                modalLineItemsContainer.style.display = modalItemsExpanded ? '' : 'none';
                if (!modalItemsExpanded) {
                    modalLineItemsContainer.innerHTML = '';
                    modalLineItemCount = 0;
                }
            }
            updateExpandItemsBtnUI();
            if (typeof updateLineItemsTotal === 'function') updateLineItemsTotal();
        }

        function renderDetailedExtraItems(count) {
            if (!modalLineItemsContainer) return;
            modalLineItemsContainer.innerHTML = '';
            modalLineItemCount = 0;

            for (let i = 1; i <= count; i++) {
                modalLineItemCount++;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-row-line-item';
                itemDiv.style.marginBottom = '10px';
                itemDiv.innerHTML = `
                    <div class="form-group">
                        <input 
                            type="text" 
                            class="form-input line-item-input" 
                            placeholder="Item description"
                            autocomplete="off"
                            data-item-index="${modalLineItemCount}"
                        >
                    </div>
                    <div class="form-group">
                        <div class="input-with-prefix">
                            <span class="input-prefix">$</span>
                            <input 
                                type="number" 
                                class="form-input line-item-input line-item-amount" 
                                placeholder="0.00"
                                step="0.01"
                                min="0"
                                data-amount-index="${modalLineItemCount}"
                            >
                        </div>
                    </div>
                `;

                modalLineItemsContainer.appendChild(itemDiv);
                itemDiv.querySelectorAll('.line-item-amount').forEach(input => {
                    input.addEventListener('input', updateLineItemsTotal);
                });
            }
        }

        function updateModalModeUI(mode, { persist = true } = {}) {
            if (!modalContainerEl) return;
            const m = mode === 'detailed' ? 'detailed' : 'quick';
            modalContainerEl.dataset.mode = m;

            if (modeQuickEl && modeDetailedEl) {
                modeQuickEl.checked = m === 'quick';
                modeDetailedEl.checked = m === 'detailed';
            }

            if (m !== 'detailed') {
                setDetailedItemsExpanded(false);
            } else {
                if (modalExpandItemsBtn) modalExpandItemsBtn.style.display = '';
                if (modalLineItemsContainer && !modalItemsExpanded) modalLineItemsContainer.style.display = 'none';
                updateExpandItemsBtnUI();
            }

            const itemsTitleEl = document.getElementById('modalItemsSectionTitle');
            const itemsDescHeaderEl = document.getElementById('modalItemsDescriptionHeader');
            const mainDescInputEl = document.getElementById('modalDescription');

            const isQuick = m === 'quick';
            const descHeaderText = isQuick ? 'Transaction description' : 'Description';
            const descPlaceholder = isQuick ? 'Transaction description' : 'Item description';

            if (itemsTitleEl) {
                itemsTitleEl.textContent = 'Items';
                itemsTitleEl.style.display = isQuick ? 'none' : '';
            }
            if (itemsDescHeaderEl) {
                const required = itemsDescHeaderEl.querySelector('.required');
                itemsDescHeaderEl.textContent = descHeaderText + ' ';
                if (required) itemsDescHeaderEl.appendChild(required);
            }
            if (mainDescInputEl) mainDescInputEl.placeholder = descPlaceholder;

            const extraDescInputs = Array.from(document.querySelectorAll('#modalLineItemsContainer .line-item-input:not(.line-item-amount)'));
            extraDescInputs.forEach((el) => {
                if (el && el.placeholder) el.placeholder = descPlaceholder;
            });

            if (persist) storeModalMode(m);
            if (typeof updateLineItemsTotal === 'function') updateLineItemsTotal();
        }

        function legacyOpenModal(preset) {
            const isEventLike = preset && typeof preset === 'object' && 'preventDefault' in preset && 'target' in preset;
            const options = isEventLike ? {} : (preset || {});

            // Initialize cash box carousel from rendered dashboard cards
            initModalCashboxCarousel();
            if (!modalCashBoxes || modalCashBoxes.length === 0) {
                showAlert('You need to create a Cash Box before recording transactions.', { iconType: 'warning' }).then(() => {
                    window.location.href = 'spendnote-cash-box-settings.html';
                });
                return;
            }

            lastModalFocusEl = document.activeElement;

            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            setModalBackgroundInert(true);
            document.addEventListener('keydown', handleModalKeydown, true);
            document.addEventListener('focusin', handleModalFocusIn, true);

            const dateFieldEl = document.getElementById('modalDateField');
            if (dateFieldEl) {
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                dateFieldEl.value = `${mm}/${dd}/${yyyy}`;
                dateFieldEl.dataset.fullDate = now.toISOString();

                const dateValueEl = document.getElementById('modalDate');
                if (dateValueEl) dateValueEl.value = `${yyyy}-${mm}-${dd}`;
            }
            
            if (options.cashBoxId) {
                // Find the cash box index by ID and set it
                const idx = modalCashBoxes.findIndex(cb => cb.id === options.cashBoxId);
                if (idx >= 0) {
                    modalCashBoxIndex = idx;
                    updateModalCashboxDisplay();
                }
            }

            if (options.direction === 'in' || options.direction === 'out') {
                const inEl = document.getElementById('modalDirectionIn');
                const outEl = document.getElementById('modalDirectionOut');
                if (inEl && outEl) {
                    inEl.checked = options.direction === 'in';
                    outEl.checked = options.direction === 'out';
                }
            }

            const checkedDirEl = document.querySelector('input[name="modalDirection"]:checked');
            updateModalDirectionUI(checkedDirEl ? checkedDirEl.value : 'in');

            const initialMode = (options.mode === 'detailed' || options.mode === 'quick')
                ? options.mode
                : getStoredModalMode();
            updateModalModeUI(initialMode, { persist: false });

            if (initialMode !== 'detailed') {
                const noteSection = document.getElementById('modalNoteSection');
                if (noteSection) noteSection.open = false;
            }

            const focusPrimary = () => {
                const checkedDirElForFocus = document.querySelector('input[name="modalDirection"]:checked');
                const focusId = checkedDirElForFocus ? checkedDirElForFocus.id : 'modalDirectionIn';
                const focusLabelEl = modalContainerEl?.querySelector(`label[for="${focusId}"]`);
                if (focusLabelEl && typeof focusLabelEl.focus === 'function') {
                    focusLabelEl.focus();
                    return;
                }
                if (checkedDirElForFocus && typeof checkedDirElForFocus.focus === 'function') {
                    checkedDirElForFocus.focus();
                    return;
                }
                modalContainerEl?.focus();
            };

            requestAnimationFrame(() => requestAnimationFrame(focusPrimary));
        }

        if (openModalBtn && !openModalBtn.dataset.modalBound) {
            openModalBtn.dataset.modalBound = '1';
            openModalBtn.addEventListener('click', (e) => {
                if (typeof window.openModal === 'function') {
                    window.openModal(e);
                } else {
                    legacyOpenModal(e);
                }
            });
        }

        // Open modal if hash is #new-transaction (legacy fallback only)
        (function() {
            if (window.location.hash !== '#new-transaction') return;
            const params = new URLSearchParams(window.location.search);
            if (params.get('duplicate')) return;

            const getPresetFromUrl = () => {
                const cashBoxId = params.get('cashBoxId');
                const direction = params.get('direction');
                const preset = {};
                if (cashBoxId) {
                    const raw = String(cashBoxId || '').trim();
                    let resolved = '';

                    try {
                        const isUuid = Boolean(window.SpendNoteIds && typeof window.SpendNoteIds.isUuid === 'function'
                            ? window.SpendNoteIds.isUuid(raw)
                            : /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(raw));
                        if (isUuid) {
                            resolved = raw;
                        }
                    } catch (_) {
                        // ignore
                    }

                    if (!resolved) {
                        try {
                            const seq = (window.SpendNoteIds && typeof window.SpendNoteIds.parseCashBoxDisplayId === 'function')
                                ? window.SpendNoteIds.parseCashBoxDisplayId(raw)
                                : null;
                            if (Number.isFinite(seq) && seq > 0) {
                                const card = document.querySelector('.register-card[data-sequence-number="' + String(seq) + '"]');
                                const uuid = card ? String(card.dataset.id || '').trim() : '';
                                if (uuid) resolved = uuid;
                            }
                        } catch (_) {
                            // ignore
                        }
                    }

                    if (resolved) preset.cashBoxId = resolved;
                }
                if (direction === 'in' || direction === 'out') preset.direction = direction;
                return preset;
            };
            const openFromHash = () => {
                const preset = getPresetFromUrl();
                setTimeout(() => {
                    if (typeof window.openModal === 'function') {
                        window.openModal(preset);
                    } else {
                        legacyOpenModal(preset);
                    }
                }, 0);
                history.replaceState(null, null, 'dashboard.html');
            };
            if (window.__spendnoteDashboardDataLoaded) {
                openFromHash();
                return;
            }
            window.addEventListener('SpendNoteDashboardDataLoaded', openFromHash, { once: true });
        })();

        // Close modal
        function legacyCloseModal() {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            setModalBackgroundInert(false);
            document.removeEventListener('keydown', handleModalKeydown, true);
            document.removeEventListener('focusin', handleModalFocusIn, true);
            // Reset form
            document.getElementById('modalTransactionForm').reset();
            updateModalDirectionUI('in');
            updateModalModeUI(getStoredModalMode(), { persist: false });
            const lineItemsContainer = document.getElementById('modalLineItemsContainer');
            if (lineItemsContainer) {
                lineItemsContainer.innerHTML = '';
            }
            setDetailedItemsExpanded(false);
            const noteSection = document.getElementById('modalNoteSection');
            if (noteSection) noteSection.open = false;
            if (typeof updateLineItemsTotal === 'function') {
                updateLineItemsTotal();
            }

            if (lastModalFocusEl && typeof lastModalFocusEl.focus === 'function') {
                try {
                    lastModalFocusEl.focus();
                } catch {
                    // ignore
                }
            }
            lastModalFocusEl = null;
        }

        if (closeModalBtn) closeModalBtn.addEventListener('click', () => {
            if (typeof window.closeModal === 'function') window.closeModal();
            else legacyCloseModal();
        });
        if (cancelModalBtn) cancelModalBtn.addEventListener('click', () => {
            if (typeof window.closeModal === 'function') window.closeModal();
            else legacyCloseModal();
        });

        const dirInRadio = document.getElementById('modalDirectionIn');
        const dirOutRadio = document.getElementById('modalDirectionOut');
        if (dirInRadio) dirInRadio.addEventListener('change', () => updateModalDirectionUI('in'));
        if (dirOutRadio) dirOutRadio.addEventListener('change', () => updateModalDirectionUI('out'));

        const dirInLabel = document.querySelector('label[for="modalDirectionIn"]');
        const dirOutLabel = document.querySelector('label[for="modalDirectionOut"]');
        if (dirInLabel) {
            dirInLabel.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    dirInLabel.click();
                }
            });
        }
        if (dirOutLabel) {
            dirOutLabel.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    dirOutLabel.click();
                }
            });
        }

        if (modeQuickEl) modeQuickEl.addEventListener('change', () => updateModalModeUI('quick'));
        if (modeDetailedEl) modeDetailedEl.addEventListener('change', () => updateModalModeUI('detailed'));

        // Close on overlay click
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (isModalSubmitting) return;
                if (e.target === modal) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (modalContainerEl && typeof modalContainerEl.focus === 'function') {
                        modalContainerEl.focus();
                    }
                }
            });
        }

        // Modal Cash Box Carousel - uses real Supabase cash boxes
        let modalCashBoxes = [];
        let modalCashBoxIndex = 0;
        
        function initModalCashboxCarousel() {
            // Get cash boxes from the dashboard cards (already loaded from Supabase)
            const dashboardCards = document.querySelectorAll('.register-card');
            modalCashBoxes = [];
            
            dashboardCards.forEach(card => {
                if (card.dataset.id) {
                    const renderedIconEl = card.querySelector('.register-icon i');
                    const renderedIconClass = renderedIconEl
                        ? Array.from(renderedIconEl.classList).find((cls) => cls.startsWith('fa-') && cls !== 'fa-fw')
                        : null;

                    let displayId = String(card.dataset.displayCode || '').trim();
                    if (!displayId) {
                        const idEl = card.querySelector('.register-id');
                        if (idEl) displayId = String(idEl.textContent || '').trim();
                    }
                    if (!displayId) {
                        const seq = Number(card.dataset.sequenceNumber || '');
                        if (Number.isFinite(seq) && seq > 0) {
                            displayId = `SN-${String(seq).padStart(3, '0')}`;
                        }
                    }

                    modalCashBoxes.push({
                        id: card.dataset.id,
                        name: card.querySelector('.register-name')?.textContent || 'Cash Box',
                        displayId,
                        color: card.dataset.color || '#059669',
                        rgb: card.dataset.rgb || '5, 150, 105',
                        icon: renderedIconClass || card.dataset.icon || 'fa-cash-register'
                    });
                }
            });
            
            if (modalCashBoxes.length === 0) {
                modalCashBoxIndex = 0;
                return;
            }
            
            modalCashBoxIndex = 0;
            updateModalCashboxDisplay();
        }
        
        function updateModalCashboxDisplay() {
            const cashbox = modalCashBoxes[modalCashBoxIndex];
            if (!cashbox) return;
            
            const iconEl = document.getElementById('modalCashboxIcon');
            const nameEl = document.getElementById('modalCashboxName');
            const idDisplayEl = document.getElementById('modalCashboxIdDisplay');
            const balanceEl = document.getElementById('modalCashboxBalance');
            const idInput = document.getElementById('modalCashBoxId');
            
            if (iconEl) {
                iconEl.innerHTML = `<i class="fas ${cashbox.icon}"></i>`;
                iconEl.style.background = cashbox.color;
            }
            if (nameEl) {
                nameEl.textContent = cashbox.name;
            }
            if (idDisplayEl) {
                let codeText = String(cashbox.displayId || '').trim();
                if (!codeText) {
                    const dashboardCard = document.querySelector(`.register-card[data-id="${cashbox.id}"]`);
                    if (dashboardCard) {
                        codeText = String(dashboardCard.dataset.displayCode || '').trim();
                        if (!codeText) {
                            const idEl = dashboardCard.querySelector('.register-id');
                            if (idEl) codeText = String(idEl.textContent || '').trim();
                        }
                        if (!codeText) {
                            const seq = Number(dashboardCard.dataset.sequenceNumber || '');
                            if (Number.isFinite(seq) && seq > 0) {
                                codeText = `SN-${String(seq).padStart(3, '0')}`;
                            }
                        }
                    }
                }
                idDisplayEl.textContent = codeText || '—';
            }
            if (balanceEl) {
                // Get balance from dashboard card if available
                const dashboardCard = document.querySelector(`.register-card[data-id="${cashbox.id}"]`);
                const balanceText = dashboardCard?.querySelector('.register-balance')?.textContent || '';
                balanceEl.textContent = balanceText ? `Balance: ${balanceText}` : '';
            }
            if (idInput) {
                idInput.value = cashbox.id;
            }
            
            // Update active color
            if (cashbox.color && cashbox.rgb) {
                document.documentElement.style.setProperty('--active', cashbox.color);
                document.documentElement.style.setProperty('--active-rgb', cashbox.rgb);
                localStorage.setItem('activeCashBoxColor', cashbox.color);
                localStorage.setItem('activeCashBoxRgb', cashbox.rgb);
                updateMenuColors(cashbox.color);
            }
        }
        
        // Cash box carousel navigation (tiny up/down arrows)
        const cashboxPrevBtn = document.getElementById('modalCashboxPrev');
        const cashboxNextBtn = document.getElementById('modalCashboxNext');
        
        if (cashboxPrevBtn) {
            cashboxPrevBtn.addEventListener('click', () => {
                if (modalCashBoxes.length > 1) {
                    modalCashBoxIndex = (modalCashBoxIndex - 1 + modalCashBoxes.length) % modalCashBoxes.length;
                    updateModalCashboxDisplay();
                }
            });
        }
        
        if (cashboxNextBtn) {
            cashboxNextBtn.addEventListener('click', () => {
                if (modalCashBoxes.length > 1) {
                    modalCashBoxIndex = (modalCashBoxIndex + 1) % modalCashBoxes.length;
                    updateModalCashboxDisplay();
                }
            });
        }

        // Contact Autocomplete
        if (false) {
        const ContactInput = document.getElementById('modalContactName');
        const ContactDropdown = document.getElementById('ContactAutocomplete');
        const ContactAddressInput = document.getElementById('modalContactAddress');
        const ContactIdInput = document.getElementById('modalContactId');

        function formatContactDisplayId(sequenceNumber) {
            const n = Number(sequenceNumber);
            if (!Number.isFinite(n) || n <= 0) return '';
            return `CONT-${String(n).padStart(3, '0')}`;
        }
        
        // Contacts loaded from Supabase
        let Contacts = [];
        let contactsLoaded = false;
        
        async function loadContactsForAutocomplete() {
            if (contactsLoaded) return;
            // Wait for db to be available
            if (!window.db || !window.db.contacts) {
                setTimeout(loadContactsForAutocomplete, 200);
                return;
            }
            try {
                const data = await window.db.contacts.getAll();
                Contacts = (data || []).map(c => ({
                    id: c.id,
                    name: c.name || '',
                    address: c.address || '',
                    contact: c.email || '',
                    displayId: formatContactDisplayId(c.sequence_number)
                }));
                contactsLoaded = true;
                console.log('Contacts loaded for autocomplete:', Contacts.length);
            } catch (e) {
                console.error('Failed to load contacts:', e);
            }
        }
        
        // Start trying to load contacts (will retry until db is ready)
        loadContactsForAutocomplete();
        
        let selectedContactIndex = -1;
        
        function filterContacts(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return Contacts.filter(p => 
                p.name.toLowerCase().includes(lowerQuery) ||
                (p.displayId && p.displayId.toLowerCase().includes(lowerQuery)) ||
                (p.address && p.address.toLowerCase().includes(lowerQuery))
            );
        }
        
        function showAutocomplete(results) {
            if (results.length === 0 && ContactInput.value.length > 0) {
                ContactDropdown.innerHTML = `
                    <div class="autocomplete-add-new" data-action="add-new">
                        <i class="fas fa-plus"></i>
                        Add "${ContactInput.value}" as new Contact
                    </div>
                `;
                ContactDropdown.classList.add('show');
                return;
            }
            
            if (results.length === 0) {
                ContactDropdown.classList.remove('show');
                return;
            }
            
            let html = results.map((Contact, index) => `
                <div class="autocomplete-item ${index === selectedContactIndex ? 'active' : ''}" data-index="${index}">
                    <div class="autocomplete-item-name">${Contact.name}</div>
                    <div class="autocomplete-item-details">
                        ${Contact.displayId ? `<div class="autocomplete-item-detail"><i class="fas fa-tag"></i>${Contact.displayId}</div>` : ''}
                        ${Contact.address ? `<div class="autocomplete-item-detail"><i class="fas fa-map-marker-alt"></i>${Contact.address.split(',')[0]}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            html += `
                <div class="autocomplete-add-new" data-action="add-new">
                    <i class="fas fa-plus"></i>
                    Add new Contact
                </div>
            `;
            
            ContactDropdown.innerHTML = html;
            ContactDropdown.classList.add('show');
            
            // Add click handlers
            ContactDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectContact(filterContacts(ContactInput.value)[index]);
                });
            });
            
            ContactDropdown.querySelector('.autocomplete-add-new').addEventListener('click', () => {
                ContactDropdown.classList.remove('show');
                ContactInput.focus();
            });
        }
        
        function selectContact(Contact) {
            ContactInput.value = Contact.name;
            if (typeof window.__setModalContactAddress === 'function') {
                window.__setModalContactAddress(Contact.address);
            } else {
                document.getElementById('modalContactAddress').value = Contact.address;
            }
            document.getElementById('modalContactId').value = Contact.id;
            ContactDropdown.classList.remove('show');
            selectedContactIndex = -1;
        }
        
        // Input event
        ContactInput.addEventListener('input', (e) => {
            if (ContactIdInput) ContactIdInput.value = '';
            const results = filterContacts(e.target.value);
            showAutocomplete(results);
            selectedContactIndex = -1;
        });
        
        // Focus event - also try to load contacts if not loaded yet
        ContactInput.addEventListener('focus', async (e) => {
            if (!contactsLoaded) {
                await loadContactsForAutocomplete();
            }
            if (e.target.value) {
                const results = filterContacts(e.target.value);
                showAutocomplete(results);
            }
        });
        
        // Keyboard navigation
        ContactInput.addEventListener('keydown', (e) => {
            const items = ContactDropdown.querySelectorAll('.autocomplete-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedContactIndex = Math.min(selectedContactIndex + 1, items.length - 1);
                updateActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedContactIndex = Math.max(selectedContactIndex - 1, -1);
                updateActiveItem();
            } else if (e.key === 'Enter' && selectedContactIndex >= 0) {
                e.preventDefault();
                const results = filterContacts(ContactInput.value);
                if (results[selectedContactIndex]) {
                    selectContact(results[selectedContactIndex]);
                }
            } else if (e.key === 'Escape') {
                ContactDropdown.classList.remove('show');
                selectedContactIndex = -1;
            }
        });
        
        function updateActiveItem() {
            const items = ContactDropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === selectedContactIndex);
            });
            
            // Scroll into view
            if (selectedContactIndex >= 0 && items[selectedContactIndex]) {
                items[selectedContactIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!ContactInput.contains(e.target) && !ContactDropdown.contains(e.target)) {
                ContactDropdown.classList.remove('show');
                selectedContactIndex = -1;
            }
        });
        }

        // Description Autocomplete
        const descriptionInput = document.getElementById('modalDescription');
        const descriptionDropdown = document.getElementById('descriptionAutocomplete');
        
        const recentDescriptions = [
            'Office supplies',
            'Retail cash deposit',
            'Customer payment',
            'Marketing campaign',
            'Product sales',
            'Employee salary',
            'Rent payment',
            'Utility bills',
            'Equipment purchase',
            'Consulting services'
        ];
        
        function setupSimpleAutocomplete(input, dropdown, dataArray) {
            if (!input || !dropdown || !Array.isArray(dataArray)) return;
            let selectedIndex = -1;
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (!query) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const results = dataArray.filter(item => item.toLowerCase().includes(query));
                
                if (results.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const html = results.map((item, index) => `
                    <div class="autocomplete-item ${index === selectedIndex ? 'active' : ''}" data-value="${item}">
                        <div class="autocomplete-item-name">${item}</div>
                    </div>
                `).join('');
                
                dropdown.innerHTML = html;
                dropdown.classList.add('show');
                
                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        input.value = item.dataset.value;
                        dropdown.classList.remove('show');
                        selectedIndex = -1;
                    });
                });
            });
            
            input.addEventListener('focus', (e) => {
                if (e.target.value) {
                    const event = new Event('input', { bubbles: true });
                    e.target.dispatchEvent(event);
                }
            });
            
            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateItems();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateItems();
                } else if (e.key === 'Enter' && selectedIndex >= 0 && items[selectedIndex]) {
                    e.preventDefault();
                    input.value = items[selectedIndex].dataset.value;
                    dropdown.classList.remove('show');
                    selectedIndex = -1;
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    selectedIndex = -1;
                }
            });
            
            function updateItems() {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === selectedIndex);
                });
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].scrollIntoView({ block: 'nearest' });
                }
            }
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    selectedIndex = -1;
                }
            });
        }
        
        if (descriptionInput && descriptionDropdown) {
            setupSimpleAutocomplete(descriptionInput, descriptionDropdown, recentDescriptions);
        }
        
        // Transaction ID Autocomplete
        const transactionIdInput = document.getElementById('modalTransactionId');
        const transactionIdDropdown = document.getElementById('transactionIdAutocomplete');
        
        const recentTransactionIds = [
            'PO-2026-001',
            'INV-2026-045',
            'ORD-2025-789',
            'REF-2026-012',
            'PO-2025-998',
            'INV-2025-999'
        ];
        
        if (transactionIdInput && transactionIdDropdown) {
            setupSimpleAutocomplete(transactionIdInput, transactionIdDropdown, recentTransactionIds);
        }

        if (modalExpandItemsBtn) {
            modalExpandItemsBtn.addEventListener('click', () => {
                if (modalItemsExpanded) {
                    setDetailedItemsExpanded(false);
                    return;
                }
                renderDetailedExtraItems(maxModalLineItems);
                setDetailedItemsExpanded(true);
            });
        }

        function parseModalAmount(value) {
            const normalized = String(value || '')
                .replace(/\s+/g, '')
                .replace(/,/g, '.');
            const num = parseFloat(normalized);
            return Number.isFinite(num) ? num : 0;
        }

        function updateLineItemsTotal() {
            const lineItemsTotal = document.getElementById('lineItemsTotal');
            const lineItemsTotalAmount = document.getElementById('lineItemsTotalAmount');
            const mainAmountField = document.getElementById('modalAmount');
            if (!lineItemsTotal || !lineItemsTotalAmount) return;

            const isDetailed = document.getElementById('createTransactionModalContainer')?.dataset?.mode === 'detailed';
            
            const baseAmount = parseModalAmount(mainAmountField?.value);
            let extrasTotal = 0;

            if (isDetailed) {
                document.querySelectorAll('#modalLineItemsContainer .line-item-amount').forEach(input => {
                    const value = parseModalAmount(input.value);
                    if (value > 0) {
                        extrasTotal += value;
                    }
                });
            }

            const total = baseAmount + extrasTotal;

            lineItemsTotal.style.display = 'flex';
            lineItemsTotalAmount.textContent = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(total);
        }

        const modalAmountInputForTotal = document.getElementById('modalAmount');
        if (modalAmountInputForTotal) {
            modalAmountInputForTotal.addEventListener('input', updateLineItemsTotal);
        }

        // Form submission - handled by dashboard-form.js
        if (typeof initTransactionForm === 'function') {
            initTransactionForm();
        }


        }

    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260216-2236"></script>
    <script src="assets/js/auth-guard.js?v=20260213-1658"></script>
    <script src="assets/js/modal-dialogs.js?v=20260208-1900"></script>
    <script src="assets/js/nav-loader.js?v=20260217-0200"></script>
    <script>loadNav();</script>
    <script src="assets/js/main.js?v=20260217-2001"></script>
    <script src="assets/js/dashboard-ui.js?v=8"></script>
    <script src="assets/js/dashboard-modal.js?v=20260208-0502"></script>
    <script src="assets/js/dashboard-form.js?v=20260217-0121"></script>
    <script src="assets/js/dashboard-data.js?v=20260217-2001"></script>

    <!-- Swiper JS -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script>
        // CASH BOX CARDS INITIALIZATION
        // ========================================
        function initCashBoxCards() {
            const cards = document.querySelectorAll('.register-card');
            const addCashBoxCard = document.querySelector('.add-cash-box-card');

            const activateCard = (card) => {
                if (!card) return;
                const color = card.dataset.color;
                const rgb = card.dataset.rgb;

                cards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');

                document.documentElement.style.setProperty('--active', color);
                document.documentElement.style.setProperty('--active-rgb', rgb);

                localStorage.setItem('activeCashBoxColor', color);
                localStorage.setItem('activeCashBoxRgb', rgb);
                localStorage.setItem('activeCashBoxId', card.dataset.id);

                updateMenuColors(color);
                updateTableHeaderColor(rgb);
            };
            
            cards.forEach(card => {
                // Set card color CSS variables
                const color = card.dataset.color;
                const rgb = card.dataset.rgb;
                card.style.setProperty('--card-color', color);
                card.style.setProperty('--card-rgb', rgb);

                const quickButtons = Array.from(card.querySelectorAll('.register-quick-btn'));
                quickButtons.forEach((btn) => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const direction = btn.getAttribute('data-quick');
                        activateCard(card);
                        if (typeof window.openModal === 'function') {
                            window.openModal({ cashBoxId: card.dataset.id, direction });
                        }
                    });
                });

                // Click to activate
                card.addEventListener('click', (e) => {
                    // Don't activate if clicking menu button
                    if (e.target.closest('.register-kebab') || e.target.closest('.register-menu') || e.target.closest('.register-quick-actions') || e.target.closest('.register-icon-link')) {
                        return;
                    }

                    activateCard(card);
                });
                
                // Double-click to navigate to Cash Box Detail
                card.addEventListener('dblclick', (e) => {
                    if (e.target.closest('.register-kebab') || e.target.closest('.register-menu') || e.target.closest('.register-quick-actions') || e.target.closest('.register-icon-link')) {
                        return;
                    }
                    const cashboxId = card.dataset.id;
                    window.location.href = `spendnote-cash-box-detail.html?cashBoxId=${encodeURIComponent(cashboxId)}`;
                });
            });
            
            // Restore saved selection when available; fallback to first cash box
            const savedId = String(localStorage.getItem('activeCashBoxId') || '').trim();
            const savedCard = savedId ? Array.from(cards).find(card => card.dataset.id === savedId) : null;
            const firstCard = cards[0] || null;
            if (savedCard) {
                activateCard(savedCard);
            } else if (firstCard) {
                activateCard(firstCard);
            }

            if (addCashBoxCard) {
                requestAnimationFrame(() => {
                    const heights = Array.from(document.querySelectorAll('.register-card'))
                        .map((el) => el.getBoundingClientRect().height)
                        .filter((h) => Number.isFinite(h) && h > 0);
                    const maxHeight = heights.length ? Math.max(...heights) : 0;
                    if (maxHeight) {
                        addCashBoxCard.style.minHeight = `${Math.ceil(maxHeight)}px`;
                    }
                });
            }
        }

        // updateMenuColors is provided by main.js (window.updateMenuColors)

        // Update table header color dynamically
        function updateTableHeaderColor(rgb) {
            const txHeader = document.getElementById('transactionsHeader');
            if (txHeader) txHeader.style.setProperty('--cashbox-rgb', rgb);
            const txTable = document.getElementById('transactionsTable');
            if (txTable) txTable.style.setProperty('--cashbox-rgb', rgb);
        }

        // ========================================
        // SWIPER INITIALIZATION
        // ========================================
        window.registersSwiper = new Swiper('.registers-swiper', {
            slidesPerView: 1,
            spaceBetween: 20,
            loop: false,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next-custom',
                prevEl: '.swiper-button-prev-custom',
            },
            breakpoints: {
                640: {
                    slidesPerView: 2,
                    spaceBetween: 20,
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 24,
                },
            },
        });

        // Note: we intentionally do NOT update the selected cash box on slide change.
        // Selection should follow click, while Swiper navigation only changes what is visible.

        // ========================================
        // INITIALIZE EVERYTHING AFTER SWIPER
        // ========================================
        initCashBoxCards();
        
        // Navigate to the correct slide based on URL parameter (cashbox ID)
        const urlParams = new URLSearchParams(window.location.search);
        const returnFromCashBoxIdRaw = urlParams.get('cashBoxId');
        let returnFromCashBoxId = '';
        if (returnFromCashBoxIdRaw) {
            try {
                const ok = Boolean(window.SpendNoteIds && typeof window.SpendNoteIds.isUuid === 'function'
                    ? window.SpendNoteIds.isUuid(returnFromCashBoxIdRaw)
                    : /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(returnFromCashBoxIdRaw || '').trim()));
                if (ok) returnFromCashBoxId = String(returnFromCashBoxIdRaw).trim();
            } catch (_) {
                returnFromCashBoxId = '';
            }
        }
        if (returnFromCashBoxId) {
            // Find the slide index for the cashbox ID
            const allSlides = document.querySelectorAll('.swiper-slide');
            let targetIndex = -1;
            allSlides.forEach((slide, index) => {
                const card = slide.querySelector('.register-card');
                if (card) {
                    const cashBoxId = card.dataset.id;
                    if (cashBoxId && cashBoxId === returnFromCashBoxId) {
                        targetIndex = index;
                    }
                }
            });
            // Navigate to the slide (including index 0)
            if (targetIndex >= 0) {
                registersSwiper.slideTo(targetIndex, 0); // 0 = instant, no animation
            }
        }
        
        // Set initial active card color
        const activeCard = document.querySelector('.register-card.active');
        if (activeCard) {
            document.documentElement.style.setProperty('--active', activeCard.dataset.color);
            document.documentElement.style.setProperty('--active-rgb', activeCard.dataset.rgb);
            // Set initial menu colors
            updateMenuColors(activeCard.dataset.color);
            // Update table header color
            updateTableHeaderColor(activeCard.dataset.rgb);
        }

        // ========================================
        // LOAD REAL DATA FROM SUPABASE
        // ========================================
        // Load dashboard data after Swiper is initialized
        if (typeof loadDashboardData === 'function') {
            loadDashboardData();
        }

        // ========================================
        // TRANSACTIONS MENU - ADD CASHBOX FILTER
        // ========================================
        const transactionsLink = document.getElementById('navTransactions');
        if (transactionsLink) {
            transactionsLink.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'spendnote-transaction-history.html';
            });
        }

        // ========================================
        // ADD CASH BOX CARD - CONDITIONAL LOGIC
        // ========================================
        function handleAddCashBoxDashboard() {
            const card = document.querySelector('.add-cash-box-card');
            const plan = card.getAttribute('data-plan'); // 'free', 'standard', 'pro'
            const boxCount = parseInt(card.getAttribute('data-box-count'));
            
            // Plan limits: Free = 1, Standard = 2, Pro = unlimited
            const planLimits = {
                'free': 1,
                'standard': 2,
                'pro': Infinity
            };
            
            const limit = planLimits[plan] || 1;
            
            if (boxCount >= limit) {
                // User reached limit - show upgrade message
                if (plan === 'free') {
                    showAlert('You have reached the Free plan limit (1 Cash Box).\n\nUpgrade to Standard to create up to 2 Cash Boxes.', { iconType: 'warning', title: 'Plan Limit Reached' });
                } else if (plan === 'standard') {
                    showAlert('You have reached the Standard plan limit (2 Cash Boxes).\n\nUpgrade to Pro for unlimited Cash Boxes.', { iconType: 'warning', title: 'Plan Limit Reached' });
                }
            } else {
                // User can still add more - open create flow
                window.location.href = 'spendnote-cash-box-settings.html';
            }
        }

        // Initialize Add Cash Box card state on page load
        (function initAddCashBoxCard() {
            const card = document.querySelector('.add-cash-box-card');
            if (!card) return;
            
            const plan = card.getAttribute('data-plan');
            const boxCount = parseInt(card.getAttribute('data-box-count'));
            
            const planLimits = {
                'free': 1,
                'standard': 2,
                'pro': Infinity
            };
            
            const limit = planLimits[plan] || 1;
            const upgradeMessages = card.querySelectorAll('.add-cash-box-upgrade');
            
            if (boxCount >= limit) {
                // Disable card and show appropriate upgrade message
                card.classList.add('disabled');
                
                upgradeMessages.forEach(msg => {
                    const upgradeType = msg.getAttribute('data-upgrade-text');
                    if ((plan === 'free' && upgradeType === 'standard') ||
                        (plan === 'standard' && upgradeType === 'pro')) {
                        msg.style.display = 'block';
                    } else {
                        msg.style.display = 'none';
                    }
                });
            } else {
                // Card is clickable, hide all upgrade messages
                card.classList.remove('disabled');
                upgradeMessages.forEach(msg => msg.style.display = 'none');
            }
        })();

        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            if (event.data && event.data.type === 'RECEIPT_PRINT_DONE') {
                const returnTo = event.data.returnTo;
                if (returnTo && returnTo !== window.location.href) {
                    window.location.href = returnTo;
                }
            }
        });

    </script>
</body>
</html>
