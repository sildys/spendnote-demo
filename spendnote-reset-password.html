<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Set your new SpendNote password.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <title>Set New Password - SpendNote</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            max-width: 520px;
            width: 100%;
            box-shadow: 0 4px 24px var(--shadow);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 28px;
        }

        .logo-mark {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-mark svg { width: 44px; height: 44px; }

        .logo-text {
            font-size: 24px;
            font-weight: 900;
            color: var(--text);
            letter-spacing: -0.03em;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-title {
            font-size: 30px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-muted);
            font-size: 15px;
            line-height: 1.5;
        }

        .message {
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            display: none;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .message.show { display: flex; align-items: center; gap: 10px; }

        .message.error {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.45);
            color: #b91c1c;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.45);
            color: #047857;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }

        .auth-footer {
            text-align: center;
            margin-top: 18px;
            font-size: 14px;
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover { text-decoration: underline; }

        .success-state { display: none; text-align: center; }
        .success-state.show { display: block; }
        .form-state.hide { display: none; }

        .hint {
            color: var(--text-muted);
            font-size: 12px;
        }

        @media (max-width: 640px) {
            .auth-card { padding: 28px 20px; }
            .auth-title { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <a href="/" class="logo-mark">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#logo-gradient)"/>
                        <path d="M32 4 L38 10 L32 10 Z" fill="#000000" opacity="0.25"/>
                        <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
                        <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <line x1="14" y1="19" x2="26" y2="19" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.8"/>
                        <line x1="14" y1="24" x2="30" y2="24" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <line x1="14" y1="29" x2="22" y2="29" stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
                        <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="logo-gradient" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#059669"/>
                                <stop offset="100%" stop-color="#10b981"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="logo-text">SpendNote</span>
                </a>
            </div>

            <div class="form-state" id="formState">
                <div class="auth-header">
                    <h1 class="auth-title">Set a new password</h1>
                    <p class="auth-subtitle">Enter your new password to finish account recovery.</p>
                </div>

                <div class="message error" id="errorMessage">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Something went wrong.</span>
                </div>

                <form class="auth-form" id="resetForm">
                    <div class="form-group">
                        <label class="form-label" for="newPassword">New password</label>
                        <input id="newPassword" class="form-input" type="password" autocomplete="new-password" placeholder="At least 8 characters" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm new password</label>
                        <input id="confirmPassword" class="form-input" type="password" autocomplete="new-password" placeholder="Repeat your new password" required>
                        <div class="hint">Min. 8 characters, uppercase, lowercase, and a number or symbol.</div>
                    </div>

                    <button class="btn btn-primary" id="submitBtn" type="submit">Update password</button>
                </form>

                <div class="auth-footer">
                    <a href="spendnote-login.html"><i class="fas fa-arrow-left"></i> Back to login</a>
                </div>
            </div>

            <div class="success-state" id="successState">
                <div class="message success show">
                    <i class="fas fa-check-circle"></i>
                    <span>Your password has been updated.</span>
                </div>
                <a href="spendnote-login.html" class="btn btn-primary">Go to login</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js?v=20260225-0038"></script>
    <script>
        const formState = document.getElementById('formState');
        const successState = document.getElementById('successState');
        const resetForm = document.getElementById('resetForm');
        const submitBtn = document.getElementById('submitBtn');
        const errorMessage = document.getElementById('errorMessage');

        const setError = (message) => {
            const text = errorMessage.querySelector('span');
            if (text) text.textContent = String(message || 'Something went wrong.');
            errorMessage.classList.add('show');
        };

        const setLoading = (isLoading) => {
            submitBtn.disabled = Boolean(isLoading);
            submitBtn.textContent = isLoading ? 'Updating...' : 'Update password';
        };

        const validatePassword = (password, confirmPassword) => {
            if (window.SpendNotePasswordPolicy) {
                const pv = window.SpendNotePasswordPolicy.validate(password);
                if (!pv.valid) return pv.message;
            } else if (password.length < 8) {
                return 'Password must be at least 8 characters long.';
            }
            if (password !== confirmPassword) return 'Passwords do not match.';
            return '';
        };

        const ensureRecoverySession = async () => {
            errorMessage.classList.remove('show');
            try {
                if (window.__spendnoteAuthCallbackPromise) {
                    await window.__spendnoteAuthCallbackPromise;
                }
                const sessionRes = await window.supabaseClient.auth.getSession();
                const session = sessionRes?.data?.session || null;
                if (!session) {
                    setError('Reset link is invalid or expired. Please request a new one.');
                    resetForm.style.display = 'none';
                }
            } catch (_) {
                setError('Could not validate reset link. Please request a new one.');
                resetForm.style.display = 'none';
            }
        };

        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.classList.remove('show');

            const password = String(document.getElementById('newPassword').value || '');
            const confirmPassword = String(document.getElementById('confirmPassword').value || '');
            const validationError = validatePassword(password, confirmPassword);
            if (validationError) {
                setError(validationError);
                return;
            }

            if (!window.auth?.updatePassword) {
                setError('Password update is temporarily unavailable.');
                return;
            }

            setLoading(true);
            try {
                const result = await window.auth.updatePassword(password);
                if (!result?.success) {
                    setError(result?.error || 'Could not update password.');
                    return;
                }

                try {
                    await window.auth.signOut();
                } catch (_) {
                    // ignore
                }

                formState.classList.add('hide');
                successState.classList.add('show');
            } catch (err) {
                setError(err?.message || 'Could not update password.');
            } finally {
                setLoading(false);
            }
        });

        ensureRecoverySession();
    </script>
</body>
</html>
